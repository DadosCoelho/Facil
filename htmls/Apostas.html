<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facil — Apostas (Admin)</title>
  <meta name="description" content="Administre todas as apostas: filtros avançados, ordenação, ações em massa, exportação CSV, visualização detalhada e atualização de status." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0c10;
      --bg-elev:#111217;
      --bg-elev-2:#151823;
      --txt:#e6e7ee;
      --muted:#a0a4b8;
      --brand:#6ee7b7;
      --brand-2:#22c55e;
      --accent:#60a5fa;
      --warn:#f59e0b;
      --danger:#ef4444;
      --ok:#34d399;
      --border:#1f2430;
      --chip:#1a1e29;
      --success:#16a34a;
      --link:#93c5fd;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:12px;
      --radius-sm:10px;
      --radius-xs:8px;
      --focus: 0 0 0 3px rgba(96,165,250,.35);
      --table-row:#0f1117;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--txt);font:500 16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    img{max-width:100%;display:block}
    .hidden{display:none !important}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--bg-elev);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(1.2) blur(8px);
    }
    .topbar-inner{
      max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px
    }
    .brand{
      display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);border:1px solid var(--border)
    }
    .logo{
      width:24px;height:24px;border-radius:6px;background:radial-gradient(circle at 30% 30%, var(--brand), transparent 60%), radial-gradient(circle at 70% 70%, var(--accent), transparent 55%), #0a0f1a;border:1px solid var(--border)
    }
    .brand h1{font-size:15px;margin:0;font-weight:700;letter-spacing:.3px}
    nav.nav{margin-left:8px;display:flex;gap:4px;flex-wrap:wrap}
    .nav a{
      padding:8px 10px;border:1px solid var(--border);border-radius:10px;color:var(--txt);text-decoration:none;background:var(--bg);
    }
    .nav a.active{background:var(--bg-elev);border-color:var(--accent);box-shadow:inset 0 0 0 1px rgba(96,165,250,.25)}
    .nav a:hover{background:var(--bg-elev)}
    .spacer{flex:1}
    .chip{
      background:var(--chip);border:1px solid var(--border);padding:8px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px;color:var(--muted)
    }
    .chip .dot{width:8px;height:8px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 3px rgba(52,211,153,.18)}
    .user{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:var(--bg)}
    .user .avatar{width:24px;height:24px;border-radius:999px;background:linear-gradient(180deg, #1f2937, #0b1220);border:1px solid var(--border)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--txt);padding:8px 10px;border-radius:10px}
    .btn-ghost:hover{background:var(--bg-elev)}

    /* Shell / layout */
    .shell{max-width:1200px;margin:0 auto;padding:20px 16px 60px}
    .page-head{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h2.title{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px}
    .subtitle{margin:0;color:var(--muted);font-size:14px}
    .quick{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}

    /* Cards and sections */
    .grid{display:grid;gap:14px}
    .grid.cols-4{grid-template-columns:repeat(4, minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3, minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2, minmax(0,1fr))}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--bg-elev);
      border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)
    }
    .card-header{padding:14px 14px 0;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .card-title{margin:0;font-size:16px;font-weight:800}
    .card-sub{margin:0;color:var(--muted);font-size:13px}
    .card-body{padding:12px 14px 14px}
    .kpi{
      padding:14px;border:1px solid var(--border);border-radius:12px;background:var(--bg);
      display:flex;align-items:center;justify-content:space-between;gap:8px
    }
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-weight:800;font-size:18px}
    .kpi .delta.up{color:var(--ok);font-size:12px}
    .kpi .delta.down{color:var(--danger);font-size:12px}

    /* Toolbar / filters */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:12px}
    .input,.select,.date,.number{
      background:var(--bg-elev);border:1px solid var(--border);color:var(--txt);
      padding:10px;border-radius:10px;min-width:0
    }
    .input::placeholder{color:var(--muted)}
    .select{padding-right:28px;appearance:none;background-image:linear-gradient(45deg, transparent 50%, var(--muted) 50%),linear-gradient(135deg, var(--muted) 50%, transparent 50%),linear-gradient(to right, transparent, transparent);background-position:calc(100% - 18px) calc(1em + 2px), calc(100% - 13px) calc(1em + 2px), 100% 0;background-size:5px 5px, 5px 5px, 2.5em 2.5em;background-repeat:no-repeat}
    .btn{border:1px solid var(--border);color:var(--txt);background:var(--bg-elev);padding:10px 12px;border-radius:10px;font-weight:700}
    .btn:hover{background:var(--bg-elev-2)}
    .btn.primary{background:linear-gradient(180deg, rgba(34,197,94,.18), rgba(34,197,94,.05));border-color:rgba(34,197,94,.35)}
    .btn.accent{background:linear-gradient(180deg, rgba(96,165,250,.18), rgba(96,165,250,.05));border-color:rgba(96,165,250,.35)}
    .btn.warn{background:linear-gradient(180deg, rgba(245,158,11,.2), rgba(245,158,11,.06));border-color:rgba(245,158,11,.35)}
    .btn.danger{background:linear-gradient(180deg, rgba(239,68,68,.2), rgba(239,68,68,.06));border-color:rgba(239,68,68,.35)}
    .btn.success{background:linear-gradient(180deg, rgba(52,211,153,.2), rgba(52,211,153,.06));border-color:rgba(52,211,153,.35)}
    .btn.ghost{background:transparent;border:1px dashed var(--border);color:var(--muted)}
    .btn:focus{outline:none;box-shadow:var(--focus)}

    .toolbar-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toolbar .sp{flex:1}

    /* Table */
    .table-wrap{border:1px solid var(--border);border-radius:14px;overflow:auto;background:var(--bg)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      position:sticky;top:0;background:linear-gradient(180deg, var(--bg-elev), var(--bg));border-bottom:1px solid var(--border);color:var(--muted);font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.3px;padding:12px;white-space:nowrap
    }
    tbody td{padding:12px;border-bottom:1px solid var(--border);background:var(--table-row)}
    tbody tr:hover td{background:#0d1220}
    .td-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .checkbox{width:16px;height:16px;border-radius:4px;border:1px solid var(--border);display:inline-block;background:var(--bg-elev);vertical-align:middle}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px}
    .b-pending{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.35);color:#f3c97a}
    .b-paid{background:rgba(34,197,94,.08);border-color:rgba(34,197,94,.35);color:#72e5b3}
    .b-cancel{background:rgba(239,68,68,.08);border-color:rgba(239,68,68,.35);color:#f59f9f}
    .b-refund{background:rgba(14,165,233,.08);border-color:rgba(14,165,233,.35);color:#8ed4fb}
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Pager and selection bar */
    .selection-bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px;background:var(--bg);border:1px solid var(--border);border-radius:12px}
    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
    .pager .info{color:var(--muted);font-size:12px}

    /* Drawer (detalhes) */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none}
    .backdrop.show{display:block}
    .drawer{
      position:fixed;top:0;right:-560px;width:560px;max-width:100%;height:100vh;background:var(--bg-elev);border-left:1px solid var(--border);box-shadow:var(--shadow);transition:right .28s ease;border-top-left-radius:12px;border-bottom-left-radius:12px;display:flex;flex-direction:column
    }
    .drawer.show{right:0}
    .drawer-header{padding:14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .drawer-body{padding:14px;overflow:auto;flex:1;display:grid;gap:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:grid;gap:6px}
    .field label{font-size:12px;color:var(--muted)}
    .field .pill{border:1px solid var(--border);background:var(--bg);padding:10px;border-radius:10px}
    .note{border:1px dashed var(--border);background:var(--bg);padding:10px;border-radius:10px;color:var(--muted);font-size:14px}

    /* Toast */
    .toast{position:fixed;bottom:16px;right:16px;background:var(--bg-elev);border:1px solid var(--border);padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);display:none}
    .toast.show{display:block}

    /* Responsive */
    @media (max-width: 960px){
      .grid.cols-4{grid-template-columns:repeat(2, minmax(0,1fr))}
      .row{grid-template-columns:1fr}
    }
    @media (max-width: 760px){
      .topbar-inner{gap:8px}
      nav.nav{order:3;width:100%}
      .quick{width:100%;order:2}
      .page-head{flex-direction:column;align-items:flex-start}
      .grid.cols-4,.grid.cols-3,.grid.cols-2{grid-template-columns:1fr}
      thead th:nth-child(7), thead th:nth-child(8), thead th:nth-child(9){display:none}
      tbody td:nth-child(7), tbody td:nth-child(8), tbody td:nth-child(9){display:none}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand" title="Facil — Plataforma de apostas">
        <div class="logo" aria-hidden="true"></div>
        <h1>Facil</h1>
      </div>
      <nav class="nav" aria-label="Admin">
        <a href="#/dashboard" aria-label="Dashboard">Dashboard</a>
        <a href="#/campanhas" aria-label="Campanhas">Campanhas</a>
        <a href="#/convites" aria-label="Convites">Convites</a>
        <a href="#/apostas" class="active" aria-current="page" aria-label="Apostas">Apostas</a>
      </nav>
      <div class="spacer"></div>
      <div class="chip" id="envChip" title="Sessão administrativa">
        <span class="dot"></span> Admin
      </div>
      <div class="user" id="userChip">
        <span class="avatar" aria-hidden="true"></span>
        <span class="name">admin@facil.app</span>
        <button class="btn-ghost" id="logoutBtn" title="Sair">Sair</button>
      </div>
    </div>
  </header>

  <main class="shell">
    <section class="page-head">
      <div>
        <h2 class="title">Apostas (Admin)</h2>
        <p class="subtitle">Gerencie apostas: filtros, ordenação, ações em massa, exportação e detalhes.</p>
      </div>
      <div class="quick">
        <button class="btn accent" id="exportCSVTop">Exportar CSV</button>
        <button class="btn ghost" id="seedBtn" title="Repopular dados de exemplo">Seed</button>
      </div>
    </section>

    <section class="grid cols-4" style="margin-top:12px">
      <div class="kpi">
        <div>
          <div class="label">Total de Apostas</div>
          <div class="value" id="kpiTotal">0</div>
        </div>
        <div class="delta up" id="kpiTotalDelta">+0%</div>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Pendentes</div>
          <div class="value" id="kpiPend">0</div>
        </div>
        <div class="delta down" id="kpiPendDelta">0</div>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Pagas</div>
          <div class="value" id="kpiPagas">0</div>
        </div>
        <div class="delta up" id="kpiPagasDelta">+0</div>
      </div>
      <div class="kpi">
        <div>
          <div class="label">Volume (R$)</div>
          <div class="value" id="kpiVolume">0,00</div>
        </div>
        <div class="delta up" id="kpiVolDelta">+0%</div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="card-header">
        <div>
          <h3 class="card-title">Filtros e Busca</h3>
          <p class="card-sub">Refine a lista por campanha, status, datas, valor e mais.</p>
        </div>
      </div>
      <div class="card-body">
        <div class="toolbar">
          <div class="toolbar-row" style="flex:1">
            <input class="input" id="q" placeholder="Buscar por código, usuário, email, palpite..." style="min-width:240px;flex:1" />
            <select class="select" id="fCampaign" style="min-width:180px">
              <option value="">Campanha (todas)</option>
            </select>
            <select class="select" id="fStatus" style="min-width:160px">
              <option value="">Status (todos)</option>
              <option value="pendente">Pendente</option>
              <option value="paga">Paga</option>
              <option value="cancelada">Cancelada</option>
              <option value="reembolsada">Reembolsada</option>
            </select>
            <select class="select" id="fPay" style="min-width:160px">
              <option value="">Pagamento (todos)</option>
              <option value="pix">PIX</option>
              <option value="cartao">Cartão</option>
              <option value="boleto">Boleto</option>
              <option value="saldo">Saldo</option>
            </select>
          </div>
          <div class="toolbar-row">
            <input class="date" id="fFrom" type="date" />
            <input class="date" id="fTo" type="date" />
            <input class="number" id="fMin" type="number" inputmode="decimal" placeholder="Min R$" style="width:120px" />
            <input class="number" id="fMax" type="number" inputmode="decimal" placeholder="Max R$" style="width:120px" />
            <select class="select" id="pageSize" title="Itens por página">
              <option>10</option><option selected>25</option><option>50</option><option>100</option>
            </select>
            <button class="btn" id="clearFilters">Limpar</button>
            <button class="btn primary" id="applyFilters">Aplicar</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="card-header">
        <div>
          <h3 class="card-title">Ações em Massa</h3>
          <p class="card-sub">Selecione linhas para habilitar as ações abaixo.</p>
        </div>
      </div>
      <div class="card-body">
        <div class="selection-bar">
          <div class="badge"><strong id="selCount">0</strong> selecionadas</div>
          <button class="btn success" id="bulkPay" disabled>Marcar como Paga</button>
          <button class="btn warn" id="bulkRefund" disabled>Reembolsar</button>
          <button class="btn danger" id="bulkCancel" disabled>Cancelar</button>
          <button class="btn accent" id="exportCSV" disabled>Exportar CSV (seleção)</button>
          <div class="sp"></div>
          <label style="display:flex;gap:8px;align-items:center;color:var(--muted)">
            <input type="checkbox" id="autoRefresh" />
            Auto-atualizar
          </label>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="card-header">
        <div>
          <h3 class="card-title">Lista de Apostas</h3>
          <p class="card-sub" id="listInfo">Carregando...</p>
        </div>
        <div>
          <button class="btn ghost" id="resetSort">Resetar Ordenação</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table id="betsTable" aria-label="Tabela de apostas">
            <thead>
              <tr>
                <th style="width:36px"><input type="checkbox" id="checkAll" aria-label="Selecionar tudo" /></th>
                <th data-sort="code" class="sortable">Código</th>
                <th data-sort="date" class="sortable">Data</th>
                <th data-sort="user" class="sortable">Usuário</th>
                <th data-sort="campaign" class="sortable">Campanha</th>
                <th>Palpite</th>
                <th data-sort="odds" class="sortable">Odds</th>
                <th data-sort="stake" class="sortable">Valor</th>
                <th data-sort="payout" class="sortable">Potencial</th>
                <th data-sort="status" class="sortable">Status</th>
                <th data-sort="pay" class="sortable">Pagamento</th>
                <th style="width:1%">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="pager">
          <div class="info" id="pagerInfo">0–0 de 0</div>
          <button class="btn" id="prevPage">Anterior</button>
          <button class="btn" id="nextPage">Próxima</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Drawer Detalhes -->
  <div class="backdrop" id="backdrop"></div>
  <aside class="drawer" id="drawer" aria-hidden="true" aria-label="Detalhes da aposta">
    <div class="drawer-header">
      <div>
        <div class="card-title" id="dwTitle">Aposta</div>
        <div class="card-sub" id="dwSub">Detalhes e ações</div>
      </div>
      <div>
        <button class="btn" id="closeDrawer">Fechar</button>
      </div>
    </div>
    <div class="drawer-body">
      <div class="row">
        <div class="field">
          <label>Código</label>
          <div class="pill mono" id="dwCode">—</div>
        </div>
        <div class="field">
          <label>Data</label>
          <div class="pill" id="dwDate">—</div>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Usuário</label>
          <div class="pill" id="dwUser">—</div>
        </div>
        <div class="field">
          <label>Email</label>
          <div class="pill" id="dwEmail">—</div>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Campanha</label>
          <div class="pill" id="dwCampaign">—</div>
        </div>
        <div class="field">
          <label>Pagamento</label>
          <div class="pill" id="dwPayment">—</div>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Palpite</label>
          <div class="pill" id="dwPick">—</div>
        </div>
        <div class="field">
          <label>Odds</label>
          <div class="pill" id="dwOdds">—</div>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Valor (stake)</label>
          <div class="pill" id="dwStake">—</div>
        </div>
        <div class="field">
          <label>Potencial</label>
          <div class="pill" id="dwPayout">—</div>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>Status</label>
          <select class="select" id="dwStatus">
            <option value="pendente">Pendente</option>
            <option value="paga">Paga</option>
            <option value="cancelada">Cancelada</option>
            <option value="reembolsada">Reembolsada</option>
          </select>
        </div>
        <div class="field">
          <label>Atualizar</label>
          <div class="pill" style="display:flex;gap:8px;align-items:center">
            <button class="btn success" id="dwMarkPaid">Marcar paga</button>
            <button class="btn warn" id="dwRefund">Reembolsar</button>
            <button class="btn danger" id="dwCancel">Cancelar</button>
          </div>
        </div>
      </div>
      <div class="field">
        <label>Notas (admin)</label>
        <textarea class="input" id="dwNotes" rows="4" placeholder="Observações internas..."></textarea>
      </div>
      <div class="row">
        <div class="field">
          <label>Ações</label>
          <div class="pill" style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn accent" id="dwSave">Salvar alterações</button>
            <button class="btn" id="dwCopyCode">Copiar código</button>
            <button class="btn ghost" id="dwOpenReceipt">Abrir recibo</button>
          </div>
        </div>
        <div class="field">
          <label>Timeline</label>
          <div class="note" id="dwTimeline">—</div>
        </div>
      </div>
    </div>
  </aside>

  <div class="toast" id="toast">Feito!</div>

  <script>
    (function(){
      const LS_BETS = "facil_bets";
      const LS_CAMPAIGNS = "facil_campaigns";
      const LS_ADMIN_TOKEN = "facil_admin_token";
      const QS_KEY = "facil_admin_bets_filters";
      const STATE = {
        bets: [],
        filtered: [],
        page: { index: 0, size: 25, total: 0 },
        sort: { by: "date", dir: "desc" },
        sel: new Set(),
        filters: { q:"", campaign:"", status:"", pay:"", from:"", to:"", min:"", max:"" },
        autoRefresh: false,
        lastSeed: 0,
        drawer: { id: null }
      };

      // Utilities
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      function fmtMoney(v){
        try{
          return v.toLocaleString("pt-BR", { style:"currency", currency:"BRL", minimumFractionDigits:2 });
        }catch{
          return "R$ " + (Math.round(v*100)/100).toFixed(2).replace(".",",");
        }
      }
      function fmtDate(ts){
        const d = new Date(ts);
        return d.toLocaleString("pt-BR");
      }
      function rnd(min,max){return Math.floor(Math.random()*(max-min+1))+min}
      function id(){return Math.random().toString(36).slice(2,8).toUpperCase()}
      function toast(msg, ms=2200){
        const el = $("#toast"); if(!el) return;
        el.textContent = msg; el.classList.add("show");
        setTimeout(()=> el.classList.remove("show"), ms);
      }

      // Auth gate
      function requireAuth(){
        const token = localStorage.getItem(LS_ADMIN_TOKEN);
        if (!token){
          // Em um app real: redirecionar
          // window.location.href = "/login";
          // Aqui, apenas sem bloqueio, mas indicamos visualmente:
          $("#envChip").title = "Modo demonstração (sem token)";
        }
        return true;
      }

      // Data
      function loadCampaigns(){
        try{
          const arr = JSON.parse(localStorage.getItem(LS_CAMPAIGNS)||"[]");
          return Array.isArray(arr) ? arr : [];
        }catch{ return []; }
      }
      function saveBets(){ localStorage.setItem(LS_BETS, JSON.stringify(STATE.bets)); }
      function loadBets(){
        try{
          const arr = JSON.parse(localStorage.getItem(LS_BETS)||"[]");
          STATE.bets = Array.isArray(arr) ? arr : [];
        }catch{ STATE.bets = []; }
      }
      function seedIfEmpty(){
        loadBets();
        if (STATE.bets.length > 0) return;
        const campaigns = loadCampaigns().length ? loadCampaigns() : [
          { id:"CAMP01", name:"Copa das Estrelas" },
          { id:"CAMP02", name:"Liga Nacional" },
          { id:"CAMP03", name:"Promo PIX Dobrado" }
        ];
        const users = [
          { name:"João Silva", email:"joao@example.com" },
          { name:"Maria Souza", email:"maria@example.com" },
          { name:"Pedro Lima", email:"pedro@example.com" },
          { name:"Ana Paula", email:"ana@example.com" },
          { name:"Bruno Rocha", email:"bruno@example.com" },
        ];
        const pays = ["pix","cartao","boleto","saldo"];
        const statuses = ["pendente","paga","cancelada","reembolsada"];
        const picks = ["Time A vence", "Time B vence", "Empate", "Mais de 2.5 gols", "Ambas marcam", "Handicap -1.5", "Under 3.5", "Cantinhos > 9.5"];

        const now = Date.now();
        const arr = [];
        for (let i=0;i<180;i++){
          const u = users[rnd(0,users.length-1)];
          const c = campaigns[rnd(0,campaigns.length-1)];
          const pay = pays[rnd(0,pays.length-1)];
          const st = statuses[rnd(0,statuses.length-1)];
          const odds = (Math.random()*3 + 1.1).toFixed(2);
          const stake = rnd(10, 1000);
          const payout = Math.round(stake * parseFloat(odds));
          const ts = now - rnd(0, 1000*60*60*24*20);
          arr.push({
            id: id(),
            code: "BET-" + id(),
            ts,
            user: u.name,
            email: u.email,
            campaignId: c.id,
            campaign: c.name,
            pick: picks[rnd(0,picks.length-1)],
            odds: parseFloat(odds),
            stake,
            payout,
            status: st,
            payment: pay,
            notes: "",
            history: [
              { at: ts, ev: "criada" },
              { at: ts + rnd(5*60*1000, 40*60*1000), ev: st === "paga" ? "paga" : st === "cancelada" ? "cancelada" : st === "reembolsada" ? "reembolsada" : "aguardando" }
            ]
          });
        }
        STATE.bets = arr.sort((a,b)=>b.ts-a.ts);
        saveBets();
      }

      // Filters
      function hydrateCampaignFilter(){
        const sel = $("#fCampaign");
        const cs = loadCampaigns();
        for (const c of cs){
          const o = document.createElement("option");
          o.value = c.id; o.textContent = c.name;
          sel.appendChild(o);
        }
      }
      function readFilters(){
        STATE.filters.q = $("#q").value.trim();
        STATE.filters.campaign = $("#fCampaign").value;
        STATE.filters.status = $("#fStatus").value;
        STATE.filters.pay = $("#fPay").value;
        STATE.filters.from = $("#fFrom").value;
        STATE.filters.to = $("#fTo").value;
        STATE.filters.min = $("#fMin").value;
        STATE.filters.max = $("#fMax").value;
        STATE.page.size = parseInt($("#pageSize").value, 10) || 25;
        persistFilters();
      }
      function applyFilters(){
        const f = STATE.filters;
        const q = f.q.toLowerCase();
        let arr = STATE.bets.slice();

        if (q){
          arr = arr.filter(x =>
            (x.code||"").toLowerCase().includes(q) ||
            (x.user||"").toLowerCase().includes(q) ||
            (x.email||"").toLowerCase().includes(q) ||
            (x.pick||"").toLowerCase().includes(q) ||
            (x.campaign||"").toLowerCase().includes(q)
          );
        }
        if (f.campaign) arr = arr.filter(x => x.campaignId === f.campaign);
        if (f.status) arr = arr.filter(x => x.status === f.status);
        if (f.pay) arr = arr.filter(x => x.payment === f.pay);
        if (f.from){
          const fromTs = Date.parse(f.from + "T00:00:00");
          arr = arr.filter(x => x.ts >= fromTs);
        }
        if (f.to){
          const toTs = Date.parse(f.to + "T23:59:59");
          arr = arr.filter(x => x.ts <= toTs);
        }
        if (f.min){
          const v = parseFloat(f.min.replace(",", ".")); if (!isNaN(v)) arr = arr.filter(x => x.stake >= v);
        }
        if (f.max){
          const v = parseFloat(f.max.replace(",", ".")); if (!isNaN(v)) arr = arr.filter(x => x.stake <= v);
        }

        // sort
        const { by, dir } = STATE.sort;
        arr.sort((a,b)=>{
          let va, vb;
          switch(by){
            case "code": va=a.code; vb=b.code; break;
            case "date": va=a.ts; vb=b.ts; break;
            case "user": va=a.user; vb=b.user; break;
            case "campaign": va=a.campaign; vb=b.campaign; break;
            case "odds": va=a.odds; vb=b.odds; break;
            case "stake": va=a.stake; vb=b.stake; break;
            case "payout": va=a.payout; vb=b.payout; break;
            case "status": va=a.status; vb=b.status; break;
            case "pay": va=a.payment; vb=b.payment; break;
            default: va=a.ts; vb=b.ts;
          }
          if (va < vb) return dir === "asc" ? -1 : 1;
          if (va > vb) return dir === "asc" ? 1 : -1;
          return 0;
        });

        STATE.filtered = arr;
        STATE.page.index = 0;
        renderTable();
        updateKPIs();
      }
      function clearFilters(){
        $("#q").value = "";
        $("#fCampaign").value = "";
        $("#fStatus").value = "";
        $("#fPay").value = "";
        $("#fFrom").value = "";
        $("#fTo").value = "";
        $("#fMin").value = "";
        $("#fMax").value = "";
        readFilters();
        applyFilters();
      }
      function persistFilters(){
        const obj = {
          f: STATE.filters,
          s: STATE.sort,
          pz: STATE.page.size
        };
        localStorage.setItem(QS_KEY, JSON.stringify(obj));
      }
      function restoreFilters(){
        const raw = localStorage.getItem(QS_KEY);
        if (!raw) return;
        try{
          const obj = JSON.parse(raw);
          if (obj.f){
            STATE.filters = obj.f;
            $("#q").value = obj.f.q || "";
            $("#fCampaign").value = obj.f.campaign || "";
            $("#fStatus").value = obj.f.status || "";
            $("#fPay").value = obj.f.pay || "";
            $("#fFrom").value = obj.f.from || "";
            $("#fTo").value = obj.f.to || "";
            $("#fMin").value = obj.f.min || "";
            $("#fMax").value = obj.f.max || "";
          }
          if (obj.s){ STATE.sort = obj.s; }
          if (obj.pz){ STATE.page.size = obj.pz; $("#pageSize").value = String(obj.pz); }
        }catch{}
      }

      // KPIs
      function updateKPIs(){
        const arr = STATE.filtered;
        $("#kpiTotal").textContent = String(arr.length);
        $("#kpiPend").textContent = String(arr.filter(x=>x.status==="pendente").length);
        $("#kpiPagas").textContent = String(arr.filter(x=>x.status==="paga").length);
        const vol = arr.reduce((acc,x)=> acc + (x.stake||0), 0);
        $("#kpiVolume").textContent = fmtMoney(vol);
        $("#kpiTotalDelta").textContent = "+" + Math.min(100, Math.round((arr.length / Math.max(1, STATE.bets.length))*100)) + "%";
        $("#kpiVolDelta").textContent = "+" + (arr.length ? "12%" : "0%");
        $("#kpiPendDelta").textContent = arr.length ? (arr.filter(x=>x.status==="pendente").length ? "+1" : "0") : "0";
        $("#kpiPagasDelta").textContent = arr.length ? "+" + rnd(0,4) : "+0";
      }

      // Rendering
      function statusBadge(st){
        const map = {
          pendente: { cls:"b-pending", txt:"Pendente" },
          paga: { cls:"b-paid", txt:"Paga" },
          cancelada: { cls:"b-cancel", txt:"Cancelada" },
          reembolsada: { cls:"b-refund", txt:"Reembolsada" },
        };
        const m = map[st] || map.pendente;
        return `<span class="badge ${m.cls}">${m.txt}</span>`;
      }
      function payLabel(p){ return p ? p.toUpperCase() : "—"; }
      function renderTable(){
        // selection state
        const tbody = $("#tbody");
        tbody.innerHTML = "";
        const start = STATE.page.index * STATE.page.size;
        const end = Math.min(start + STATE.page.size, STATE.filtered.length);
        STATE.page.total = Math.ceil(STATE.filtered.length / STATE.page.size) || 1;
        $("#pagerInfo").textContent = `${STATE.filtered.length ? start+1 : 0}–${end} de ${STATE.filtered.length}`;
        $("#listInfo").textContent = `${STATE.filtered.length} resultado(s) • Ordenado por ${STATE.sort.by} (${STATE.sort.dir})`;

        for (let i = start; i < end; i++){
          const x = STATE.filtered[i];
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="checkbox" data-id="${x.id}" class="rowCheck" ${STATE.sel.has(x.id) ? "checked" : ""} /></td>
            <td class="mono">${x.code}</td>
            <td>${fmtDate(x.ts)}</td>
            <td>
              <div style="display:flex;flex-direction:column">
                <strong>${x.user}</strong>
                <span class="mono" style="color:var(--muted);font-size:12px">${x.email}</span>
              </div>
            </td>
            <td>${x.campaign}</td>
            <td>${x.pick}</td>
            <td class="mono">${x.odds.toFixed(2)}</td>
            <td class="mono">${fmtMoney(x.stake)}</td>
            <td class="mono">${fmtMoney(x.payout)}</td>
            <td>${statusBadge(x.status)}</td>
            <td><span class="badge">${payLabel(x.payment)}</span></td>
            <td class="td-actions">
              <button class="btn" data-act="open" data-id="${x.id}">Ver</button>
              <button class="btn success" data-act="pay" data-id="${x.id}" title="Marcar paga">Pagar</button>
              <button class="btn warn" data-act="refund" data-id="${x.id}" title="Reembolsar">Reemb.</button>
              <button class="btn danger" data-act="cancel" data-id="${x.id}" title="Cancelar">Canc.</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        // selection header checkbox
        const checkedAll = STATE.filtered.length && STATE.filtered.slice(start,end).every(r => STATE.sel.has(r.id));
        $("#checkAll").checked = !!checkedAll;
        updateSelBar();
      }

      function updateSelBar(){
        $("#selCount").textContent = String(STATE.sel.size);
        const disabled = STATE.sel.size === 0;
        $("#bulkPay").disabled = disabled;
        $("#bulkRefund").disabled = disabled;
        $("#bulkCancel").disabled = disabled;
        $("#exportCSV").disabled = disabled;
      }

      // Sorting
      function bindSorting(){
        $$("#betsTable thead th.sortable").forEach(th=>{
          th.style.cursor = "pointer";
          th.addEventListener("click", ()=>{
            const by = th.getAttribute("data-sort");
            if (STATE.sort.by === by){
              STATE.sort.dir = STATE.sort.dir === "asc" ? "desc" : "asc";
            } else {
              STATE.sort.by = by; STATE.sort.dir = "asc";
            }
            persistFilters();
            applyFilters();
          });
        });
        $("#resetSort").addEventListener("click", ()=>{
          STATE.sort = { by:"date", dir:"desc" };
          persistFilters();
          applyFilters();
        });
      }

      // Table interactions
      function bindTableEvents(){
        $("#tbody").addEventListener("click", (ev)=>{
          const btn = ev.target.closest("button");
          if (btn && btn.dataset.act){
            const id = btn.dataset.id;
            switch(btn.dataset.act){
              case "open": openDrawer(id); break;
              case "pay": updateStatus(id, "paga"); break;
              case "refund": updateStatus(id, "reembolsada"); break;
              case "cancel": updateStatus(id, "cancelada"); break;
            }
          }
          const cb = ev.target.closest(".rowCheck");
          if (cb){
            const id = cb.dataset.id;
            if (cb.checked) STATE.sel.add(id);
            else STATE.sel.delete(id);
            updateSelBar();
          }
        });
        $("#checkAll").addEventListener("change", (ev)=>{
          const checked = ev.target.checked;
          const start = STATE.page.index * STATE.page.size;
          const end = Math.min(start + STATE.page.size, STATE.filtered.length);
          for (let i = start; i < end; i++){
            const id = STATE.filtered[i].id;
            if (checked) STATE.sel.add(id); else STATE.sel.delete(id);
          }
          renderTable();
        });
      }

      // Bulk actions
      function getSelected(){ return STATE.bets.filter(x => STATE.sel.has(x.id)); }
      function bulkSetStatus(status){
        const sel = getSelected();
        if (!sel.length){ toast("Nenhuma seleção."); return; }
        for (const r of sel){
          r.status = status;
          r.history.push({ at: Date.now(), ev: status });
        }
        saveBets();
        toast(`Atualizadas ${sel.length} aposta(s) para "${status}".`);
        applyFilters();
      }
      function exportCSVRows(rows){
        const cols = ["code","data","usuario","email","campanha","palpite","odds","valor","potencial","status","pagamento"];
        const header = cols.join(";");
        const lines = rows.map(x=>{
          const arr = [
            x.code,
            new Date(x.ts).toISOString(),
            x.user,
            x.email,
            x.campaign,
            x.pick,
            x.odds.toFixed(2),
            x.stake,
            x.payout,
            x.status,
            x.payment
          ];
          return arr.map(v=>{
            if (typeof v === "string"){
              const s = v.replaceAll('"','""');
              return `"${s}"`;
            }
            return String(v);
          }).join(";");
        });
        const csv = [header, ...lines].join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "apostas.csv";
        a.click();
        URL.revokeObjectURL(a.href);
      }

      // Drawer
      function openDrawer(id){
        const r = STATE.bets.find(b => b.id === id);
        if (!r) return;
        STATE.drawer.id = id;
        $("#dwTitle").textContent = r.code + " — " + r.user;
        $("#dwSub").textContent = r.campaign;
        $("#dwCode").textContent = r.code;
        $("#dwDate").textContent = fmtDate(r.ts);
        $("#dwUser").textContent = r.user;
        $("#dwEmail").textContent = r.email;
        $("#dwCampaign").textContent = r.campaign;
        $("#dwPayment").textContent = r.payment.toUpperCase();
        $("#dwPick").textContent = r.pick;
        $("#dwOdds").textContent = r.odds.toFixed(2);
        $("#dwStake").textContent = fmtMoney(r.stake);
        $("#dwPayout").textContent = fmtMoney(r.payout);
        $("#dwStatus").value = r.status;
        $("#dwNotes").value = r.notes || "";
        $("#dwTimeline").innerHTML = r.history
          .sort((a,b)=>a.at-b.at)
          .map(h => `<div><span class="mono" style="color:var(--muted)">${new Date(h.at).toLocaleString("pt-BR")}</span> — ${h.ev}</div>`).join("");
        $("#backdrop").classList.add("show");
        $("#drawer").classList.add("show");
        $("#drawer").setAttribute("aria-hidden","false");
      }
      function closeDrawer(){
        $("#backdrop").classList.remove("show");
        $("#drawer").classList.remove("show");
        $("#drawer").setAttribute("aria-hidden","true");
        STATE.drawer.id = null;
      }
      function saveDrawer(){
        const id = STATE.drawer.id; if (!id) return;
        const r = STATE.bets.find(b => b.id === id); if (!r) return;
        const st = $("#dwStatus").value;
        const notes = $("#dwNotes").value;
        if (st !== r.status){
          r.status = st;
          r.history.push({ at: Date.now(), ev: st });
        }
        r.notes = notes;
        saveBets();
        toast("Aposta atualizada.");
        applyFilters();
      }
      function updateStatus(id, status){
        const r = STATE.bets.find(b => b.id === id);
        if (!r) return;
        r.status = status;
        r.history.push({ at: Date.now(), ev: status });
        saveBets();
        toast(`Aposta ${r.code} marcada como "${status}".`);
        applyFilters();
      }

      // Paging
      function nextPage(){
        if ((STATE.page.index+1) >= STATE.page.total) return;
        STATE.page.index++;
        renderTable();
      }
      function prevPage(){
        if (STATE.page.index <= 0) return;
        STATE.page.index--;
        renderTable();
      }

      // Events
      function bindUI(){
        hydrateCampaignFilter();
        restoreFilters();

        $("#applyFilters").addEventListener("click", ()=>{ readFilters(); applyFilters(); });
        $("#clearFilters").addEventListener("click", clearFilters);
        $("#pageSize").addEventListener("change", ()=>{ readFilters(); applyFilters(); });

        let to;
        $("#q").addEventListener("input", ()=>{ clearTimeout(to); to = setTimeout(()=>{ readFilters(); applyFilters(); }, 250); });

        ["fCampaign","fStatus","fPay","fFrom","fTo","fMin","fMax"].forEach(id=>{
          const el = document.getElementById(id);
          el.addEventListener("change", ()=>{ readFilters(); applyFilters(); });
        });

        $("#prevPage").addEventListener("click", prevPage);
        $("#nextPage").addEventListener("click", nextPage);

        bindSorting();
        bindTableEvents();

        $("#bulkPay").addEventListener("click", ()=> bulkSetStatus("paga"));
        $("#bulkRefund").addEventListener("click", ()=> bulkSetStatus("reembolsada"));
        $("#bulkCancel").addEventListener("click", ()=> bulkSetStatus("cancelada"));
        $("#exportCSV").addEventListener("click", ()=> exportCSVRows(getSelected()));
        $("#exportCSVTop").addEventListener("click", ()=> exportCSVRows(STATE.filtered));

        $("#seedBtn").addEventListener("click", ()=>{ STATE.bets = []; saveBets(); seedIfEmpty(); applyFilters(); toast("Dados de exemplo regenerados."); });

        // Drawer controls
        $("#closeDrawer").addEventListener("click", closeDrawer);
        $("#backdrop").addEventListener("click", closeDrawer);
        $("#dwSave").addEventListener("click", saveDrawer);
        $("#dwMarkPaid").addEventListener("click", ()=>{ if(!STATE.drawer.id) return; updateStatus(STATE.drawer.id,"paga"); openDrawer(STATE.drawer.id); });
        $("#dwRefund").addEventListener("click", ()=>{ if(!STATE.drawer.id) return; updateStatus(STATE.drawer.id,"reembolsada"); openDrawer(STATE.drawer.id); });
        $("#dwCancel").addEventListener("click", ()=>{ if(!STATE.drawer.id) return; updateStatus(STATE.drawer.id,"cancelada"); openDrawer(STATE.drawer.id); });
        $("#dwCopyCode").addEventListener("click", async ()=>{
          const t = $("#dwCode").textContent; try{ await navigator.clipboard.writeText(t); toast("Código copiado."); }catch{ toast("Não foi possível copiar."); }
        });
        $("#dwOpenReceipt").addEventListener("click", ()=>{
          const id = STATE.drawer.id;
          const r = STATE.bets.find(b=>b.id===id);
          if (!r) return;
          // Página de recibo (exemplo/placeholder)
          const url = new URL(window.location.href);
          url.hash = "#/recibo/" + r.code;
          window.open(url.toString(), "_blank");
        });

        $("#logoutBtn").addEventListener("click", ()=>{
          localStorage.removeItem(LS_ADMIN_TOKEN);
          toast("Sessão encerrada.");
        });

        $("#autoRefresh").addEventListener("change", (e)=>{
          STATE.autoRefresh = e.target.checked;
        });
      }

      // Auto refresh demo
      setInterval(()=>{
        if (!STATE.autoRefresh) return;
        // Simula atualização: 5% de chance de mudar status de uma pendente
        const pend = STATE.bets.filter(x=>x.status==="pendente");
        if (!pend.length) return;
        if (Math.random() < 0.05){
          const r = pend[rnd(0,pend.length-1)];
          const newSt = Math.random() < 0.7 ? "paga" : "cancelada";
          r.status = newSt; r.history.push({ at: Date.now(), ev:newSt });
          saveBets();
          applyFilters();
          toast(`Atualização automática: ${r.code} → ${newSt}`);
        }
      }, 4000);

      // Init
      function init(){
        requireAuth();
        bindUI();
        seedIfEmpty();
        readFilters();
        applyFilters();
      }
      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>