<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facil — Convites (Gerar e Gerenciar)</title>
  <meta name="description" content="Gerencie convites da Facil: gerar link/código, pausar/reativar, revogar, limites de uso, validade, notas e exportação CSV." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0c10;
      --bg-elev:#111217;
      --bg-elev-2:#151826;
      --text:#e6e8ee;
      --muted:#9aa0ad;
      --muted-2:#7e8594;
      --line:#222536;
      --brand:#6ee7b7; /* green mint */
      --brand-2:#22d3ee; /* cyan */
      --accent:#a78bfa; /* violet */
      --success:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --focus: 0 0 0 3px rgba(34,211,238,.25), 0 0 0 6px rgba(110,231,183,.15);
      --radius:12px;
      --radius-sm:10px;
      --shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Ubuntu,"Helvetica Neue",Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 700px at 80% -20%, rgba(167,139,250,.08), transparent 60%),
                  radial-gradient(1200px 900px at 0% 120%, rgba(34,211,238,.06), transparent 60%),
                  var(--bg);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Shell */
    .shell{max-width:1100px;margin:0 auto;padding:20px 20px 64px}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;margin:6px 0 18px;padding:10px 12px;border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      position:sticky;top:8px;backdrop-filter:saturate(1.2) blur(8px);z-index:10;
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:var(--text)}
    .brand .logo{
      width:36px;height:36px;border-radius:10px;background:
        conic-gradient(from 210deg, var(--brand), var(--brand-2), var(--accent), var(--brand));
      box-shadow:0 6px 16px rgba(34,211,238,.25), inset 0 0 20px rgba(255,255,255,.15);
      position:relative;overflow:hidden;
    }
    .brand .logo::after{
      content:"";position:absolute;inset:1px;border-radius:9px;background:
        radial-gradient(180px 120px at 30% 20%, rgba(255,255,255,.16), transparent),
        radial-gradient(100px 60px at 70% 120%, rgba(255,255,255,.08), transparent),
        rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.06);
    }
    .brand .title{font-weight:700;letter-spacing:.2px}
    .nav{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap
    }
    .nav a{
      color:var(--muted);text-decoration:none;padding:8px 10px;border-radius:10px;border:1px solid transparent;
    }
    .nav a.active{color:var(--text);border-color:var(--line);background:rgba(255,255,255,.03)}
    .chip{
      font-size:.85rem;color:var(--text);background:rgba(255,255,255,.04);border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;display:inline-flex;align-items:center;gap:8px
    }
    .chip .dot{width:8px;height:8px;border-radius:50%;background:var(--brand)}
    .chip.warn .dot{background:var(--warn)}
    .chip.danger .dot{background:var(--danger)}
    .top-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}

    /* Toolbar */
    .toolbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      margin:8px 0 16px;
    }
    .toolbar .left,.toolbar .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input,.select{
      background:var(--bg-elev);color:var(--text);border:1px solid var(--line);
      border-radius:12px;padding:10px 12px;outline:none;min-width:0;
    }
    .input:focus,.select:focus{box-shadow:var(--focus);border-color:#2a2f46}
    .btn{
      appearance:none;border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
      box-shadow:var(--shadow);transition:transform .06s ease, filter .2s ease;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px) scale(.995)}
    .btn.primary{border-color:rgba(110,231,183,.4);background:linear-gradient(180deg, rgba(110,231,183,.18), rgba(110,231,183,.06));color:#0a1b13}
    .btn.ghost{background:transparent}
    .btn.danger{border-color:rgba(239,68,68,.4);background:linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.06))}
    .btn.warn{border-color:rgba(245,158,11,.4);background:linear-gradient(180deg, rgba(245,158,11,.18), rgba(245,158,11,.06))}
    .btn.icon{padding:10px}

    .divider{height:1px;background:var(--line);margin:8px 0 16px;border-radius:1px}

    /* Card + table */
    .card{
      border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border-radius:var(--radius);box-shadow:var(--shadow);
    }
    .card .card-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 14px;border-bottom:1px solid var(--line)}
    .card .card-body{padding:8px 14px}
    .meta{display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:.9rem}

    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      text-align:left;font-weight:600;color:var(--muted);padding:10px;border-bottom:1px solid var(--line);
      position:sticky;top:0;background:linear-gradient(180deg, rgba(11,12,16,1), rgba(11,12,16,.94));
      backdrop-filter:blur(6px);z-index:1;cursor:pointer;user-select:none;
    }
    tbody td{padding:10px;border-bottom:1px solid #191c2a;vertical-align:top}
    tbody tr:hover{background:rgba(255,255,255,.02)}
    .status{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:.85rem}
    .status .dot{width:8px;height:8px;border-radius:50%}
    .status.ativo .dot{background:var(--success)}
    .status.pausado .dot{background:var(--warn)}
    .status.revogado .dot{background:var(--danger)}
    .status.expirado .dot{background:#8891a7}
    .status.esgotado .dot{background:#6b7280}

    .tags{display:flex;gap:6px;flex-wrap:wrap}
    .tag{font-size:.78rem;color:var(--muted);background:rgba(255,255,255,.04);border:1px solid var(--line);padding:4px 8px;border-radius:999px}

    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .row-actions .btn{padding:6px 8px;border-radius:10px}

    /* Empty state */
    .empty{
      text-align:center;padding:48px 12px;color:var(--muted)
    }

    /* Footer/pagination */
    .footerbar{
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;padding:10px 14px;border-top:1px solid var(--line);
      color:var(--muted)
    }
    .pager{display:flex;gap:6px;align-items:center}
    .pager .btn{padding:6px 10px;border-radius:10px}

    /* Dialog */
    dialog{
      border:1px solid var(--line);border-radius:16px;padding:0;background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      color:var(--text);box-shadow:0 20px 60px rgba(0,0,0,.6);
      width:min(720px, calc(100% - 20px));
    }
    dialog::backdrop{background:rgba(0,0,0,.5);backdrop-filter:blur(2px)}
    .dlg-head{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
    .dlg-body{padding:14px;display:grid;gap:10px}
    .dlg-foot{padding:12px 14px;border-top:1px solid var(--line);display:flex;justify-content:flex-end;gap:8px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label.small{font-size:.85rem;color:var(--muted);display:block;margin:4px 0 6px}
    .help{font-size:.85rem;color:var(--muted)}
    .monospace{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Courier New",monospace}

    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{appearance:none;width:40px;height:24px;border-radius:999px;background:#2a2f46;position:relative;outline:none;border:1px solid var(--line);cursor:pointer}
    .switch input::after{content:"";position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:3px;transition:left .15s ease}
    .switch input:checked{background:#234036;border-color:rgba(110,231,183,.45)}
    .switch input:checked::after{left:19px}

    /* Responsive table -> cards */
    @media (max-width: 860px){
      thead{display:none}
      table,tbody,tr,td{display:block;width:100%}
      tbody tr{border-bottom:1px solid var(--line);padding:8px 0}
      tbody td{border:0;padding:6px 0}
      tbody td[data-label]::before{content:attr(data-label) ": ";color:var(--muted);font-weight:600}
      .row-actions{justify-content:flex-start}
      .grid-3{grid-template-columns:1fr}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="topbar" role="banner">
      <a class="brand" href="#" aria-label="Início Facil">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="title">Facil</div>
          <div style="font-size:.82rem;color:var(--muted)">Convites — Gerar e Gerenciar</div>
        </div>
      </a>
      <nav class="nav" aria-label="Admin">
        <a href="./dashboard.html">Dashboard</a>
        <a href="./campanhas.html">Campanhas</a>
        <a class="active" href="#" aria-current="page">Convites</a>
        <a href="./config.html">Config</a>
      </nav>
      <div class="top-actions">
        <span class="chip" id="envChip" title="Sessão autenticada"><span class="dot"></span> Admin</span>
        <button class="btn ghost" id="btnLogout" aria-label="Sair">Sair</button>
      </div>
    </header>

    <section class="toolbar" role="region" aria-label="Ferramentas">
      <div class="left">
        <div style="position:relative">
          <input id="q" class="input" type="search" placeholder="Buscar por código, link ou nota…" aria-label="Buscar convites" />
        </div>
        <select id="fStatus" class="select" aria-label="Filtrar por status">
          <option value="">Todos os status</option>
          <option value="ativo">Ativos</option>
          <option value="pausado">Pausados</option>
          <option value="expirado">Expirados</option>
          <option value="esgotado">Esgotados</option>
          <option value="revogado">Revogados</option>
        </select>
        <select id="fCampaign" class="select" aria-label="Filtrar por campanha">
          <option value="">Todas as campanhas</option>
        </select>
        <input id="fFrom" class="input" type="date" aria-label="Data inicial" />
        <input id="fTo" class="input" type="date" aria-label="Data final" />
        <button class="btn ghost" id="btnClearFilters">Limpar filtros</button>
      </div>
      <div class="right">
        <button class="btn" id="btnSelectAll"><span aria-hidden="true">✓</span> Selecionar</button>
        <button class="btn warn" id="btnPauseSel">Pausar</button>
        <button class="btn" id="btnResumeSel">Reativar</button>
        <button class="btn danger" id="btnRevokeSel">Revogar</button>
        <button class="btn" id="btnExport">Exportar CSV</button>
        <button class="btn primary" id="btnNew"><span aria-hidden="true">＋</span> Novo convite</button>
        <button class="btn" id="btnBatch">Gerar em lote</button>
      </div>
    </section>

    <div class="card" role="region" aria-label="Lista de convites">
      <div class="card-head">
        <div class="meta">
          <span>Total: <strong id="metaTotal">0</strong></span>
          <span>Selecionados: <strong id="metaSel">0</strong></span>
          <span>Filtrados: <strong id="metaFiltered">0</strong></span>
        </div>
        <div class="meta">
          <span class="chip"><span class="dot"></span> Em uso</span>
          <span class="chip warn"><span class="dot"></span> Perto de expirar</span>
          <span class="chip danger"><span class="dot"></span> Atenção</span>
        </div>
      </div>
      <div class="card-body" style="padding:0">
        <div id="empty" class="empty" hidden>
          <div style="font-size:1.1rem;margin-bottom:8px">Nenhum convite encontrado</div>
          <div class="help">Ajuste os filtros ou gere um novo convite.</div>
        </div>
        <div style="overflow:auto">
          <table aria-label="Convites">
            <thead>
              <tr>
                <th style="width:36px"><input id="chkAll" type="checkbox" aria-label="Selecionar tudo"/></th>
                <th data-sort="code">Código</th>
                <th data-sort="url">Link</th>
                <th data-sort="status">Status</th>
                <th data-sort="usage">Usos</th>
                <th data-sort="limit">Limite</th>
                <th data-sort="expiresAt">Expira</th>
                <th data-sort="createdAt">Criado</th>
                <th>Notas/Tags</th>
                <th style="min-width:260px">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="footerbar">
          <div class="help" id="metaText">—</div>
          <div class="pager">
            <button class="btn" id="pgFirst" aria-label="Primeira página">«</button>
            <button class="btn" id="pgPrev" aria-label="Página anterior">‹</button>
            <span class="help">Página <strong id="pgCur">1</strong> de <strong id="pgTotal">1</strong></span>
            <button class="btn" id="pgNext" aria-label="Próxima página">›</button>
            <button class="btn" id="pgLast" aria-label="Última página">»</button>
            <select id="pgSize" class="select" aria-label="Itens por página">
              <option>10</option>
              <option>25</option>
              <option>50</option>
              <option>100</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Dialog: Novo -->
    <dialog id="dlgNew" aria-label="Novo convite">
      <form method="dialog">
        <div class="dlg-head">
          <strong>Novo convite</strong>
          <button class="btn icon" value="cancel" aria-label="Fechar">✕</button>
        </div>
        <div class="dlg-body">
          <div class="grid-3">
            <div>
              <label class="small" for="nLimit">Limite de uso</label>
              <input id="nLimit" class="input" type="number" min="1" step="1" value="1" />
              <div class="help">Quantidade máxima de utilizações.</div>
            </div>
            <div>
              <label class="small" for="nExpires">Expira em (opcional)</label>
              <input id="nExpires" class="input" type="datetime-local" />
              <div class="help">Deixe vazio para não expirar.</div>
            </div>
            <div>
              <label class="small" for="nCampaign">Campanha (opcional)</label>
              <select id="nCampaign" class="select"></select>
            </div>
          </div>
          <div>
            <label class="small" for="nPrefix">Prefixo do código (opcional)</label>
            <input id="nPrefix" class="input monospace" type="text" placeholder="EX.: VIP" maxlength="12" />
          </div>
          <div>
            <label class="small" for="nNote">Nota (opcional)</label>
            <input id="nNote" class="input" type="text" placeholder="Ex.: Influenciador João - Instagram" />
          </div>
          <div class="switch">
            <input id="nPaused" type="checkbox" />
            <label for="nPaused">Criar como pausado</label>
          </div>
          <div id="nPreview" class="help monospace">Prévia: —</div>
        </div>
        <div class="dlg-foot">
          <button class="btn" value="cancel">Cancelar</button>
          <button id="nSubmit" class="btn primary" value="default">Gerar convite</button>
        </div>
      </form>
    </dialog>

    <!-- Dialog: Lote -->
    <dialog id="dlgBatch" aria-label="Gerar em lote">
      <form method="dialog">
        <div class="dlg-head">
          <strong>Gerar convites em lote</strong>
          <button class="btn icon" value="cancel" aria-label="Fechar">✕</button>
        </div>
        <div class="dlg-body">
          <div class="grid-3">
            <div>
              <label class="small" for="bQty">Quantidade</label>
              <input id="bQty" class="input" type="number" min="1" max="1000" step="1" value="10" />
            </div>
            <div>
              <label class="small" for="bLimit">Limite de uso</label>
              <input id="bLimit" class="input" type="number" min="1" step="1" value="1" />
            </div>
            <div>
              <label class="small" for="bCampaign">Campanha (opcional)</label>
              <select id="bCampaign" class="select"></select>
            </div>
          </div>
          <div class="grid-2">
            <div>
              <label class="small" for="bExpires">Expira em (opcional)</label>
              <input id="bExpires" class="input" type="datetime-local" />
            </div>
            <div>
              <label class="small" for="bPrefix">Prefixo (opcional)</label>
              <input id="bPrefix" class="input monospace" type="text" placeholder="EX.: CAMP-SET" maxlength="12" />
            </div>
          </div>
          <div>
            <label class="small" for="bNoteTmpl">Nota (template, opcional)</label>
            <input id="bNoteTmpl" class="input" type="text" placeholder="Ex.: Influ Ads Set/25 — #{n}" />
            <div class="help">Use #{n} para o número sequencial.</div>
          </div>
          <div class="switch">
            <input id="bPaused" type="checkbox" />
            <label for="bPaused">Criar como pausados</label>
          </div>
          <div id="bSummary" class="help">Serão criados 10 convites.</div>
        </div>
        <div class="dlg-foot">
          <button class="btn" value="cancel">Cancelar</button>
          <button id="bSubmit" class="btn primary" value="default">Gerar</button>
        </div>
      </form>
    </dialog>

    <!-- Dialog: Editar -->
    <dialog id="dlgEdit" aria-label="Editar convite">
      <form method="dialog">
        <div class="dlg-head">
          <strong>Editar convite</strong>
          <button class="btn icon" value="cancel" aria-label="Fechar">✕</button>
        </div>
        <div class="dlg-body">
          <div class="grid-3">
            <div>
              <label class="small" for="eLimit">Limite de uso</label>
              <input id="eLimit" class="input" type="number" min="1" step="1" />
            </div>
            <div>
              <label class="small" for="eExpires">Expira em</label>
              <input id="eExpires" class="input" type="datetime-local" />
            </div>
            <div>
              <label class="small" for="eCampaign">Campanha</label>
              <select id="eCampaign" class="select"></select>
            </div>
          </div>
          <div>
            <label class="small" for="eNote">Nota</label>
            <input id="eNote" class="input" type="text" />
          </div>
          <div>
            <label class="small" for="eTags">Tags (separadas por vírgula)</label>
            <input id="eTags" class="input" type="text" />
          </div>
          <div class="switch">
            <input id="ePaused" type="checkbox" />
            <label for="ePaused">Pausado</label>
          </div>
          <div class="help monospace" id="eCode">—</div>
        </div>
        <div class="dlg-foot">
          <button class="btn" value="cancel">Cancelar</button>
          <button id="eSubmit" class="btn primary" value="default">Salvar</button>
        </div>
      </form>
    </dialog>

    <!-- Dialog: Compartilhar/QR -->
    <dialog id="dlgShare" aria-label="Compartilhar convite">
      <form method="dialog">
        <div class="dlg-head">
          <strong>Compartilhar convite</strong>
          <button class="btn icon" value="cancel" aria-label="Fechar">✕</button>
        </div>
        <div class="dlg-body">
          <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap">
            <div>
              <img id="qrImg" width="160" height="160" alt="QR do convite" style="border:1px solid var(--line);border-radius:12px;background:#fff"/>
            </div>
            <div style="flex:1;min-width:240px">
              <label class="small">Link</label>
              <input id="sLink" class="input monospace" type="text" readonly />
              <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
                <button class="btn" id="sCopy">Copiar link</button>
                <button class="btn" id="sOpen">Abrir</button>
                <button class="btn" id="sShare">Compartilhar…</button>
                <a id="sDownloadQR" class="btn" download="convite-qr.png">Baixar QR</a>
              </div>
              <div class="help" id="sMeta">—</div>
            </div>
          </div>
        </div>
        <div class="dlg-foot">
          <button class="btn" value="cancel">Fechar</button>
        </div>
      </form>
    </dialog>

    <!-- Toast -->
    <div id="toasts" style="position:fixed;right:12px;bottom:12px;display:grid;gap:8px;z-index:99"></div>
  </div>

  <script>
    (function(){
      "use strict";

      // Helpers
      const $ = (s, el=document) => el.querySelector(s);
      const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
      const sleep = ms => new Promise(r=>setTimeout(r, ms));

      const KEYS = {
        invites: "facil_invites",
        campaigns: "facil_campaigns",
        auth: "facil_auth"
      };

      const STATE = {
        invites: [],
        selection: new Set(),
        sort: { by: "createdAt", dir: "desc" },
        filters: { q:"", status:"", campaign:"", from:"", to:"" },
        page: { size: 10, index: 0 },
        cachedFiltered: []
      };

      function now(){ return Date.now(); }
      function toISOLike(ts){
        const d = new Date(ts);
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const da = String(d.getDate()).padStart(2,"0");
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        return `${y}-${m}-${da}T${hh}:${mm}`;
      }
      function fmtDate(ts){
        if (!ts) return "—";
        const d = new Date(ts);
        const dd = String(d.getDate()).padStart(2,"0");
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const yyyy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2,"0");
        const mi = String(d.getMinutes()).padStart(2,"0");
        return `${dd}/${mm}/${yyyy} ${hh}:${mi}`;
      }

      function baseInviteUrl(){
        // Link público padrão usando parâmetro ?invite=
        return location.origin + "/?invite=";
      }

      function randomCodePart(n=4){
        return Math.random().toString(36).slice(2, 2+n).toUpperCase().padEnd(n, "X");
      }
      function genCode(prefix=""){
        const parts = [randomCodePart(4), randomCodePart(4), randomCodePart(4)];
        const code = (prefix ? (prefix.toUpperCase().replace(/[^A-Z0-9]/g,"") + "-") : "") + parts.join("-");
        return code;
      }

      function loadInvites(){
        try{
          const raw = localStorage.getItem(KEYS.invites);
          if (!raw) return [];
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) return [];
          return arr;
        }catch(e){ return []; }
      }
      function saveInvites(){
        localStorage.setItem(KEYS.invites, JSON.stringify(STATE.invites));
      }

      function loadCampaigns(){
        try{
          const raw = localStorage.getItem(KEYS.campaigns);
          const arr = raw ? JSON.parse(raw) : [];
          if (Array.isArray(arr)) return arr;
        }catch {}
        return [];
      }

      function seedIfEmpty(){
        if (STATE.invites.length) return;
        const nowTs = now();
        const sample = [];
        for (let i=1;i<=6;i++){
          const code = genCode(i<=2 ? "VIP" : "");
          const created = nowTs - i*86400000;
          const expiresAt = i%3===0 ? nowTs + (i*86400000) : (i%4===0 ? nowTs - 3600000 : null);
          sample.push({
            id: crypto.randomUUID(),
            code,
            url: baseInviteUrl()+encodeURIComponent(code),
            status: i===5 ? "revogado" : (i%4===0 ? "pausado" : "ativo"),
            usageLimit: i%2===0 ? 3 : 1,
            usageCount: i%2===0 ? (i%3) : 0,
            createdAt: created,
            expiresAt,
            note: i===1 ? "Influ João - IG" : (i===2 ? "Parceria Loja X" : ""),
            tags: i===3 ? ["midia","q3"] : [],
            campaignId: "",
          });
        }
        STATE.invites = sample;
        saveInvites();
      }

      function computeDerivedStatus(inv){
        if (inv.status === "revogado") return "revogado";
        if (inv.status === "pausado") return "pausado";
        if (inv.expiresAt && inv.expiresAt < now()) return "expirado";
        if (inv.usageLimit && inv.usageCount >= inv.usageLimit) return "esgotado";
        return "ativo";
      }

      function statusBadge(status){
        const s = status;
        return `<span class="status ${s}"><span class="dot"></span>${s.charAt(0).toUpperCase()+s.slice(1)}</span>`;
      }

      function toast(msg, kind=""){
        const wrap = $("#toasts");
        const t = document.createElement("div");
        t.className = "chip " + (kind==="danger"?"danger":kind==="warn"?"warn":"");
        t.innerHTML = `<span class="dot"></span>${msg}`;
        wrap.appendChild(t);
        setTimeout(()=>{ t.style.opacity="0"; t.style.transform="translateY(4px)"; }, 2800);
        setTimeout(()=> wrap.removeChild(t), 3400);
      }

      function setMeta(){
        $("#metaTotal").textContent = STATE.invites.length;
        $("#metaSel").textContent = STATE.selection.size;
        $("#metaFiltered").textContent = STATE.cachedFiltered.length;
        const start = STATE.page.index*STATE.page.size;
        const end = Math.min(start + STATE.page.size, STATE.cachedFiltered.length);
        $("#metaText").textContent = STATE.cachedFiltered.length ? `Mostrando ${start+1}–${end} de ${STATE.cachedFiltered.length}` : "—";
      }

      function applyFilters(){
        let arr = STATE.invites.map(x=> ({...x, _derived: computeDerivedStatus(x)}));

        const q = STATE.filters.q.trim().toLowerCase();
        if (q){
          arr = arr.filter(x =>
            x.code.toLowerCase().includes(q) ||
            (x.url||"").toLowerCase().includes(q) ||
            (x.note||"").toLowerCase().includes(q) ||
            (x.tags||[]).some(t => t.toLowerCase().includes(q))
          );
        }
        if (STATE.filters.status){
          arr = arr.filter(x => x._derived === STATE.filters.status);
        }
        if (STATE.filters.campaign){
          arr = arr.filter(x => x.campaignId === STATE.filters.campaign);
        }
        if (STATE.filters.from){
          const ts = new Date(STATE.filters.from + "T00:00:00").getTime();
          arr = arr.filter(x => (x.createdAt||0) >= ts);
        }
        if (STATE.filters.to){
          const ts = new Date(STATE.filters.to + "T23:59:59").getTime();
          arr = arr.filter(x => (x.createdAt||0) <= ts);
        }

        // Sort
        const {by, dir} = STATE.sort;
        arr.sort((a,b)=>{
          let va, vb;
          switch(by){
            case "code": va=a.code; vb=b.code; break;
            case "url": va=a.url; vb=b.url; break;
            case "status": va=a._derived; vb=b._derived; break;
            case "usage": va=a.usageCount; vb=b.usageCount; break;
            case "limit": va=a.usageLimit; vb=b.usageLimit; break;
            case "expiresAt": va=a.expiresAt||0; vb=b.expiresAt||0; break;
            case "createdAt": default: va=a.createdAt||0; vb=b.createdAt||0; break;
          }
          if (typeof va === "string"){ va = va.toLowerCase(); vb = String(vb||"").toLowerCase(); }
          return dir==="asc" ? (va>vb?1:va<vb?-1:0) : (va<vb?1:va>vb?-1:0);
        });

        STATE.cachedFiltered = arr;
        clampPage();
      }

      function clampPage(){
        const totalPages = Math.max(1, Math.ceil(STATE.cachedFiltered.length / STATE.page.size));
        if (STATE.page.index > totalPages-1) STATE.page.index = totalPages-1;
        if (STATE.page.index < 0) STATE.page.index = 0;
        $("#pgCur").textContent = (STATE.page.index+1);
        $("#pgTotal").textContent = totalPages;
      }

      function renderList(){
        const tbody = $("#tbody");
        tbody.innerHTML = "";
        const start = STATE.page.index*STATE.page.size;
        const end = Math.min(start + STATE.page.size, STATE.cachedFiltered.length);
        const slice = STATE.cachedFiltered.slice(start, end);

        if (!slice.length){
          $("#empty").hidden = false;
        } else {
          $("#empty").hidden = true;
        }

        for (const inv of slice){
          const status = inv._derived || computeDerivedStatus(inv);
          const tr = document.createElement("tr");
          const selected = STATE.selection.has(inv.id);

          tr.innerHTML = `
            <td data-label="Sel"><input type="checkbox" data-id="${inv.id}" ${selected?"checked":""} aria-label="Selecionar linha"/></td>
            <td data-label="Código"><div class="monospace">${inv.code}</div></td>
            <td data-label="Link">
              <div class="monospace" style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${inv.url||""}</div>
            </td>
            <td data-label="Status">${statusBadge(status)}</td>
            <td data-label="Usos"><strong>${inv.usageCount||0}</strong></td>
            <td data-label="Limite">${inv.usageLimit||"—"}</td>
            <td data-label="Expira">${fmtDate(inv.expiresAt)}</td>
            <td data-label="Criado">${fmtDate(inv.createdAt)}</td>
            <td data-label="Notas/Tags">
              <div>${inv.note ? inv.note : "<span class='help'>—</span>"}</div>
              <div class="tags">${(inv.tags||[]).map(t=>`<span class="tag">${t}</span>`).join("")}</div>
            </td>
            <td data-label="Ações">
              <div class="row-actions">
                <button class="btn" data-act="copy" data-id="${inv.id}">Copiar</button>
                <button class="btn" data-act="share" data-id="${inv.id}">QR/Compart.</button>
                ${status==="pausado"
                  ? `<button class="btn" data-act="resume" data-id="${inv.id}">Reativar</button>`
                  : `<button class="btn warn" data-act="pause" data-id="${inv.id}">Pausar</button>`
                }
                ${status==="revogado"
                  ? `<button class="btn" data-act="resume" data-id="${inv.id}">Reativar</button>`
                  : `<button class="btn danger" data-act="revoke" data-id="${inv.id}">Revogar</button>`
                }
                <button class="btn" data-act="edit" data-id="${inv.id}">Editar</button>
                <button class="btn danger" data-act="del" data-id="${inv.id}">Excluir</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        }

        setMeta();
        bindRowEvents();
      }

      function bindRowEvents(){
        // Seleção
        $$("#tbody input[type=checkbox]").forEach(chk=>{
          chk.addEventListener("change", ()=>{
            const id = chk.getAttribute("data-id");
            if (chk.checked) STATE.selection.add(id);
            else STATE.selection.delete(id);
            $("#metaSel").textContent = STATE.selection.size;
            // Ajustar chkAll estado
            const allOnPage = $$("#tbody input[type=checkbox]");
            const allChecked = allOnPage.length && allOnPage.every(c => c.checked);
            $("#chkAll").checked = allChecked;
          });
        });

        // Ações
        $$("#tbody .row-actions .btn").forEach(btn=>{
          btn.addEventListener("click", async (e)=>{
            e.preventDefault();
            const id = btn.getAttribute("data-id");
            const act = btn.getAttribute("data-act");
            const inv = STATE.invites.find(x => x.id === id);
            if (!inv) return;

            if (act==="copy"){
              await navigator.clipboard.writeText(inv.url || (baseInviteUrl()+encodeURIComponent(inv.code)));
              toast("Link copiado ✅");
            }
            if (act==="share"){
              openShareDialog(inv);
            }
            if (act==="pause"){
              if (inv.status !== "revogado"){
                inv.status = "pausado";
                saveInvites(); refresh();
                toast("Convite pausado", "warn");
              }
            }
            if (act==="resume"){
              if (computeDerivedStatus(inv) !== "revogado"){
                inv.status = "ativo";
                saveInvites(); refresh();
                toast("Convite reativado");
              }
            }
            if (act==="revoke"){
              if (confirm("Revogar este convite? A ação é reversível apenas manualmente.")){
                inv.status = "revogado";
                saveInvites(); refresh();
                toast("Convite revogado", "danger");
              }
            }
            if (act==="edit"){
              openEditDialog(inv);
            }
            if (act==="del"){
              if (confirm("Excluir este convite permanentemente?")){
                STATE.invites = STATE.invites.filter(x => x.id !== inv.id);
                STATE.selection.delete(inv.id);
                saveInvites(); refresh();
                toast("Convite excluído", "danger");
              }
            }
          });
        });
      }

      function refresh(){
        applyFilters();
        renderList();
      }

      // Filters/toolbar binding
      function bindToolbar(){
        $("#q").addEventListener("input", (e)=>{
          STATE.filters.q = e.target.value;
          STATE.page.index = 0;
          refresh();
        });
        $("#fStatus").addEventListener("change", (e)=>{
          STATE.filters.status = e.target.value;
          STATE.page.index = 0;
          refresh();
        });
        $("#fCampaign").addEventListener("change", (e)=>{
          STATE.filters.campaign = e.target.value;
          STATE.page.index = 0;
          refresh();
        });
        $("#fFrom").addEventListener("change", (e)=>{ STATE.filters.from = e.target.value; STATE.page.index = 0; refresh(); });
        $("#fTo").addEventListener("change", (e)=>{ STATE.filters.to = e.target.value; STATE.page.index = 0; refresh(); });

        $("#btnClearFilters").addEventListener("click", ()=>{
          STATE.filters = { q:"", status:"", campaign:"", from:"", to:"" };
          $("#q").value = ""; $("#fStatus").value = ""; $("#fCampaign").value = "";
          $("#fFrom").value = ""; $("#fTo").value = "";
          STATE.page.index = 0; refresh();
        });

        // Sorting
        $$("thead th[data-sort]").forEach(th=>{
          th.addEventListener("click", ()=>{
            const by = th.getAttribute("data-sort");
            if (STATE.sort.by === by){
              STATE.sort.dir = STATE.sort.dir === "asc" ? "desc" : "asc";
            } else {
              STATE.sort.by = by; STATE.sort.dir = "asc";
            }
            refresh();
          });
        });

        // Paging
        $("#pgSize").addEventListener("change", (e)=>{
          STATE.page.size = parseInt(e.target.value,10)||10;
          STATE.page.index = 0;
          clampPage(); renderList();
        });
        $("#pgFirst").addEventListener("click", ()=>{ STATE.page.index=0; clampPage(); renderList(); });
        $("#pgPrev").addEventListener("click", ()=>{ STATE.page.index--; clampPage(); renderList(); });
        $("#pgNext").addEventListener("click", ()=>{ STATE.page.index++; clampPage(); renderList(); });
        $("#pgLast").addEventListener("click", ()=>{
          const totalPages = Math.max(1, Math.ceil(STATE.cachedFiltered.length / STATE.page.size));
          STATE.page.index = totalPages-1; clampPage(); renderList();
        });

        // Select all current page
        $("#chkAll").addEventListener("change", ()=>{
          const pageIds = $$("#tbody input[type=checkbox]").map(c => c.getAttribute("data-id"));
          if ($("#chkAll").checked) pageIds.forEach(id => STATE.selection.add(id));
          else pageIds.forEach(id => STATE.selection.delete(id));
          renderList();
        });
        $("#btnSelectAll").addEventListener("click", ()=>{
          if (STATE.selection.size){
            STATE.selection.clear();
          } else {
            STATE.cachedFiltered.forEach(x => STATE.selection.add(x.id));
          }
          renderList();
        });

        // Mass actions
        $("#btnPauseSel").addEventListener("click", ()=>{
          if (!STATE.selection.size){ toast("Nenhum selecionado", "warn"); return; }
          STATE.invites.forEach(x=>{ if (STATE.selection.has(x.id) && x.status!=="revogado") x.status="pausado"; });
          saveInvites(); refresh(); toast("Convites pausados", "warn");
        });
        $("#btnResumeSel").addEventListener("click", ()=>{
          if (!STATE.selection.size){ toast("Nenhum selecionado", "warn"); return; }
          STATE.invites.forEach(x=>{ if (STATE.selection.has(x.id)) x.status="ativo"; });
          saveInvites(); refresh(); toast("Convites reativados");
        });
        $("#btnRevokeSel").addEventListener("click", ()=>{
          if (!STATE.selection.size){ toast("Nenhum selecionado", "warn"); return; }
          if (!confirm("Revogar convites selecionados?")) return;
          STATE.invites.forEach(x=>{ if (STATE.selection.has(x.id)) x.status="revogado"; });
          saveInvites(); refresh(); toast("Convites revogados", "danger");
        });

        // Export
        $("#btnExport").addEventListener("click", ()=>{
          const rows = [["id","code","url","status","usageCount","usageLimit","createdAt","expiresAt","note","tags","campaignId"]];
          STATE.cachedFiltered.forEach(i=>{
            rows.push([
              i.id,
              i.code,
              i.url,
              computeDerivedStatus(i),
              i.usageCount||0,
              i.usageLimit||"",
              i.createdAt||"",
              i.expiresAt||"",
              (i.note||"").replace(/\n/g," "),
              (i.tags||[]).join("|"),
              i.campaignId||""
            ]);
          });
          const csv = rows.map(r => r.map(v=>{
            v = (v===null||v===undefined) ? "" : String(v);
            if (/[",;\n]/.test(v)) v = `"${v.replace(/"/g,'""')}"`;
            return v;
          }).join(";")).join("\n");
          const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "convites.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        });

        // New & Batch
        $("#btnNew").addEventListener("click", openNewDialog);
        $("#btnBatch").addEventListener("click", openBatchDialog);

        // Logout mock
        $("#btnLogout").addEventListener("click", ()=>{
          localStorage.removeItem(KEYS.auth);
          location.href = "./login.html";
        });
      }

      // Dialogs: New
      function openNewDialog(){
        const dlg = $("#dlgNew");
        $("#nLimit").value = 1;
        $("#nExpires").value = "";
        $("#nCampaign").value = "";
        $("#nPrefix").value = "";
        $("#nNote").value = "";
        $("#nPaused").checked = false;
        updateNewPreview();

        $("#nLimit").oninput = updateNewPreview;
        $("#nPrefix").oninput = updateNewPreview;

        dlg.showModal();

        $("#nSubmit").onclick = (e)=>{
          e.preventDefault();
          const limit = Math.max(1, parseInt($("#nLimit").value||"1",10));
          const expires = $("#nExpires").value ? new Date($("#nExpires").value).getTime() : null;
          const campaign = $("#nCampaign").value || "";
          const prefix = ($("#nPrefix").value||"").trim();
          const note = ($("#nNote").value||"").trim();
          const paused = $("#nPaused").checked;

          const code = genCode(prefix);
          const inv = {
            id: crypto.randomUUID(),
            code,
            url: baseInviteUrl()+encodeURIComponent(code),
            status: paused ? "pausado" : "ativo",
            usageLimit: limit,
            usageCount: 0,
            createdAt: now(),
            expiresAt: expires,
            note,
            tags: [],
            campaignId: campaign
          };
          STATE.invites.unshift(inv);
          saveInvites();
          dlg.close();
          refresh();
          toast("Convite criado ✅");
        };
      }
      function updateNewPreview(){
        const prefix = ($("#nPrefix").value||"").trim();
        const code = genCode(prefix).replace(/-[A-Z0-9]{4}-[A-Z0-9]{4}$/, "-XXXX-XXXX"); // só para prévia
        $("#nPreview").textContent = "Prévia: " + code;
      }

      // Dialogs: Batch
      function openBatchDialog(){
        const dlg = $("#dlgBatch");
        $("#bQty").value = 10; $("#bLimit").value = 1; $("#bPrefix").value = "";
        $("#bExpires").value = ""; $("#bCampaign").value = ""; $("#bNoteTmpl").value = ""; $("#bPaused").checked=false;
        updateBatchSummary();
        $("#bQty").oninput = updateBatchSummary;

        dlg.showModal();
        $("#bSubmit").onclick = (e)=>{
          e.preventDefault();
          const qty = Math.max(1, Math.min(1000, parseInt($("#bQty").value||"1",10)));
          const limit = Math.max(1, parseInt($("#bLimit").value||"1",10));
          const prefix = ($("#bPrefix").value||"").trim();
          const exp = $("#bExpires").value ? new Date($("#bExpires").value).getTime() : null;
          const campaign = $("#bCampaign").value || "";
          const noteTmpl = ($("#bNoteTmpl").value||"").trim();
          const paused = $("#bPaused").checked;

          const created = [];
          for (let i=1;i<=qty;i++){
            const code = genCode(prefix);
            const note = noteTmpl ? noteTmpl.replace(/#{n}/g, String(i)) : "";
            created.push({
              id: crypto.randomUUID(),
              code,
              url: baseInviteUrl()+encodeURIComponent(code),
              status: paused ? "pausado" : "ativo",
              usageLimit: limit,
              usageCount: 0,
              createdAt: now(),
              expiresAt: exp,
              note,
              tags: [],
              campaignId: campaign
            });
          }
          // Adiciona no topo
          STATE.invites = created.concat(STATE.invites);
          saveInvites();
          dlg.close();
          refresh();
          toast(`${qty} convites criados ✅`);
        };
      }
      function updateBatchSummary(){
        const qty = Math.max(1, Math.min(1000, parseInt($("#bQty").value||"1",10)));
        $("#bSummary").textContent = `Serão criados ${qty} convites.`;
      }

      // Dialog: Edit
      let EDIT_ID = null;
      function openEditDialog(inv){
        EDIT_ID = inv.id;
        $("#eLimit").value = inv.usageLimit||1;
        $("#eExpires").value = inv.expiresAt ? toISOLike(inv.expiresAt) : "";
        $("#eCampaign").value = inv.campaignId || "";
        $("#eNote").value = inv.note || "";
        $("#eTags").value = (inv.tags||[]).join(", ");
        $("#ePaused").checked = inv.status==="pausado";
        $("#eCode").textContent = `Código: ${inv.code} — Usos: ${inv.usageCount||0}/${inv.usageLimit||"—"}`;

        const dlg = $("#dlgEdit");
        dlg.showModal();

        $("#eSubmit").onclick = (e)=>{
          e.preventDefault();
          const up = STATE.invites.find(x=>x.id===EDIT_ID);
          if (!up) return;
          up.usageLimit = Math.max(1, parseInt($("#eLimit").value||"1",10));
          up.expiresAt = $("#eExpires").value ? new Date($("#eExpires").value).getTime() : null;
          up.campaignId = $("#eCampaign").value || "";
          up.note = ($("#eNote").value||"").trim();
          up.tags = ($("#eTags").value||"").split(",").map(t => t.trim()).filter(Boolean);
          up.status = $("#ePaused").checked ? "pausado" : "ativo";
          saveInvites(); dlg.close(); refresh();
          toast("Convite atualizado");
        };
      }

      // Dialog: Share
      function openShareDialog(inv){
        const link = inv.url || (baseInviteUrl()+encodeURIComponent(inv.code));
        const dlg = $("#dlgShare");
        $("#sLink").value = link;
        $("#sMeta").textContent = `Código: ${inv.code} • Usos: ${inv.usageCount||0}/${inv.usageLimit||"—"} • Status: ${computeDerivedStatus(inv)}`;
        const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent(link)}`;
        $("#qrImg").src = qrUrl;
        $("#sDownloadQR").href = qrUrl;

        $("#sCopy").onclick = async (e)=>{ e.preventDefault(); await navigator.clipboard.writeText(link); toast("Link copiado ✅"); };
        $("#sOpen").onclick = (e)=>{ e.preventDefault(); window.open(link, "_blank"); };
        $("#sShare").onclick = async (e)=>{
          e.preventDefault();
          if (navigator.share){
            try{
              await navigator.share({ title:"Convite Facil", text:`Acesse seu convite:\n${link}`, url: link });
            }catch{}
          }else{
            await navigator.clipboard.writeText(link);
            toast("Compartilhar não suportado — link copiado");
          }
        };

        dlg.showModal();
      }

      // Auth (simples/mocked)
      function requireAuth(){
        // Se quiser bloquear, descomente:
        // const token = localStorage.getItem(KEYS.auth);
        // if (!token){ location.href = "./login.html"; return false; }
        return true;
      }

      // Fill campaign selects
      function bindCampaignOptions(){
        const camps = loadCampaigns();
        const opts = ['<option value="">—</option>']
          .concat(camps.map(c => `<option value="${c.id}">${c.name||("Campanha "+c.id.slice(0,6))}</option>`))
          .join("");
        ["#fCampaign","#nCampaign","#bCampaign","#eCampaign"].forEach(sel=>{
          const el = $(sel);
          if (el) el.innerHTML = opts;
        });
      }

      function bindGlobalShortcuts(){
        document.addEventListener("keydown", (e)=>{
          if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="k"){ e.preventDefault(); $("#q").focus(); }
          if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="n"){ e.preventDefault(); openNewDialog(); }
        });
      }

      async function init(){
        if (!requireAuth()) return;
        bindToolbar();
        bindGlobalShortcuts();
        STATE.invites = loadInvites();
        seedIfEmpty();
        bindCampaignOptions();
        // Page size from last session
        const lastSize = parseInt(localStorage.getItem("facil_pgsize_inv")||"10",10);
        if (!isNaN(lastSize)){ STATE.page.size=lastSize; $("#pgSize").value=String(lastSize); }
        $("#pgSize").addEventListener("change", ()=> localStorage.setItem("facil_pgsize_inv", $("#pgSize").value));
        refresh();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>