<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facil — Configurações</title>
  <meta name="description" content="Central de Configurações da Facil: perfil, segurança, preferências, notificações, integrações, webhooks, equipe, pagamentos, dados e sessão." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0c10;
      --bg-elev:#111217;
      --panel:#161821;
      --text:#e7e9ee;
      --muted:#a9afbb;
      --brand:#6ac9ff;
      --brand-2:#3498db;
      --ok:#2ecc71;
      --warn:#f1c40f;
      --err:#ff5d5d;
      --line:#222634;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --chip:#1b1f2b;
      --chip-br:#2a3042;
      --focus:#8ad2ff;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7f7fb;
        --bg-elev:#ffffff;
        --panel:#ffffff;
        --text:#101318;
        --muted:#5a6170;
        --brand:#0b74ff;
        --brand-2:#0a63d1;
        --ok:#1e9e57;
        --warn:#b78900;
        --err:#d43a3a;
        --line:#e7e9f0;
        --chip:#f0f3fa;
        --chip-br:#dfe5f3;
        --shadow: 0 10px 24px rgba(0,0,0,.08);
        --focus:#0b74ff;
      }
    }
    [data-theme="dark"]{
      color-scheme: dark;
    }
    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      line-height:1.45;
    }
    a{ color:var(--brand); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:40;
      display:flex; align-items:center; gap:12px;
      padding:14px 18px;
      background:linear-gradient(180deg, rgba(0,0,0,.24), transparent), var(--bg-elev);
      border-bottom:1px solid var(--line);
      backdrop-filter: blur(8px);
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:750; letter-spacing:.2px;
    }
    .brand .logo{
      width:28px; height:28px; border-radius:8px;
      background:linear-gradient(135deg, var(--brand), var(--brand-2));
      box-shadow: inset 0 0 12px rgba(255,255,255,.25), 0 6px 16px rgba(0,0,0,.25);
    }
    .grow{ flex:1; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--chip);
      border:1px solid var(--chip-br);
      padding:6px 10px; border-radius:999px; font-size:.85rem; color:var(--muted);
    }
    .chip .dot{ width:8px; height:8px; border-radius:50%; background:var(--ok); box-shadow:0 0 0 2px rgba(46,204,113,.2); }
    .top-actions{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    /* Layout */
    .container{ max-width:1200px; margin:0 auto; padding:22px 18px 80px; }
    .page-title{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin:8px 0 18px;
    }
    .page-title h1{ margin:0; font-size:1.45rem; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .subtle{ color:var(--muted); font-size:.95rem; }
    .grid{
      display:grid; gap:16px;
      grid-template-columns: 280px 1fr;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* Sidebar */
    .sidebar{
      position:sticky; top:72px;
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:10px;
    }
    .navlist{ list-style:none; margin:0; padding:6px; }
    .navlist li{ margin:0; }
    .navbtn{
      width:100%; text-align:left;
      background:transparent; color:var(--text);
      border:0; padding:10px 12px; border-radius:10px;
      display:flex; align-items:center; gap:10px; cursor:pointer;
    }
    .navbtn:hover{ background:rgba(255,255,255,.04); }
    .navbtn.active{ background:linear-gradient(90deg, rgba(106,201,255,.15), transparent); outline:1px solid rgba(106,201,255,.3); }

    /* Content cards */
    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .hd{
      padding:16px 16px 0; display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd h2{ margin:0; font-size:1.1rem; }
    .card .bd{ padding:14px 16px 18px; }
    .card + .card{ margin-top:14px; }

    .row{ display:grid; grid-template-columns: repeat(12, 1fr); gap:12px; }
    .col-6{ grid-column: span 6; } .col-12{ grid-column: span 12; }
    .col-4{ grid-column: span 4; } .col-3{ grid-column: span 3; } .col-8{ grid-column: span 8; }
    @media (max-width: 720px){ .col-6,.col-4,.col-3,.col-8{ grid-column: span 12; } }

    label{ display:block; font-weight:600; margin:8px 2px 6px; }
    .hint{ color:var(--muted); font-size:.85rem; margin-top:4px; }
    .input, .select, .textarea{
      width:100%; background:#0f111a;
      color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; outline:0; transition: box-shadow .15s, border-color .15s, background .15s;
    }
    [data-theme="light"] .input, [data-theme="light"] .select, [data-theme="light"] .textarea{ background:#fff; }
    .input:focus, .select:focus, .textarea:focus{ border-color:var(--focus); box-shadow:0 0 0 4px rgba(106,201,255,.15); }
    .textarea{ min-height:96px; resize:vertical; }

    .btn{
      background:var(--brand);
      color:#fff; border:0; padding:10px 14px; border-radius:12px;
      cursor:pointer; font-weight:700; letter-spacing:.2px;
      box-shadow: 0 10px 18px rgba(106,201,255,.25);
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .btn-ghost{
      background:transparent; color:var(--text); border:1px solid var(--line);
      padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .btn-warn{
      background:linear-gradient(180deg, #ff7a7a, #ff5d5d); color:#fff;
      box-shadow: 0 10px 18px rgba(255,93,93,.25);
    }
    .btn-ok{ background:linear-gradient(180deg, #37d27a, #2ecc71); color:#07210f; }
    .btn-line{ background:transparent; border:1px dashed var(--chip-br); color:var(--muted); }

    .switch{
      --w: 44px; --h:24px;
      width:var(--w); height:var(--h); background:#2a2f40;
      border-radius:999px; position:relative; border:1px solid var(--line); cursor:pointer; display:inline-block;
    }
    .switch i{
      position:absolute; top:2px; left:2px; width:20px; height:20px; border-radius:999px; background:#fff; transition: transform .18s;
    }
    .switch.on{ background:#2ecc71; border-color:#23b05f; }
    .switch.on i{ transform: translateX(20px); }

    .divider{ height:1px; background:var(--line); margin:8px 0 14px; }
    .inline{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--muted); font-size:.85rem; }
    .list{ list-style:none; margin:0; padding:0; }
    .list li{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 8px; border-bottom:1px dashed var(--line); }
    .list li:last-child{ border-bottom:0; }

    /* Tabs (content sections) */
    .section{ display:none; }
    .section.active{ display:block; animation: fade .15s ease-in; }
    @keyframes fade{ from{ opacity:0; transform: translateY(4px) } to{ opacity:1; transform: none } }

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:60;
      min-width:240px; max-width:520px;
      background:var(--panel); color:var(--text);
      border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
      padding:12px 14px; display:flex; align-items:flex-start; gap:10px;
    }
    .toast.ok{ border-color:rgba(46,204,113,.35); box-shadow:0 10px 26px rgba(46,204,113,.15); }
    .toast.warn{ border-color:rgba(241,196,15,.35); box-shadow:0 10px 26px rgba(241,196,15,.18); }
    .toast.err{ border-color:rgba(255,93,93,.35); box-shadow:0 10px 26px rgba(255,93,93,.2); }
    .toast .t-title{ font-weight:700; }
    .toast .t-actions{ margin-left:auto; }
    .hidden{ display:none !important; }

    /* Modal */
    .modal-mask{
      position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; z-index:70;
    }
    .modal{
      width:min(680px, calc(100vw - 28px)); max-height:80vh; overflow:auto;
      background:var(--panel); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      padding:14px;
    }
    .modal .mhd{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:6px; }
    .modal .mbd{ padding:10px 6px 6px; }
    .modal .mft{ padding:8px 6px 6px; display:flex; gap:8px; justify-content:flex-end; }

    /* Code-ish */
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:.92rem; background:#0e1220; border:1px solid #151b2a; border-radius:10px; padding:10px; color:#b9d2ff;
      overflow:auto;
    }
    [data-theme="light"] .code{ background:#f6f8ff; border-color:#dfe5ff; color:#072a6b; }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:rgba(255,255,255,.04); }
    .kbd{ padding:2px 6px; border:1px solid var(--line); border-radius:6px; background:rgba(255,255,255,.06); font-size:.85rem; }

    /* Avatar */
    .avatar{
      width:64px; height:64px; border-radius:16px; background:#22273a; border:1px solid var(--line);
      background-size:cover; background-position:center;
    }
    .danger{ color:var(--err); }

    /* Tables (minimal) */
    .tbl{ width:100%; border-collapse: collapse; }
    .tbl th, .tbl td{ text-align:left; padding:10px 8px; border-bottom:1px dashed var(--line); }
    .tbl th{ font-size:.9rem; color:var(--muted); font-weight:600; }
    .tbl tr:last-child td{ border-bottom:0; }

    /* Sticky footer spacer */
    .spacer{ height:42px; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand" title="Facil">
      <div class="logo" aria-hidden="true"></div>
      <div>Facil</div>
      <span class="chip" id="envChip" title="Sessão autenticada"><i class="dot"></i>Admin</span>
    </div>
    <div class="grow"></div>
    <div class="top-actions">
      <button id="btnTheme" class="btn-ghost" title="Alternar tema">Tema</button>
      <a class="btn-ghost" href="./7-dashboard.html" title="Voltar ao painel">Painel</a>
      <button id="btnSaveAll" class="btn">Salvar tudo</button>
    </div>
  </header>

  <main class="container">
    <div class="page-title">
      <div>
        <h1>Configurações</h1>
        <div class="subtle">Ajuste suas preferências, segurança, integrações e dados da conta.</div>
      </div>
      <div class="toolbar">
        <button id="btnExport" class="btn-ghost">Exportar backup</button>
        <label class="btn-ghost" for="fileImport" style="cursor:pointer">Importar</label>
        <input id="fileImport" type="file" accept="application/json" class="hidden" />
        <button id="btnReset" class="btn-warn">Restaurar padrão</button>
      </div>
    </div>

    <div class="grid">
      <!-- Sidebar -->
      <aside class="sidebar" aria-label="Navegação das configurações">
        <ul class="navlist">
          <li><button class="navbtn active" data-target="perfil">Perfil</button></li>
          <li><button class="navbtn" data-target="seguranca">Segurança</button></li>
          <li><button class="navbtn" data-target="preferencias">Preferências</button></li>
          <li><button class="navbtn" data-target="notificacoes">Notificações</button></li>
          <li><button class="navbtn" data-target="integracoes">Integrações & API</button></li>
          <li><button class="navbtn" data-target="pagamentos">Pagamentos</button></li>
          <li><button class="navbtn" data-target="equipe">Equipe & Acesso</button></li>
          <li><button class="navbtn" data-target="dados">Dados & Privacidade</button></li>
          <li><button class="navbtn" data-target="sessao">Sessão</button></li>
          <li><button class="navbtn" data-target="auditoria">Auditoria</button></li>
        </ul>
      </aside>

      <!-- Content -->
      <section id="content">
        <!-- Perfil -->
        <div class="section active" id="sec-perfil" role="region" aria-labelledby="perfil">
          <div class="card">
            <div class="hd">
              <h2>Perfil da Conta</h2>
              <div class="inline">
                <span class="badge">ID: <span id="profileId"></span></span>
                <button id="btnCopyId" class="btn-ghost">Copiar ID</button>
              </div>
            </div>
            <div class="bd">
              <div class="row">
                <div class="col-3">
                  <label>Avatar</label>
                  <div id="avatar" class="avatar" style="background-image:url('');"></div>
                  <div class="inline" style="margin-top:10px">
                    <label class="btn-ghost" for="fileAvatar" style="cursor:pointer">Enviar</label>
                    <button id="btnAvatarClear" class="btn-ghost">Remover</button>
                    <input id="fileAvatar" type="file" accept="image/*" class="hidden" />
                  </div>
                  <div class="hint">JPG/PNG até 2MB. Cortaremos automaticamente para 1:1.</div>
                </div>
                <div class="col-9">
                  <div class="row">
                    <div class="col-6">
                      <label for="name">Nome completo</label>
                      <input id="name" class="input" placeholder="Seu nome" />
                    </div>
                    <div class="col-6">
                      <label for="email">Email</label>
                      <input id="email" class="input" type="email" placeholder="voce@exemplo.com" />
                    </div>
                    <div class="col-6">
                      <label for="phone">Telefone</label>
                      <input id="phone" class="input" placeholder="(11) 99999-9999" />
                    </div>
                    <div class="col-6">
                      <label for="doc">CPF/CNPJ</label>
                      <input id="doc" class="input" placeholder="000.000.000-00 ou 00.000.000/0001-00" />
                    </div>
                    <div class="col-6">
                      <label for="timezone">Fuso horário</label>
                      <select id="timezone" class="select"></select>
                    </div>
                    <div class="col-6">
                      <label for="lang">Idioma</label>
                      <select id="lang" class="select">
                        <option value="pt-BR">Português (Brasil)</option>
                        <option value="en-US">English (US)</option>
                        <option value="es-ES">Español</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div class="divider"></div>
              <div class="inline">
                <button id="btnSavePerfil" class="btn">Salvar perfil</button>
                <span class="hint">Alterações de email podem exigir nova verificação.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Segurança -->
        <div class="section" id="sec-seguranca" role="region" aria-labelledby="seguranca">
          <div class="card">
            <div class="hd"><h2>Senha</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-4">
                  <label for="pwdCurrent">Senha atual</label>
                  <input id="pwdCurrent" class="input" type="password" autocomplete="current-password" />
                </div>
                <div class="col-4">
                  <label for="pwdNew">Nova senha</label>
                  <input id="pwdNew" class="input" type="password" autocomplete="new-password" />
                  <div id="pwdMeter" class="hint">Força: —</div>
                </div>
                <div class="col-4">
                  <label for="pwdNew2">Confirmar senha</label>
                  <input id="pwdNew2" class="input" type="password" autocomplete="new-password" />
                </div>
              </div>
              <div class="inline" style="margin-top:8px">
                <button id="btnChangePwd" class="btn">Atualizar senha</button>
                <span class="hint">Use ao menos 12 caracteres, com letras, números e símbolos.</span>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd"><h2>Autenticação em 2 fatores (TOTP)</h2></div>
            <div class="bd">
              <div class="inline" style="margin-bottom:8px">
                <span class="badge" id="twofaStatus">Status: Desativado</span>
                <button id="btn2faSetup" class="btn-ghost">Gerar chave</button>
                <button id="btn2faDisable" class="btn-ghost danger" disabled>Desativar</button>
              </div>
              <div id="twofaBlock" class="hidden">
                <div class="row">
                  <div class="col-8">
                    <label>Chave secreta (Base32)</label>
                    <div class="inline">
                      <input id="twofaSecret" class="input" readonly />
                      <button id="btnCopy2FA" class="btn-ghost">Copiar</button>
                    </div>
                    <label>URI otpauth</label>
                    <textarea id="twofaUri" class="textarea code" readonly></textarea>
                    <div class="hint">Abra o Google Authenticator, 1Password ou similar e escaneie a URI acima ou insira a chave manualmente.</div>
                  </div>
                  <div class="col-4">
                    <label for="twofaCode">Código de 6 dígitos</label>
                    <input id="twofaCode" class="input" placeholder="000000" />
                    <div class="inline" style="margin-top:10px">
                      <button id="btn2faVerify" class="btn-ok btn">Verificar e ativar</button>
                      <span class="hint">Verificação simulada no cliente.</span>
                    </div>
                  </div>
                </div>
              </div>
              <div class="divider"></div>
              <div class="inline">
                <div class="switch" id="switchDeviceLock" role="switch" aria-checked="false"><i></i></div>
                <div>
                  <div><strong>Bloqueio por dispositivo</strong></div>
                  <div class="hint">Requer novo login ao detectar novo dispositivo.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Preferências -->
        <div class="section" id="sec-preferencias" role="region" aria-labelledby="preferencias">
          <div class="card">
            <div class="hd"><h2>Aparência e Formatos</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-4">
                  <label for="theme">Tema</label>
                  <select id="theme" class="select">
                    <option value="system">Sistema</option>
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                  </select>
                </div>
                <div class="col-4">
                  <label for="currency">Moeda</label>
                  <select id="currency" class="select">
                    <option value="BRL">BRL — Real</option>
                    <option value="USD">USD — Dólar</option>
                    <option value="EUR">EUR — Euro</option>
                  </select>
                </div>
                <div class="col-4">
                  <label for="odds">Formato de odds</label>
                  <select id="odds" class="select">
                    <option value="decimal">Decimal (2.10)</option>
                    <option value="fractional">Fracional (11/10)</option>
                    <option value="american">Americano (+110)</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="numberFmt">Formato numérico</label>
                  <select id="numberFmt" class="select">
                    <option value="pt-BR">1.234,56</option>
                    <option value="en-US">1,234.56</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="dateFmt">Formato de data</label>
                  <select id="dateFmt" class="select">
                    <option value="dd/MM/yyyy">dd/MM/yyyy</option>
                    <option value="MM/dd/yyyy">MM/dd/yyyy</option>
                    <option value="yyyy-MM-dd">yyyy-MM-dd</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="hd"><h2>Preferências de produto</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-6">
                  <div class="inline">
                    <div class="switch" id="switchQuickBet" role="switch" aria-checked="false"><i></i></div>
                    <div>
                      <div><strong>Aposta Rápida</strong></div>
                      <div class="hint">Confirmar aposta com 1 clique quando valor padrão estiver definido.</div>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="inline">
                    <div class="switch" id="switchAutoCashout" role="switch" aria-checked="false"><i></i></div>
                    <div>
                      <div><strong>Auto Cashout</strong></div>
                      <div class="hint">Autorizar cashout automático ao atingir limiar configurado.</div>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <label for="defaultStake">Valor padrão da aposta</label>
                  <input id="defaultStake" class="input" type="number" min="0" step="1" placeholder="R$ 10,00" />
                </div>
                <div class="col-6">
                  <label for="cashoutThreshold">Limiar de cashout (%)</label>
                  <input id="cashoutThreshold" class="input" type="number" min="1" max="100" step="1" placeholder="50" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notificações -->
        <div class="section" id="sec-notificacoes" role="region" aria-labelledby="notificacoes">
          <div class="card">
            <div class="hd"><h2>Notificações</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-4">
                  <div class="inline">
                    <div class="switch" id="switchEmail" role="switch" aria-checked="true"><i></i></div>
                    <div>
                      <div><strong>Email</strong></div>
                      <div class="hint">Receba confirmações e alertas por email.</div>
                    </div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="inline">
                    <div class="switch" id="switchPush" role="switch" aria-checked="false"><i></i></div>
                    <div>
                      <div><strong>Push</strong></div>
                      <div class="hint">Notificações do navegador (requer permissão).</div>
                    </div>
                  </div>
                </div>
                <div class="col-4">
                  <div class="inline">
                    <div class="switch" id="switchSMS" role="switch" aria-checked="false"><i></i></div>
                    <div>
                      <div><strong>SMS</strong></div>
                      <div class="hint">Alertas críticos por SMS.</div>
                    </div>
                  </div>
                </div>

                <div class="col-6">
                  <label for="quietStart">Modo silêncio — Início</label>
                  <input id="quietStart" class="input" type="time" />
                </div>
                <div class="col-6">
                  <label for="quietEnd">Modo silêncio — Fim</label>
                  <input id="quietEnd" class="input" type="time" />
                </div>
              </div>
              <div class="divider"></div>
              <div class="inline">
                <button id="btnTestNotif" class="btn">Enviar teste</button>
                <span class="hint">Simulação local. Para push real, habilite permissões do navegador.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Integrações -->
        <div class="section" id="sec-integracoes" role="region" aria-labelledby="integracoes">
          <div class="card">
            <div class="hd">
              <h2>Webhooks</h2>
              <button id="btnSendTestWebhook" class="btn-ghost">Enviar teste</button>
            </div>
            <div class="bd">
              <div class="row">
                <div class="col-8">
                  <label for="whUrl">URL do webhook</label>
                  <input id="whUrl" class="input" placeholder="https://api.sua-empresa.com/webhooks/facil" />
                </div>
                <div class="col-4">
                  <label for="whSecret">Assinatura (secret)</label>
                  <input id="whSecret" class="input" placeholder="••••••••••••••" />
                </div>
                <div class="col-12">
                  <label>Eventos</label>
                  <div class="inline">
                    <label class="pill"><input type="checkbox" id="whEvt_bet_created"> bet.created</label>
                    <label class="pill"><input type="checkbox" id="whEvt_bet_paid"> bet.paid</label>
                    <label class="pill"><input type="checkbox" id="whEvt_bet_canceled"> bet.canceled</label>
                    <label class="pill"><input type="checkbox" id="whEvt_campaign_updated"> campaign.updated</label>
                  </div>
                </div>
              </div>
              <div class="divider"></div>
              <div class="hint">Assinamos o corpo com HMAC SHA-256 usando o secret na header X-Facil-Signature (simulado).</div>
            </div>
          </div>

          <div class="card">
            <div class="hd">
              <h2>API Keys</h2>
              <button id="btnNewKey" class="btn">Gerar nova chave</button>
            </div>
            <div class="bd">
              <table class="tbl" aria-label="Chaves de API">
                <thead>
                  <tr><th>Nome</th><th>Prefixo</th><th>Criada em</th><th>Status</th><th>Ações</th></tr>
                </thead>
                <tbody id="keysBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Pagamentos -->
        <div class="section" id="sec-pagamentos" role="region" aria-labelledby="pagamentos">
          <div class="card">
            <div class="hd"><h2>Métodos de Pagamento e Saque</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-6">
                  <h3 style="margin:0 0 8px">Pix</h3>
                  <label for="pixKey">Chave Pix</label>
                  <input id="pixKey" class="input" placeholder="email, CPF/CNPJ, telefone ou chave aleatória" />
                  <div class="hint">Validaremos o formato antes do uso.</div>
                </div>
                <div class="col-6">
                  <h3 style="margin:0 0 8px">Conta Bancária</h3>
                  <div class="row">
                    <div class="col-6">
                      <label for="bankName">Banco</label>
                      <input id="bankName" class="input" placeholder="Ex.: Itaú" />
                    </div>
                    <div class="col-3">
                      <label for="bankAg">Agência</label>
                      <input id="bankAg" class="input" placeholder="0000" />
                    </div>
                    <div class="col-3">
                      <label for="bankCc">Conta</label>
                      <input id="bankCc" class="input" placeholder="00000-0" />
                    </div>
                    <div class="col-6">
                      <label for="bankType">Tipo</label>
                      <select id="bankType" class="select">
                        <option value="corrente">Corrente</option>
                        <option value="poupanca">Poupança</option>
                        <option value="pagamento">Pagamento</option>
                      </select>
                    </div>
                    <div class="col-6">
                      <label for="bankHolder">Titular</label>
                      <input id="bankHolder" class="input" placeholder="Nome do titular" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="divider"></div>
              <div class="inline">
                <button id="btnSavePayments" class="btn">Salvar métodos</button>
                <span class="hint">Dados armazenados localmente (simulação).</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Equipe -->
        <div class="section" id="sec-equipe" role="region" aria-labelledby="equipe">
          <div class="card">
            <div class="hd"><h2>Equipe e Acesso</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-6">
                  <label for="memberEmail">Convidar por email</label>
                  <div class="inline">
                    <input id="memberEmail" class="input" placeholder="membro@empresa.com" />
                    <select id="memberRole" class="select">
                      <option value="admin">Admin</option>
                      <option value="operator">Operador</option>
                      <option value="reader">Leitor</option>
                    </select>
                    <button id="btnInviteMember" class="btn">Enviar convite</button>
                  </div>
                  <div class="hint">O membro receberá um link de acesso (simulado) com validade de 7 dias.</div>
                </div>
              </div>
              <div class="divider"></div>
              <table class="tbl" aria-label="Membros">
                <thead>
                  <tr><th>Nome</th><th>Email</th><th>Perfil</th><th>Status</th><th>Ações</th></tr>
                </thead>
                <tbody id="teamBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Dados e Privacidade -->
        <div class="section" id="sec-dados" role="region" aria-labelledby="dados">
          <div class="card">
            <div class="hd"><h2>Exportar / Importar</h2></div>
            <div class="bd">
              <div class="inline">
                <button id="btnExport2" class="btn-ghost">Exportar backup (.json)</button>
                <label class="btn-ghost" for="fileImport2" style="cursor:pointer">Importar backup</label>
                <input id="fileImport2" type="file" accept="application/json" class="hidden" />
              </div>
              <div class="hint">Inclui: configurações, integrações, equipe e preferências locais.</div>
            </div>
          </div>
          <div class="card">
            <div class="hd"><h2>Privacidade</h2></div>
            <div class="bd">
              <div class="row">
                <div class="col-12">
                  <div class="inline">
                    <div class="switch" id="switchDataMin" role="switch" aria-checked="false"><i></i></div>
                    <div>
                      <div><strong>Minimização de dados</strong></div>
                      <div class="hint">Coletar apenas metadados essenciais (simulado).</div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <label for="dataNotes">Notas/Observações</label>
                  <textarea id="dataNotes" class="textarea" placeholder="Ex.: Não usar meu email para marketing."></textarea>
                </div>
              </div>
              <div class="divider"></div>
              <div class="inline">
                <button id="btnErase" class="btn-warn">Solicitar exclusão de dados</button>
                <button id="btnDownloadMyData" class="btn">Baixar meus dados</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="hd"><h2>Zona de Perigo</h2></div>
            <div class="bd">
              <div class="inline" style="justify-content:space-between">
                <div>
                  <div class="danger"><strong>Redefinir todas as configurações</strong></div>
                  <div class="hint">Isto limpará dados locais desta aplicação.</div>
                </div>
                <button id="btnDangerReset" class="btn-warn">Redefinir agora</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Sessão -->
        <div class="section" id="sec-sessao" role="region" aria-labelledby="sessao">
          <div class="card">
            <div class="hd">
              <h2>Sessões Ativas</h2>
              <button id="btnRevokeAll" class="btn-ghost">Encerrar todas</button>
            </div>
            <div class="bd">
              <table class="tbl" aria-label="Sessões">
                <thead>
                  <tr><th>Dispositivo</th><th>IP</th><th>Login</th><th>Último uso</th><th>Status</th><th>Ações</th></tr>
                </thead>
                <tbody id="sessionsBody"></tbody>
              </table>
              <div class="divider"></div>
              <div class="inline">
                <button id="btnSignOut" class="btn">Sair deste dispositivo</button>
                <span class="hint">Sugestão: ative 2FA para mais segurança.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Auditoria -->
        <div class="section" id="sec-auditoria" role="region" aria-labelledby="auditoria">
          <div class="card">
            <div class="hd"><h2>Registro de Auditoria</h2></div>
            <div class="bd">
              <table class="tbl" aria-label="Log de auditoria">
                <thead>
                  <tr><th>Quando</th><th>Ação</th><th>Detalhes</th></tr>
                </thead>
                <tbody id="auditBody"></tbody>
              </table>
              <div class="divider"></div>
              <button id="btnAuditClear" class="btn-ghost">Limpar log</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="spacer"></div>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast hidden" role="status" aria-live="polite">
    <div>
      <div class="t-title" id="toastTitle">Título</div>
      <div id="toastMsg" class="subtle">Mensagem</div>
    </div>
    <div class="t-actions">
      <button id="toastClose" class="btn-ghost">Fechar</button>
    </div>
  </div>

  <!-- Modal (genérico) -->
  <div id="modalMask" class="modal-mask hidden" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <div class="mhd">
        <div id="modalTitle" style="font-weight:700">Confirmação</div>
        <button id="modalClose" class="btn-ghost" aria-label="Fechar">✕</button>
      </div>
      <div class="mbd" id="modalBody">—</div>
      <div class="mft">
        <button id="modalCancel" class="btn-ghost">Cancelar</button>
        <button id="modalOk" class="btn">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      // Utils
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const sleep = ms => new Promise(r=>setTimeout(r, ms));
      const fmtDateTime = ts => {
        const d = new Date(ts);
        return d.toLocaleString(undefined, { hour12:false });
      };
      const uid = (p="") => p + Math.random().toString(36).slice(2,8) + Math.random().toString(36).slice(2,8);
      const copyToClipboard = async (text) => {
        try{ await navigator.clipboard.writeText(text); toast("Copiado!", "Texto copiado para a área de transferência.", "ok"); }
        catch{ toast("Falha ao copiar", "Selecione e copie manualmente.", "warn"); }
      };
      const pickTheme = (pref) => {
        if (pref === "light") return "light";
        if (pref === "dark") return "dark";
        // system
        return window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark";
      };
      function setTheme(mode){
        document.documentElement.dataset.theme = mode;
      }

      // Toast
      let toastTO;
      function toast(title, msg, type="ok", timeout=3200){
        const el = $("#toast");
        $("#toastTitle").textContent = title;
        $("#toastMsg").textContent = msg;
        el.className = "toast " + type;
        el.classList.remove("hidden");
        clearTimeout(toastTO);
        toastTO = setTimeout(()=> el.classList.add("hidden"), timeout);
      }
      $("#toastClose").addEventListener("click", ()=> $("#toast").classList.add("hidden"));

      // Modal
      function confirmModal({title="Confirmação", body="Deseja continuar?", okText="Confirmar", cancelText="Cancelar"}){
        return new Promise(resolve=>{
          $("#modalTitle").textContent = title;
          $("#modalBody").innerHTML = body;
          $("#modalOk").textContent = okText;
          $("#modalCancel").textContent = cancelText;
          $("#modalMask").classList.remove("hidden");
          const cleanup = () => {
            $("#modalMask").classList.add("hidden");
            $("#modalOk").onclick = null;
            $("#modalCancel").onclick = null;
            $("#modalClose").onclick = null;
          };
          $("#modalOk").onclick = ()=>{ cleanup(); resolve(true); };
          $("#modalCancel").onclick = ()=>{ cleanup(); resolve(false); };
          $("#modalClose").onclick = ()=>{ cleanup(); resolve(false); };
        });
      }

      // Auth (simples)
      function requireAuth(){
        const token = localStorage.getItem("facil_auth_token");
        if (!token){
          toast("Login necessário", "Acesse sua conta para abrir as configurações.", "warn", 4200);
          // Em apps reais, redirecione:
          // location.href = "./6-login.html";
          return true; // mantemos aberto para demo
        }
        return true;
      }

      // Storage Keys
      const K = {
        settings: "facil_settings",
        profile: "facil_profile",
        webhooks: "facil_webhooks",
        keys: "facil_api_keys",
        payouts: "facil_payouts",
        team: "facil_team",
        audit: "facil_audit",
        sessions: "facil_sessions"
      };

      // State defaults
      const DEFAULTS = {
        profile: {
          id: uid("usr_"),
          name:"",
          email:"",
          phone:"",
          doc:"",
          avatar:"",
          tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "America/Sao_Paulo",
          lang: "pt-BR"
        },
        settings: {
          theme: "system",
          currency: "BRL",
          odds: "decimal",
          numberFmt: "pt-BR",
          dateFmt: "dd/MM/yyyy",
          quickBet: false,
          autoCashout: false,
          defaultStake: 10,
          cashoutThreshold: 50,
          deviceLock: false,
          notif: { email:true, push:false, sms:false, quietStart:"", quietEnd:"" },
          privacy: { dataMin:false, notes:"" },
          twofa: { enabled:false, secret:"" }
        },
        webhooks: {
          url:"",
          secret:"",
          events: { bet_created:false, bet_paid:false, bet_canceled:false, campaign_updated:false }
        },
        payouts: {
          pixKey:"",
          bank: { name:"", ag:"", cc:"", type:"corrente", holder:"" }
        },
        team: [],
        keys: [],
        sessions: []
      };

      // In-memory state
      const S = {
        profile: {},
        settings: {},
        webhooks: {},
        payouts: {},
        team: [],
        keys: [],
        sessions: [],
        audit: []
      };

      // Persistence
      function loadAll(){
        S.profile = JSON.parse(localStorage.getItem(K.profile) || "null") || structuredClone(DEFAULTS.profile);
        S.settings = JSON.parse(localStorage.getItem(K.settings) || "null") || structuredClone(DEFAULTS.settings);
        S.webhooks = JSON.parse(localStorage.getItem(K.webhooks) || "null") || structuredClone(DEFAULTS.webhooks);
        S.payouts = JSON.parse(localStorage.getItem(K.payouts) || "null") || structuredClone(DEFAULTS.payouts);
        S.team = JSON.parse(localStorage.getItem(K.team) || "null") || structuredClone(DEFAULTS.team);
        S.keys = JSON.parse(localStorage.getItem(K.keys) || "null") || structuredClone(DEFAULTS.keys);
        S.sessions = JSON.parse(localStorage.getItem(K.sessions) || "null") || structuredClone(DEFAULTS.sessions);
        S.audit = JSON.parse(localStorage.getItem(K.audit) || "null") || [];
      }
      function saveProfile(){ localStorage.setItem(K.profile, JSON.stringify(S.profile)); audit("profile.updated", { name:S.profile.name, email:S.profile.email }); }
      function saveSettings(){ localStorage.setItem(K.settings, JSON.stringify(S.settings)); audit("settings.updated", {}); }
      function saveWebhooks(){ localStorage.setItem(K.webhooks, JSON.stringify(S.webhooks)); audit("webhooks.updated", { url:S.webhooks.url }); }
      function savePayouts(){ localStorage.setItem(K.payouts, JSON.stringify(S.payouts)); audit("payouts.updated", {}); }
      function saveTeam(){ localStorage.setItem(K.team, JSON.stringify(S.team)); audit("team.changed", { size:S.team.length }); }
      function saveKeys(){ localStorage.setItem(K.keys, JSON.stringify(S.keys)); audit("apikeys.changed", { count:S.keys.length }); }
      function saveSessions(){ localStorage.setItem(K.sessions, JSON.stringify(S.sessions)); }
      function audit(action, details){
        const rec = { at: Date.now(), action, details };
        S.audit.unshift(rec);
        localStorage.setItem(K.audit, JSON.stringify(S.audit.slice(0,400)));
        renderAudit();
      }

      // Sidebar nav
      function bindNav(){
        $$(".navbtn").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            $$(".navbtn").forEach(b=> b.classList.remove("active"));
            btn.classList.add("active");
            const target = btn.dataset.target;
            $$(".section").forEach(s=> s.classList.remove("active"));
            $("#sec-"+target).classList.add("active");
            // foco acessível
            $("#sec-"+target).setAttribute("tabindex","-1");
            $("#sec-"+target).focus({ preventScroll:true });
          });
        });
      }

      // Populate timezones
      function populateTZ(){
        const z = $("#timezone");
        const tzs = [
          "America/Araguaina","America/Bahia","America/Belem","America/Boa_Vista","America/Campo_Grande",
          "America/Cuiaba","America/Fortaleza","America/Maceio","America/Manaus","America/Porto_Velho",
          "America/Recife","America/Rio_Branco","America/Santarem","America/Sao_Paulo","America/Noronha",
          "UTC","America/Montevideo","America/Bogota","America/Mexico_City","Europe/Lisbon","Europe/Madrid"
        ];
        z.innerHTML = tzs.map(t=> `<option value="${t}">${t}</option>`).join("");
      }

      // Renderers
      function renderProfile(){
        $("#profileId").textContent = S.profile.id;
        if (S.profile.avatar){
          $("#avatar").style.backgroundImage = `url(${S.profile.avatar})`;
        } else {
          $("#avatar").style.backgroundImage = "";
        }
        $("#name").value = S.profile.name || "";
        $("#email").value = S.profile.email || "";
        $("#phone").value = S.profile.phone || "";
        $("#doc").value = S.profile.doc || "";
        $("#lang").value = S.profile.lang || "pt-BR";
        $("#timezone").value = S.profile.tz;
      }

      function renderSettings(){
        // Tema
        $("#theme").value = S.settings.theme || "system";
        setTheme(pickTheme(S.settings.theme));
        // Preferências
        $("#currency").value = S.settings.currency || "BRL";
        $("#odds").value = S.settings.odds || "decimal";
        $("#numberFmt").value = S.settings.numberFmt || "pt-BR";
        $("#dateFmt").value = S.settings.dateFmt || "dd/MM/yyyy";
        // Switches
        setSwitch("#switchQuickBet", S.settings.quickBet);
        setSwitch("#switchAutoCashout", S.settings.autoCashout);
        setSwitch("#switchDeviceLock", S.settings.deviceLock);
        $("#defaultStake").value = S.settings.defaultStake ?? 10;
        $("#cashoutThreshold").value = S.settings.cashoutThreshold ?? 50;
        // Notificações
        setSwitch("#switchEmail", S.settings.notif.email);
        setSwitch("#switchPush", S.settings.notif.push);
        setSwitch("#switchSMS", S.settings.notif.sms);
        $("#quietStart").value = S.settings.notif.quietStart || "";
        $("#quietEnd").value = S.settings.notif.quietEnd || "";
        // 2FA
        $("#twofaStatus").textContent = `Status: ${S.settings.twofa.enabled ? "Ativado" : "Desativado"}`;
        $("#btn2faDisable").disabled = !S.settings.twofa.enabled;
      }

      function renderWebhooks(){
        $("#whUrl").value = S.webhooks.url || "";
        $("#whSecret").value = S.webhooks.secret || "";
        $("#whEvt_bet_created").checked = !!S.webhooks.events.bet_created;
        $("#whEvt_bet_paid").checked = !!S.webhooks.events.bet_paid;
        $("#whEvt_bet_canceled").checked = !!S.webhooks.events.bet_canceled;
        $("#whEvt_campaign_updated").checked = !!S.webhooks.events.campaign_updated;
      }

      function renderKeys(){
        const body = $("#keysBody");
        body.innerHTML = "";
        if (!S.keys.length){
          body.innerHTML = `<tr><td colspan="5" class="subtle">Nenhuma chave gerada ainda.</td></tr>`;
          return;
        }
        for (const k of S.keys){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${k.name}</td>
            <td><span class="badge">${k.value.slice(0,4)}••••</span></td>
            <td>${fmtDateTime(k.created)}</td>
            <td>${k.active ? "Ativa" : "Revogada"}</td>
            <td class="inline">
              <button class="btn-ghost" data-act="copy">Copiar</button>
              <button class="btn-ghost" data-act="revoke">${k.active ? "Revogar" : "Reativar"}</button>
              <button class="btn-ghost" data-act="rename">Renomear</button>
            </td>
          `;
          tr.querySelector('[data-act="copy"]').addEventListener("click", ()=> copyToClipboard(k.value));
          tr.querySelector('[data-act="revoke"]').addEventListener("click", async ()=>{
            k.active = !k.active;
            saveKeys(); renderKeys();
            toast("Atualizado", `Chave ${k.active ? "reativada" : "revogada"}.`, "ok");
          });
          tr.querySelector('[data-act="rename"]').addEventListener("click", async ()=>{
            const name = prompt("Novo nome para a chave:", k.name);
            if (name){ k.name = name; saveKeys(); renderKeys(); }
          });
          body.appendChild(tr);
        }
      }

      function renderPayouts(){
        $("#pixKey").value = S.payouts.pixKey || "";
        $("#bankName").value = S.payouts.bank.name || "";
        $("#bankAg").value = S.payouts.bank.ag || "";
        $("#bankCc").value = S.payouts.bank.cc || "";
        $("#bankType").value = S.payouts.bank.type || "corrente";
        $("#bankHolder").value = S.payouts.bank.holder || "";
      }

      function renderTeam(){
        const body = $("#teamBody");
        body.innerHTML = "";
        if (!S.team.length){
          body.innerHTML = `<tr><td colspan="5" class="subtle">Nenhum membro na equipe.</td></tr>`;
          return;
        }
        for (const m of S.team){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.name || "—"}</td>
            <td>${m.email}</td>
            <td>
              <select class="select selRole">
                <option value="admin" ${m.role==="admin"?"selected":""}>Admin</option>
                <option value="operator" ${m.role==="operator"?"selected":""}>Operador</option>
                <option value="reader" ${m.role==="reader"?"selected":""}>Leitor</option>
              </select>
            </td>
            <td>${m.active ? "Ativo" : "Inativo"}</td>
            <td class="inline">
              <button class="btn-ghost" data-act="toggle">${m.active ? "Desativar" : "Ativar"}</button>
              <button class="btn-ghost" data-act="reset">Resetar convite</button>
              <button class="btn-ghost danger" data-act="remove">Remover</button>
            </td>
          `;
          tr.querySelector(".selRole").addEventListener("change", (e)=>{
            m.role = e.target.value; saveTeam(); toast("Perfil alterado", `${m.email} agora é ${m.role}.`,"ok");
          });
          tr.querySelector('[data-act="toggle"]').addEventListener("click", ()=>{
            m.active = !m.active; saveTeam(); renderTeam();
          });
          tr.querySelector('[data-act="reset"]').addEventListener("click", ()=>{
            m.invite = uid("inv_"); saveTeam(); toast("Convite resetado", `Novo código: ${m.invite}`, "ok");
          });
          tr.querySelector('[data-act="remove"]').addEventListener("click", async ()=>{
            const ok = await confirmModal({ title:"Remover membro", body:`Remover <b>${m.email}</b> da equipe?`, okText:"Remover" });
            if (ok){ S.team = S.team.filter(x=> x.id !== m.id); saveTeam(); renderTeam(); }
          });
          body.appendChild(tr);
        }
      }

      function renderSessions(){
        const body = $("#sessionsBody");
        body.innerHTML = "";
        if (!S.sessions.length){
          body.innerHTML = `<tr><td colspan="6" class="subtle">Nenhuma sessão encontrada.</td></tr>`;
          return;
        }
        for (const s of S.sessions){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.uaShort}</td>
            <td>${s.ip || "—"}</td>
            <td>${fmtDateTime(s.loginAt)}</td>
            <td>${fmtDateTime(s.lastSeen)}</td>
            <td>${s.active ? "Ativa" : "Encerrada"}</td>
            <td><button class="btn-ghost" data-act="revoke">${s.active ? "Encerrar" : "Remover"}</button></td>
          `;
          tr.querySelector('[data-act="revoke"]').addEventListener("click", ()=>{
            if (s.active){ s.active=false; s.lastSeen = Date.now(); }
            else { S.sessions = S.sessions.filter(x=> x.id !== s.id); }
            saveSessions(); renderSessions();
          });
          body.appendChild(tr);
        }
      }

      function renderAudit(){
        const body = $("#auditBody");
        if (!body) return;
        body.innerHTML = "";
        if (!S.audit.length){
          body.innerHTML = `<tr><td colspan="3" class="subtle">Sem eventos registrados.</td></tr>`;
          return;
        }
        for (const a of S.audit.slice(0,200)){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fmtDateTime(a.at)}</td>
            <td>${a.action}</td>
            <td><pre class="code" style="margin:0">${JSON.stringify(a.details || {}, null, 2)}</pre></td>
          `;
          body.appendChild(tr);
        }
      }

      // Switch helper
      function setSwitch(sel, on){
        const el = $(sel);
        if (!el) return;
        el.classList.toggle("on", !!on);
        el.setAttribute("aria-checked", !!on);
      }
      function bindSwitch(sel, getter, setter){
        const el = $(sel);
        el.addEventListener("click", ()=>{
          const nv = !el.classList.contains("on");
          setSwitch(sel, nv); setter(nv); saveSettings();
        });
      }

      // Validators
      const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const urlRe = /^https?:\/\/[^\s]+$/i;
      function isPixKeyValid(v){
        if (!v) return true; // opcional
        const email = emailRe.test(v);
        const phone = /^\+?\d{10,15}$/.test(v) || /^\(\d{2}\)\s?\d{4,5}-\d{4}$/.test(v);
        const cpf = /^\d{3}\.\d{3}\.\d{3}-\d{2}$/.test(v) || /^\d{11}$/.test(v);
        const cnpj = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/.test(v) || /^\d{14}$/.test(v);
        const rand = /^[a-f0-9-]{20,}$/.test(v);
        return email || phone || cpf || cnpj || rand;
      }

      // File helpers
      function download(filename, text){
        const a = document.createElement("a");
        a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }
      function readFileAsText(file){
        return new Promise((resolve,reject)=>{
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = reject;
          fr.readAsText(file);
        });
      }

      // 2FA helpers (simulado)
      function randomBase32(len=32){
        const alpha = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
        let out = "";
        for (let i=0;i<len;i++) out += alpha[Math.floor(Math.random()*alpha.length)];
        return out;
      }

      // Bindings
      function bindPerfil(){
        $("#btnCopyId").addEventListener("click", ()=> copyToClipboard(S.profile.id));
        $("#name").addEventListener("input", e=> S.profile.name = e.target.value);
        $("#email").addEventListener("input", e=> S.profile.email = e.target.value);
        $("#phone").addEventListener("input", e=> S.profile.phone = e.target.value);
        $("#doc").addEventListener("input", e=> S.profile.doc = e.target.value);
        $("#lang").addEventListener("change", e=> S.profile.lang = e.target.value);
        $("#timezone").addEventListener("change", e=> S.profile.tz = e.target.value);
        $("#btnSavePerfil").addEventListener("click", ()=>{
          if (S.profile.email && !emailRe.test(S.profile.email)){
            toast("Email inválido", "Verifique o formato do email.", "warn"); return;
          }
          saveProfile(); toast("Perfil salvo", "Dados atualizados com sucesso.", "ok");
        });

        // Avatar
        $("#fileAvatar").addEventListener("change", async (e)=>{
          const f = e.target.files[0];
          if (!f) return;
          if (f.size > 2*1024*1024){ toast("Arquivo grande", "Tamanho máximo 2MB.", "warn"); return; }
          const src = await readFileAsText(f); // melhor seria readAsDataURL
        });
        // Usar dataURL:
        $("#fileAvatar").addEventListener("change", async (e)=>{
          const f = e.target.files[0];
          if (!f) return;
          if (f.size > 2*1024*1024){ toast("Arquivo grande", "Tamanho máximo 2MB.", "warn"); return; }
          const fr = new FileReader();
          fr.onload = () => {
            S.profile.avatar = fr.result;
            saveProfile();
            renderProfile();
            toast("Avatar atualizado","", "ok");
          };
          fr.readAsDataURL(f);
        });
        $("#btnAvatarClear").addEventListener("click", ()=>{
          S.profile.avatar = ""; saveProfile(); renderProfile();
        });
      }

      function bindSeguranca(){
        // Meter
        const meter = $("#pwdMeter");
        $("#pwdNew").addEventListener("input", e=>{
          const v = e.target.value;
          let score = 0;
          if (v.length >= 12) score++;
          if (/[A-Z]/.test(v)) score++;
          if (/[a-z]/.test(v)) score++;
          if (/\d/.test(v)) score++;
          if (/[^A-Za-z0-9]/.test(v)) score++;
          const labels = ["Muito fraca","Fraca","Média","Forte","Excelente"];
          meter.textContent = "Força: " + (labels[score-1] || "—");
        });
        $("#btnChangePwd").addEventListener("click", ()=>{
          const a = $("#pwdCurrent").value, b = $("#pwdNew").value, c = $("#pwdNew2").value;
          if (!b || b !== c){ toast("Atenção", "Confirmação de senha não confere.", "warn"); return; }
          if (b.length < 12){ toast("Senha fraca", "Use ao menos 12 caracteres.", "warn"); return; }
          // Simulação: não validamos senha atual; apenas registramos auditoria
          audit("password.changed", {});
          $("#pwdCurrent").value = $("#pwdNew").value = $("#pwdNew2").value = "";
          toast("Senha atualizada", "Sua senha foi definida.", "ok");
        });

        // 2FA
        $("#btn2faSetup").addEventListener("click", ()=>{
          const secret = randomBase32(32);
          const label = encodeURIComponent(S.profile.email || "usuario@facil");
          const issuer = encodeURIComponent("Facil");
          const uri = `otpauth://totp/${issuer}:${label}?secret=${secret}&issuer=${issuer}&digits=6&period=30&algorithm=SHA1`;
          $("#twofaSecret").value = secret;
          $("#twofaUri").value = uri;
          $("#twofaBlock").classList.remove("hidden");
        });
        $("#btnCopy2FA").addEventListener("click", ()=> copyToClipboard($("#twofaSecret").value));
        $("#btn2faVerify").addEventListener("click", ()=>{
          const code = $("#twofaCode").value.trim();
          if (!/^\d{6}$/.test(code)){ toast("Código inválido","Informe 6 dígitos.","warn"); return; }
          // Simulação: ativamos sem validar contra TOTP real
          S.settings.twofa.enabled = true;
          S.settings.twofa.secret = $("#twofaSecret").value;
          saveSettings();
          $("#twofaStatus").textContent = "Status: Ativado";
          $("#btn2faDisable").disabled = false;
          $("#twofaBlock").classList.add("hidden");
          $("#twofaCode").value = "";
          toast("2FA ativado","Guarde sua chave em local seguro.","ok");
        });
        $("#btn2faDisable").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Desativar 2FA", body:"Você tem certeza que deseja desativar o 2FA?", okText:"Desativar" });
          if (!ok) return;
          S.settings.twofa.enabled = false;
          S.settings.twofa.secret = "";
          saveSettings();
          $("#twofaStatus").textContent = "Status: Desativado";
          $("#btn2faDisable").disabled = true;
          toast("2FA desativado","", "ok");
        });

        // Device lock
        bindSwitch("#switchDeviceLock", ()=> S.settings.deviceLock, v=> S.settings.deviceLock = v);
      }

      function bindPreferencias(){
        $("#theme").addEventListener("change", (e)=>{ S.settings.theme = e.target.value; saveSettings(); setTheme(pickTheme(S.settings.theme)); });
        $("#currency").addEventListener("change", (e)=>{ S.settings.currency = e.target.value; saveSettings(); });
        $("#odds").addEventListener("change", (e)=>{ S.settings.odds = e.target.value; saveSettings(); });
        $("#numberFmt").addEventListener("change", (e)=>{ S.settings.numberFmt = e.target.value; saveSettings(); });
        $("#dateFmt").addEventListener("change", (e)=>{ S.settings.dateFmt = e.target.value; saveSettings(); });

        bindSwitch("#switchQuickBet", ()=> S.settings.quickBet, v=> S.settings.quickBet = v);
        bindSwitch("#switchAutoCashout", ()=> S.settings.autoCashout, v=> S.settings.autoCashout = v);

        $("#defaultStake").addEventListener("change", (e)=>{ S.settings.defaultStake = Math.max(0, Number(e.target.value||0)); saveSettings(); });
        $("#cashoutThreshold").addEventListener("change", (e)=>{
          let v = Number(e.target.value||0);
          v = Math.min(100, Math.max(1, v));
          S.settings.cashoutThreshold = v; e.target.value = v; saveSettings();
        });
      }

      function bindNotificacoes(){
        bindSwitch("#switchEmail", ()=> S.settings.notif.email, v=> S.settings.notif.email = v);
        bindSwitch("#switchPush", ()=> S.settings.notif.push, async v=>{
          if (v && Notification && Notification.permission !== "granted"){
            try{
              const perm = await Notification.requestPermission();
              if (perm !== "granted"){ toast("Permissão negada","Não foi possível ativar push.","warn"); setSwitch("#switchPush", false); return; }
            }catch{}
          }
          S.settings.notif.push = v;
        });
        bindSwitch("#switchSMS", ()=> S.settings.notif.sms, v=> S.settings.notif.sms = v);
        $("#quietStart").addEventListener("change", e=> S.settings.notif.quietStart = e.target.value);
        $("#quietEnd").addEventListener("change", e=> S.settings.notif.quietEnd = e.target.value);
        $("#btnTestNotif").addEventListener("click", ()=>{
          toast("Teste de notificação", "Isto é apenas uma simulação local.", "ok");
          audit("notif.test", {});
        });
      }

      function bindIntegracoes(){
        $("#whUrl").addEventListener("input", e=> S.webhooks.url = e.target.value);
        $("#whSecret").addEventListener("input", e=> S.webhooks.secret = e.target.value);
        $("#whEvt_bet_created").addEventListener("change", e=> S.webhooks.events.bet_created = e.target.checked);
        $("#whEvt_bet_paid").addEventListener("change", e=> S.webhooks.events.bet_paid = e.target.checked);
        $("#whEvt_bet_canceled").addEventListener("change", e=> S.webhooks.events.bet_canceled = e.target.checked);
        $("#whEvt_campaign_updated").addEventListener("change", e=> S.webhooks.events.campaign_updated = e.target.checked);
        $("#btnSendTestWebhook").addEventListener("click", async ()=>{
          if (!S.webhooks.url || !urlRe.test(S.webhooks.url)){ toast("URL inválida","Informe uma URL http(s) válida.","warn"); return; }
          toast("Enviando...", "Simulando POST /webhook", "ok", 1800);
          await sleep(500);
          // Simulado
          audit("webhook.test", { url:S.webhooks.url, ok:true });
          toast("Teste enviado", "Cheque seus logs do receptor.", "ok");
        });
        $("#btnNewKey").addEventListener("click", ()=>{
          const name = prompt("Nome da chave:", "Chave " + (S.keys.length+1));
          if (!name) return;
          const key = "facil_" + uid() + uid();
          S.keys.unshift({ id: uid("key_"), name, value:key, created: Date.now(), active:true });
          saveKeys(); renderKeys();
          copyToClipboard(key);
        });
      }

      function bindPagamentos(){
        $("#btnSavePayments").addEventListener("click", ()=>{
          const pix = $("#pixKey").value.trim();
          if (pix && !isPixKeyValid(pix)){ toast("Chave Pix inválida","Verifique o formato informado.","warn"); return; }
          S.payouts.pixKey = pix;
          S.payouts.bank.name = $("#bankName").value.trim();
          S.payouts.bank.ag = $("#bankAg").value.trim();
          S.payouts.bank.cc = $("#bankCc").value.trim();
          S.payouts.bank.type = $("#bankType").value;
          S.payouts.bank.holder = $("#bankHolder").value.trim();
          savePayouts();
          toast("Métodos salvos","", "ok");
        });
      }

      function bindEquipe(){
        $("#btnInviteMember").addEventListener("click", ()=>{
          const email = $("#memberEmail").value.trim();
          if (!emailRe.test(email)){ toast("Email inválido","Digite um email válido.","warn"); return; }
          const role = $("#memberRole").value;
          const m = { id: uid("mem_"), email, role, name:"", active:true, invite: uid("inv_") };
          S.team.unshift(m);
          saveTeam(); renderTeam();
          $("#memberEmail").value = "";
          toast("Convite enviado", `Convite criado para ${email}.`, "ok");
        });
      }

      function bindDados(){
        const doExport = ()=>{
          const dump = {
            profile: S.profile, settings:S.settings, webhooks:S.webhooks, payouts:S.payouts, team:S.team, keys:S.keys, sessions:S.sessions, audit:S.audit
          };
          download("facil-backup-"+new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")+".json", JSON.stringify(dump, null, 2));
          audit("backup.exported", {});
        };
        $("#btnExport").addEventListener("click", doExport);
        $("#btnExport2").addEventListener("click", doExport);

        async function doImport(file){
          try{
            const txt = await readFileAsText(file);
            const data = JSON.parse(txt);
            if (!data || typeof data !== "object") throw new Error("JSON inválido");
            // Merge básico
            if (data.profile) { S.profile = data.profile; localStorage.setItem(K.profile, JSON.stringify(S.profile)); }
            if (data.settings){ S.settings = data.settings; localStorage.setItem(K.settings, JSON.stringify(S.settings)); }
            if (data.webhooks){ S.webhooks = data.webhooks; localStorage.setItem(K.webhooks, JSON.stringify(S.webhooks)); }
            if (data.payouts){ S.payouts = data.payouts; localStorage.setItem(K.payouts, JSON.stringify(S.payouts)); }
            if (Array.isArray(data.team)){ S.team = data.team; localStorage.setItem(K.team, JSON.stringify(S.team)); }
            if (Array.isArray(data.keys)){ S.keys = data.keys; localStorage.setItem(K.keys, JSON.stringify(S.keys)); }
            if (Array.isArray(data.sessions)){ S.sessions = data.sessions; localStorage.setItem(K.sessions, JSON.stringify(S.sessions)); }
            if (Array.isArray(data.audit)){ S.audit = data.audit; localStorage.setItem(K.audit, JSON.stringify(S.audit)); }
            renderAll();
            toast("Importado", "Backup importado com sucesso.", "ok");
            audit("backup.imported", { keys:S.keys.length, team:S.team.length });
          }catch(e){
            console.error(e);
            toast("Falha ao importar","Verifique o arquivo JSON.","err");
          }
        }
        $("#fileImport").addEventListener("change", e=> e.target.files[0] && doImport(e.target.files[0]));
        $("#fileImport2").addEventListener("change", e=> e.target.files[0] && doImport(e.target.files[0]));

        $("#btnReset").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Restaurar padrão", body:"Isto irá redefinir várias preferências para o padrão. Continuar?", okText:"Restaurar" });
          if (!ok) return;
          S.settings = structuredClone(DEFAULTS.settings);
          saveSettings(); renderSettings();
          toast("Preferências restauradas","", "ok");
        });

        $("#btnDangerReset").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Redefinir aplicação", body:"Esta ação limpará todos os dados locais desta aplicação (perfil, chaves, equipe, sessões etc.). Deseja prosseguir?", okText:"Redefinir" });
          if (!ok) return;
          Object.values(K).forEach(k=> localStorage.removeItem(k));
          loadAll(); renderAll();
          toast("Aplicação redefinida","Dados locais foram limpos.", "ok");
        });

        $("#btnErase").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Exclusão de dados", body:"Sua solicitação será registrada no log e processada manualmente (simulado). Confirmar?", okText:"Solicitar" });
          if (!ok) return;
          audit("privacy.erase.requested", { id:S.profile.id, email:S.profile.email });
          toast("Solicitação registrada","Nossa equipe entrará em contato (simulado).","ok");
        });

        $("#btnDownloadMyData").addEventListener("click", ()=>{
          const mine = { profile:S.profile, settings:S.settings, payouts:S.payouts, sessions:S.sessions };
          download("meus-dados-facil.json", JSON.stringify(mine, null, 2));
          audit("privacy.data.downloaded", { size: Object.keys(mine).length });
        });
      }

      function bindSessao(){
        // seed a sessão atual se vazio
        if (!S.sessions.length){
          S.sessions.push({
            id: uid("ses_"),
            ua: navigator.userAgent,
            uaShort: navigator.userAgent.split(") ").pop()?.split(" ").slice(0,2).join(" ") || "Este dispositivo",
            ip: "127.0.0.1",
            loginAt: Date.now() - 1000*60*60,
            lastSeen: Date.now(),
            active: true
          });
          saveSessions();
        }
        renderSessions();

        $("#btnRevokeAll").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Encerrar sessões", body:"Encerrar todas as sessões (exceto a atual)?", okText:"Encerrar" });
          if (!ok) return;
          const current = S.sessions[0]?.id;
          for (const s of S.sessions){
            if (s.id !== current) s.active = false;
          }
          saveSessions(); renderSessions();
          toast("Sessões encerradas","", "ok");
        });
        $("#btnSignOut").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Sair", body:"Deseja encerrar a sessão atual?", okText:"Sair" });
          if (!ok) return;
          // Simulação: apenas marca como inativa
          if (S.sessions[0]) S.sessions[0].active = false;
          saveSessions(); renderSessions();
          toast("Sessão encerrada","", "ok");
        });
      }

      function bindTopbar(){
        $("#btnTheme").addEventListener("click", ()=>{
          const cur = document.documentElement.dataset.theme || "dark";
          const next = cur === "dark" ? "light" : "dark";
          document.documentElement.dataset.theme = next;
          S.settings.theme = next; saveSettings();
        });
        $("#btnSaveAll").addEventListener("click", ()=>{
          saveProfile(); saveSettings(); saveWebhooks(); savePayouts(); saveTeam(); saveKeys(); saveSessions();
          toast("Tudo salvo", "Alterações persistidas localmente.", "ok");
        });
      }

      function renderAll(){
        populateTZ();
        renderProfile();
        renderSettings();
        renderWebhooks();
        renderKeys();
        renderPayouts();
        renderTeam();
        renderSessions();
        renderAudit();
      }

      // Keyboard a11y for sections
      function a11y(){
        $$(".section").forEach(s=> s.setAttribute("tabindex","-1"));
      }

      async function init(){
        requireAuth();
        loadAll();
        setTheme(pickTheme(S.settings.theme));
        bindNav();
        bindTopbar();
        bindPerfil();
        bindSeguranca();
        bindPreferencias();
        bindNotificacoes();
        bindIntegracoes();
        bindPagamentos();
        bindEquipe();
        bindDados();
        bindSessao();
        a11y();
        renderAll();

        // Env chip
        const chip = $("#envChip");
        chip.title = "Sessão autenticada (demo)";

        // Audit clear
        $("#btnAuditClear").addEventListener("click", async ()=>{
          const ok = await confirmModal({ title:"Limpar log", body:"Apagar entradas do log de auditoria (apenas local)?", okText:"Limpar" });
          if (!ok) return;
          S.audit = []; localStorage.setItem(K.audit, "[]"); renderAudit();
        });
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>