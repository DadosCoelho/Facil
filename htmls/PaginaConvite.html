<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facil — Página de Convite</title>
  <meta name="description" content="Convite individual para participar da campanha de apostas da Lotofácil da Independência na plataforma Facil." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b0c10;
      --bg-elev: #111217;
      --card: #14161d;
      --card-2: #191c24;
      --text: #e8edf2;
      --muted: #b9c1cb;
      --primary: #6ee7b7;
      --primary-600: #10b981;
      --danger: #ff6b6b;
      --warning: #fbbf24;
      --info: #60a5fa;
      --border: #2a2f39;
      --focus: #93c5fd;

      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --maxw: 1040px;

      --font-sans: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7fafc;
        --bg-elev: #ffffff;
        --card: #ffffff;
        --card-2: #f9fafb;
        --text: #0f172a;
        --muted: #475569;
        --primary: #059669;
        --primary-600: #047857;
        --danger: #dc2626;
        --warning: #d97706;
        --info: #2563eb;
        --border: #e5e7eb;
        --focus: #1d4ed8;
        --shadow: 0 8px 24px rgba(0,0,0,.10);
      }
    }

    html, body {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: var(--font-sans);
      background: linear-gradient(180deg, var(--bg) 0%, var(--bg-elev) 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      flex-direction: column;
    }

    .container {
      width: 100%;
      max-width: var(--maxw);
      margin-inline: auto;
      padding: 16px;
    }

    header.appbar {
      position: sticky;
      top: 0;
      backdrop-filter: saturate(180%) blur(10px);
      background: color-mix(in oklab, var(--bg), transparent 20%);
      border-bottom: 1px solid var(--border);
      z-index: 50;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text);
      font-weight: 700;
      letter-spacing: .3px;
    }
    .brand .logo {
      inline-size: 36px;
      block-size: 36px;
      border-radius: 10px;
      background: radial-gradient(120% 120% at 10% 10%, var(--primary) 0%, #22d3ee 35%, #6366f1 70%);
      display: inline-grid;
      place-items: center;
      color: #0b0c10;
      font-weight: 800;
      text-shadow: 0 1px 0 rgba(255,255,255,.25);
    }

    main {
      flex: 1;
      display: grid;
      place-items: center;
      padding-block: clamp(16px, 5vw, 48px);
    }

    .invite-card {
      width: min(920px, 100%);
      background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: clip;
    }

    .invite-header {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      padding: clamp(16px, 4vw, 28px);
      border-bottom: 1px dashed var(--border);
      background:
        radial-gradient(1000px 400px at 100% -10%, color-mix(in oklab, var(--primary) 25%, transparent) 0%, transparent 60%),
        linear-gradient(180deg, color-mix(in oklab, var(--card) 88%, transparent) 0%, transparent 100%);
    }

    .invite-title {
      font-size: clamp(1.2rem, 2vw, 1.6rem);
      line-height: 1.2;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: .85rem;
      color: var(--muted);
      background: color-mix(in oklab, var(--card-2), black 3%);
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 999px;
    }

    .invite-body {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      padding: clamp(16px, 4vw, 28px);
    }

    .status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in oklab, var(--card-2), black 4%);
    }
    .status-dot {
      inline-size: 10px;
      block-size: 10px;
      border-radius: 999px;
      background: var(--info);
      box-shadow: 0 0 0 6px color-mix(in oklab, var(--info), transparent 80%);
    }
    .status[data-variant="ok"] .status-dot { background: var(--primary-600); box-shadow: 0 0 0 6px color-mix(in oklab, var(--primary-600), transparent 80%); }
    .status[data-variant="warning"] .status-dot { background: var(--warning); box-shadow: 0 0 0 6px color-mix(in oklab, var(--warning), transparent 80%); }
    .status[data-variant="danger"] .status-dot { background: var(--danger); box-shadow: 0 0 0 6px color-mix(in oklab, var(--danger), transparent 80%); }
    .status-title {
      font-weight: 700;
    }
    .status-desc {
      color: var(--muted);
      font-size: .95rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 720px) {
      .grid-2 {
        grid-template-columns: 1.2fr .8fr;
      }
    }

    .panel {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: color-mix(in oklab, var(--card-2), black 2%);
      padding: 14px;
    }
    .panel h3 {
      margin: 0 0 8px 0;
      font-size: 1.05rem;
    }
    .meta {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin: 8px 0 0 0;
    }
    .meta-row {
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 8px;
      align-items: center;
      font-size: .95rem;
    }
    .meta-label {
      color: var(--muted);
    }
    .meta-value strong {
      font-weight: 700;
    }
    .muted {
      color: var(--muted);
      font-size: .95rem;
    }

    .terms {
      display: grid;
      gap: 10px;
      padding: 12px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: color-mix(in oklab, var(--card-2), black 1%);
    }
    .checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      line-height: 1.3;
    }
    .checkbox input {
      inline-size: 18px;
      block-size: 18px;
      margin-top: 2px;
      accent-color: var(--primary-600);
    }
    .checkbox a {
      color: var(--info);
      text-decoration: none;
    }
    .checkbox a:hover {
      text-decoration: underline;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 4px;
    }
    @media (min-width: 520px) {
      .actions {
        grid-template-columns: 1fr auto;
        align-items: center;
      }
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      padding: 12px 16px;
      font-weight: 700;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(180deg, color-mix(in oklab, var(--primary-600), white 8%) 0%, var(--primary-600) 100%);
      color: #0b0c10;
      box-shadow: 0 8px 22px color-mix(in oklab, var(--primary-600), transparent 80%);
    }
    .btn-primary:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 10px 32px color-mix(in oklab, var(--primary-600), transparent 70%);
    }
    .btn-secondary {
      background: color-mix(in oklab, var(--card-2), black 2%);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-link {
      background: transparent;
      color: var(--info);
      padding: 10px 0;
      border-radius: 8px;
    }

    .inline-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .alert {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: color-mix(in oklab, var(--card-2), black 3%);
      display: grid;
      gap: 6px;
    }
    .alert[data-variant="danger"] { border-color: color-mix(in oklab, var(--danger), var(--border) 60%); }
    .alert[data-variant="warning"] { border-color: color-mix(in oklab, var(--warning), var(--border) 60%); }

    .skeleton {
      display: inline-block;
      inline-size: 100%;
      block-size: 12px;
      border-radius: 6px;
      background: linear-gradient(90deg, color-mix(in oklab, var(--card-2), white 8%), color-mix(in oklab, var(--card-2), black 4%), color-mix(in oklab, var(--card-2), white 8%));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer {
      to { background-position: -200% 0; }
    }

    footer {
      border-top: 1px solid var(--border);
      color: var(--muted);
      text-align: center;
      padding: 16px;
      font-size: .9rem;
    }

    code.kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: .9em;
      background: color-mix(in oklab, var(--card-2), black 4%);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 2px 6px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <header class="appbar">
    <div class="container" style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <a href="/" class="brand" aria-label="Facil — voltar para a página inicial">
        <span class="logo" aria-hidden="true">F</span>
        <span>Facil</span>
      </a>
      <nav class="inline-actions" aria-label="Ações rápidas">
        <a class="btn-link" href="/termos">Termos</a>
        <a class="btn-link" href="/privacidade">Privacidade</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="invite-card" aria-labelledby="invite-title">
      <div class="invite-header">
        <h1 id="invite-title" class="invite-title">
          Convite para participar — Lotofácil da Independência
          <span class="chip" id="campaign-chip" aria-live="polite">Campanha: <strong style="margin-left:6px" id="campaignName">—</strong></span>
        </h1>
        <p class="muted" id="invite-subtitle">
          Você recebeu um link de acesso individual. Para continuar, aceite os termos e avance.
        </p>
      </div>

      <div class="invite-body">
        <!-- Status (carregando/ok/expirado/inválido/encerrado/usado) -->
        <div id="status" class="status" data-variant="warning" role="status" aria-live="polite">
          <span class="status-dot" aria-hidden="true"></span>
          <div>
            <div class="status-title" id="status-title">Validando seu convite…</div>
            <div class="status-desc" id="status-desc">Aguarde alguns instantes enquanto confirmamos as informações.</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="panel" aria-labelledby="dados-convite-title">
            <h3 id="dados-convite-title">Dados do convite</h3>
            <div class="meta" id="invite-meta">
              <div class="meta-row">
                <div class="meta-label">Participante</div>
                <div class="meta-value" id="meta-name"><span class="skeleton" style="max-width:180px"></span></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Email</div>
                <div class="meta-value" id="meta-email"><span class="skeleton" style="max-width:220px"></span></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Convite ID</div>
                <div class="meta-value" id="meta-invite-id"><span class="skeleton" style="max-width:140px"></span></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Campanha</div>
                <div class="meta-value" id="meta-campaign"><span class="skeleton" style="max-width:200px"></span></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Validade</div>
                <div class="meta-value" id="meta-exp"><span class="skeleton" style="max-width:160px"></span></div>
              </div>
            </div>

            <div class="terms" id="terms-block" hidden>
              <div class="checkbox">
                <input id="accept-terms" type="checkbox" aria-describedby="terms-desc" />
                <label for="accept-terms">
                  Declaro que li e aceito os
                  <a href="/termos"  rel="noopener">Termos de Uso</a>
                  e a
                  <a href="/privacidade"  rel="noopener">Política de Privacidade</a>.
                </label>
              </div>
              <p id="terms-desc" class="muted">
                O acesso é pessoal e intransferível. Este convite pode ter uso único e prazo de validade. Tentativas de uso indevido serão bloqueadas.
              </p>
            </div>
          </div>

          <div class="panel" aria-labelledby="acoes-title">
            <h3 id="acoes-title">Ações</h3>

            <div id="actions-ok" class="actions" hidden>
              <button id="proceed" class="btn btn-primary" disabled>Prosseguir para criar aposta</button>
              <div class="inline-actions">
                <button id="copyLink" class="btn btn-secondary" type="button">Copiar link</button>
                <a id="helpLink" class="btn-link" href="#" rel="noopener">Precisa de ajuda?</a>
              </div>
              <p class="muted">Ao prosseguir, você será direcionado para selecionar números e cotas. Seus jogos serão registrados automaticamente.</p>
            </div>

            <div id="actions-error" class="alert" data-variant="danger" hidden>
              <strong id="error-title">Convite inválido</strong>
              <span id="error-desc" class="muted">Este link não pôde ser validado.</span>
              <div class="inline-actions" style="margin-top:8px;">
                <a id="requestNewLink" class="btn btn-secondary" href="mailto:" rel="noopener">Solicitar novo link</a>
                <a class="btn-link" href="/">Voltar à página inicial</a>
              </div>
            </div>

            <div id="actions-expired" class="alert" data-variant="warning" hidden>
              <strong id="expired-title">Convite expirado</strong>
              <span id="expired-desc" class="muted">O prazo deste convite terminou.</span>
              <div class="inline-actions" style="margin-top:8px;">
                <a id="requestNewLink2" class="btn btn-secondary" href="mailto:" rel="noopener">Solicitar novo link</a>
                <a class="btn-link" href="/">Voltar à página inicial</a>
              </div>
            </div>

            <div id="actions-closed" class="alert" data-variant="warning" hidden>
              <strong>Campanha encerrada</strong>
              <span class="muted">Esta campanha não aceita mais novos jogos.</span>
              <a class="btn-link" href="/">Voltar à página inicial</a>
            </div>

            <div id="actions-used" class="alert" data-variant="warning" hidden>
              <strong>Convite já utilizado</strong>
              <span class="muted">Este convite foi marcado como utilizado.</span>
              <div class="inline-actions" style="margin-top:8px;">
                <a id="requestNewLink3" class="btn btn-secondary" href="mailto:" rel="noopener">Solicitar novo link</a>
                <a class="btn-link" href="/">Voltar à página inicial</a>
              </div>
            </div>

          </div>
        </div>

      </div>
    </section>
  </main>

  <footer>
    Facil © Todos os direitos reservados. A participação está sujeita aos Termos de Uso e regras da campanha.
  </footer>

  <script>
    // Configuração mínima para a página de Convite
    const CONFIG = {
      adminEmail: "admin@seudominio.com",                    // ajuste no deploy
      supportUrl: "mailto:admin@seudominio.com?subject=Ajuda%20com%20convite%20Facil",
      campaignFriendlyName: "Lotofácil da Independência",
      nextRoute: "/jogo",                                    // rota para criação da aposta
      validateEndpoint: "/api/invite/validate",              // endpoint recomendável (server) para validação robusta
      allowClientDecodeFallback: true                        // fallback para prever dados quando o backend não responder
    };

    // Utilidades
    function getQueryParam(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\$&");
      const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return "";
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function base64UrlToBase64(str) {
      // JWT usa base64url ( - _ ), convertemos para base64 tradicional
      str = str.replace(/-/g, "+").replace(/_/g, "/");
      const pad = str.length % 4;
      if (pad) {
        str += "=".repeat(4 - pad);
      }
      return str;
    }

    function decodeJwtPayload(token) {
      try {
        const parts = token.split(".");
        if (parts.length < 2) return null;
        const payload = parts[1];
        const json = atob(base64UrlToBase64(payload));
        return JSON.parse(json);
      } catch (e) {
        return null;
      }
    }

    function fmtDateTime(tsSec) {
      if (!tsSec) return "—";
      const d = new Date(tsSec * 1000);
      const opts = { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" };
      return new Intl.DateTimeFormat("pt-BR", opts).format(d);
    }

    function timeLeft(tsSec) {
      if (!tsSec) return "";
      const now = Math.floor(Date.now() / 1000);
      const diff = tsSec - now;
      if (diff <= 0) return "expirado";
      const hours = Math.floor(diff / 3600);
      const minutes = Math.floor((diff % 3600) / 60);
      if (hours > 0) return `${hours}h ${minutes.toString().padStart(2, "0")}min`;
      return `${minutes}min`;
    }

    function setStatus(variant, title, desc) {
      const status = document.getElementById("status");
      status.setAttribute("data-variant", variant);
      document.getElementById("status-title").textContent = title;
      document.getElementById("status-desc").textContent = desc;
    }

    function showBlock(id, show = true) {
      const el = document.getElementById(id);
      if (!el) return;
      el.hidden = !show;
    }

    function setMailToWithToken(elId, subjectPrefix, token) {
      const el = document.getElementById(elId);
      if (!el) return;
      const mail = CONFIG.adminEmail || "admin@seudominio.com";
      const subject = encodeURIComponent(`${subjectPrefix} — Invite ${token?.slice(0, 8) || "N/A"}`);
      const body = encodeURIComponent(`Olá, preciso de ajuda com meu convite.\n\nToken (parcial): ${token?.slice(0, 16) || "N/A"}...\nMensagem: `);
      el.href = `mailto:${mail}?subject=${subject}&body=${body}`;
    }

    // Elementos
    const $campaignName = document.getElementById("campaignName");
    const $metaName = document.getElementById("meta-name");
    const $metaEmail = document.getElementById("meta-email");
    const $metaInviteId = document.getElementById("meta-invite-id");
    const $metaCampaign = document.getElementById("meta-campaign");
    const $metaExp = document.getElementById("meta-exp");
    const $termsBlock = document.getElementById("terms-block");
    const $accept = document.getElementById("accept-terms");
    const $proceed = document.getElementById("proceed");
    const $copyLink = document.getElementById("copyLink");
    const $helpLink = document.getElementById("helpLink");

    // Inicialização
    (async function init() {
      $campaignName.textContent = CONFIG.campaignFriendlyName;

      const token = getQueryParam("invite");
      const hasToken = Boolean(token);

      // preencher mailto nos botões de erro
      setMailToWithToken("requestNewLink", "Solicitação de novo link Facil", token);
      setMailToWithToken("requestNewLink2", "Solicitação de novo link Facil", token);
      setMailToWithToken("requestNewLink3", "Solicitação de novo link Facil", token);

      if (!hasToken) {
        setStatus("danger", "Link ausente", "Este endereço não contém um parâmetro de convite válido.");
        showBlock("actions-error", true);
        document.getElementById("error-desc").textContent = "Parâmetro 'invite' não encontrado na URL.";
        return;
      }

      // Tenta validar no backend (recomendado)
      let serverResult = null;
      try {
        const res = await fetch(`${CONFIG.validateEndpoint}?token=${encodeURIComponent(token)}`, {
          method: "GET",
          headers: { "Accept": "application/json" },
          cache: "no-store"
        });
        if (res.ok) {
          serverResult = await res.json(); // esperado: { status, inviteId, campaign, email, name, exp, singleUse, campaignStatus }
        } else {
          // status úteis: 400 inválido, 410 expirado, 409 usado, 423 campanha fechada
          serverResult = { error: true, httpStatus: res.status };
        }
      } catch (e) {
        // fica em null e seguimos para fallback
      }

      // Fallback: decodificar JWT no cliente (sem assinatura)
      let payload = decodeJwtPayload(token) || {};
      // mapeamentos padrão (dependem do backend)
      const inviteId = payload.inviteId || payload.jti || payload.sub || "—";
      const name = payload.name || payload.given_name || payload.preferred_username || "Convidado";
      const email = payload.email || "—";
      const campaign = payload.campaignName || CONFIG.campaignFriendlyName;
      const exp = payload.exp || null;
      const singleUse = Boolean(payload.singleUse);

      // Preenche metadados
      $metaName.textContent = name;
      $metaEmail.textContent = email;
      $metaInviteId.textContent = String(inviteId);
      $metaCampaign.textContent = String(campaign);
      $metaExp.innerHTML = exp
        ? `<strong>${fmtDateTime(exp)}</strong> <span class="muted">(${timeLeft(exp)} restantes)</span>`
        : "—";

      // Lógica de estados combinando server + fallback
      let state = "ok"; // ok | invalid | expired | used | closed
      if (serverResult && !serverResult.error) {
        // servidor decide
        state = serverResult.status || "ok";
        // se o backend trouxe dados, preferir os dele
        if (serverResult.name) $metaName.textContent = serverResult.name;
        if (serverResult.email) $metaEmail.textContent = serverResult.email;
        if (serverResult.inviteId) $metaInviteId.textContent = serverResult.inviteId;
        if (serverResult.campaign) {
          $metaCampaign.textContent = serverResult.campaign;
          $campaignName.textContent = serverResult.campaign;
        }
        if (serverResult.exp) {
          $metaExp.innerHTML = `<strong>${fmtDateTime(serverResult.exp)}</strong> <span class="muted">(${timeLeft(serverResult.exp)} restantes)</span>`;
        }
      } else if (!serverResult && CONFIG.allowClientDecodeFallback) {
        // heurística cliente
        const now = Math.floor(Date.now() / 1000);
        if (!payload || Object.keys(payload).length === 0) state = "invalid";
        else if (exp && exp < now) state = "expired";
        else state = "ok";
      } else if (serverResult && serverResult.error) {
        // Mapear HTTP -> estado
        const map = { 400: "invalid", 410: "expired", 409: "used", 423: "closed" };
        state = map[serverResult.httpStatus] || "invalid";
      }

      // Atualiza UI conforme estado
      if (state === "ok") {
        setStatus("ok", "Convite válido", singleUse ? "Convite de uso único confirmado." : "Convite confirmado.");
        showBlock("terms-block", true);
        showBlock("actions-ok", true);
        $proceed.disabled = !$accept.checked;
      } else if (state === "expired") {
        setStatus("warning", "Convite expirado", "O prazo de utilização deste convite terminou.");
        showBlock("actions-expired", true);
      } else if (state === "used") {
        setStatus("warning", "Convite já utilizado", "Este convite foi utilizado anteriormente.");
        showBlock("actions-used", true);
      } else if (state === "closed") {
        setStatus("warning", "Campanha encerrada", "A campanha não aceita mais novos jogos.");
        showBlock("actions-closed", true);
      } else {
        setStatus("danger", "Convite inválido", "Não foi possível validar este link de acesso.");
        showBlock("actions-error", true);
      }

      // Ações
      $accept?.addEventListener("change", () => {
        $proceed.disabled = !$accept.checked;
      });

      $proceed?.addEventListener("click", () => {
        if (!$accept.checked) return;
        // Redireciona mantendo o token
        const url = new URL(CONFIG.nextRoute, window.location.origin);
        url.searchParams.set("invite", token);
        window.location.href = url.toString();
      });

      $copyLink?.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);
          $copyLink.textContent = "Link copiado!";
          setTimeout(() => ($copyLink.textContent = "Copiar link"), 2000);
        } catch (e) {
          alert("Não foi possível copiar o link.");
        }
      });

      if ($helpLink) {
        $helpLink.href = CONFIG.supportUrl || "#";
      }
    })();
  </script>
</body>
</html>