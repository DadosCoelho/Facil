<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facil — Minhas Apostas</title>
  <meta name="description" content="Visualize e gerencie suas apostas da Lotofácil da Independência na plataforma Facil." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root {
      --bg: #0b0c10;
      --bg-elev: #111217;
      --card: #14161d;
      --card-2: #191c24;
      --text: #e6e8ef;
      --muted: #98a1b3;
      --primary: #6ee7b7;
      --primary-2: #34d399;
      --accent: #60a5fa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --err: #ef4444;
      --chip: #222634;
      --chip-2: #2a2f42;
      --border: #242838;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --focus: 0 0 0 2px rgba(110,231,183,0.2), 0 0 0 6px rgba(110,231,183,0.08);
      --grid-gap: 14px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f7fb;
        --bg-elev: #ffffff;
        --card: #ffffff;
        --card-2: #f8fafc;
        --text: #101828;
        --muted: #4b5563;
        --primary: #10b981;
        --primary-2: #0ea371;
        --accent: #2563eb;
        --ok: #16a34a;
        --warn: #d97706;
        --err: #dc2626;
        --chip: #eef2ff;
        --chip-2: #e2e8f0;
        --border: #e5e7eb;
        --shadow: 0 10px 30px rgba(2,6,23,0.08);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -200px, rgba(96,165,250,0.06), transparent 60%), radial-gradient(1000px 600px at -200px 30%, rgba(110,231,183,0.06), transparent 60%), var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    a { color: inherit; text-decoration: none; }
    .container {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    header.appbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: saturate(140%) blur(10px);
      background: color-mix(in oklab, var(--bg-elev) 80%, transparent);
      border-bottom: 1px solid var(--border);
    }
    .appbar-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .brand-logo {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      display: grid;
      place-items: center;
      color: #0b0c10;
      font-weight: 900;
      box-shadow: 0 8px 18px rgba(52, 211, 153, 0.25);
    }
    nav .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .nav-links a {
      padding: 8px 10px;
      border-radius: 10px;
      color: var(--muted);
      border: 1px solid transparent;
    }
    .nav-links a.active {
      color: var(--text);
      border-color: var(--border);
      background: color-mix(in oklab, var(--card) 88%, transparent);
    }
    .user-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card);
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 12px;
      color: var(--muted);
    }
    main { padding-top: 10px; }
    .hero {
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }
    .card {
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 84%, transparent), color-mix(in oklab, var(--card-2) 92%, transparent));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .card .hd {
      padding: 16px;
      border-bottom: 1px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .card .bd { padding: 16px; }
    .title-xl { font-size: 20px; font-weight: 800; letter-spacing: 0.2px; }
    .muted { color: var(--muted); }
    .toolbar {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px) {
      .toolbar {
        grid-template-columns: 1fr max-content max-content max-content;
        align-items: center;
      }
    }
    .field {
      display: flex;
      gap: 8px;
      align-items: center;
      background: var(--bg-elev);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .field input, .field select {
      border: none;
      outline: none;
      background: transparent;
      color: var(--text);
      width: 100%;
      font-size: 14px;
    }
    .btn {
      appearance: none;
      border: 1px solid var(--border);
      padding: 10px 12px;
      border-radius: 12px;
      background: color-mix(in oklab, var(--card) 88%, transparent);
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      transition: transform .04s ease, background .2s ease, border-color .2s ease;
    }
    .btn:hover { background: color-mix(in oklab, var(--card-2) 92%, transparent); }
    .btn:active { transform: translateY(1px); }
    .btn.primary {
      background: linear-gradient(180deg, var(--primary), var(--primary-2));
      border-color: color-mix(in oklab, var(--primary-2) 70%, #000);
      color: #04120c;
    }
    .btn.ghost { background: transparent; }
    .btn.icon { display: inline-flex; align-items: center; gap: 8px; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }
    .hint { font-size: 13px; color: var(--muted); }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--chip);
      color: var(--text);
      font-weight: 700;
      font-size: 12px;
    }
    .status.ok { background: color-mix(in oklab, var(--ok) 18%, var(--chip)); border-color: color-mix(in oklab, var(--ok) 30%, var(--border)); }
    .status.warn { background: color-mix(in oklab, var(--warn) 16%, var(--chip)); border-color: color-mix(in oklab, var(--warn) 30%, var(--border)); }
    .status.err { background: color-mix(in oklab, var(--err) 16%, var(--chip)); border-color: color-mix(in oklab, var(--err) 30%, var(--border)); }
    .bets-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--grid-gap);
    }
    @media (min-width: 720px) {
      .bets-grid { grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1020px) {
      .bets-grid { grid-template-columns: 1fr 1fr 1fr; }
    }
    .bet-card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 84%, transparent), color-mix(in oklab, var(--card-2) 92%, transparent));
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 220px;
    }
    .bet-card .top {
      padding: 12px 14px;
      border-bottom: 1px dashed var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }
    .ticket {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: var(--chip);
      border: 1px dashed var(--border);
      padding: 4px 8px;
      border-radius: 8px;
      color: var(--muted);
    }
    .bet-card .mid {
      padding: 12px 14px;
      display: grid;
      gap: 10px;
    }
    .numbers {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .num {
      width: 36px; height: 36px;
      display: grid; place-items: center;
      border-radius: 10px;
      background: var(--chip);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 800;
      font-feature-settings: "tnum";
    }
    .meta {
      display: grid;
      gap: 4px;
      color: var(--muted);
      font-size: 13px;
    }
    .bet-card .bot {
      padding: 10px 14px 14px 14px;
      display: flex; gap: 8px; flex-wrap: wrap;
      border-top: 1px dashed var(--border);
    }
    .badge {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 6px 10px; border-radius: 999px;
      background: var(--chip-2); border: 1px solid var(--border);
      color: var(--text); font-weight: 700; font-size: 12px;
    }
    .empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty .big {
      font-weight: 900;
      font-size: 20px;
      color: var(--text);
      margin-bottom: 8px;
    }
    .pager {
      margin-top: 16px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .alert {
      border: 1px solid var(--border);
      background: color-mix(in oklab, var(--warn) 8%, var(--card));
      border-radius: var(--radius);
      padding: 12px 14px;
      display: grid; gap: 6px;
    }
    .alert.err { background: color-mix(in oklab, var(--err) 12%, var(--card)); }
    .alert .title { font-weight: 800; }
    .sr-only {
      position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px;
      overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
    }
    /* loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,0.06), rgba(255,255,255,0));
      background-size: 200% 100%;
      animation: sh 1.2s ease-in-out infinite;
    }
    @keyframes sh { 0%{background-position: 200% 0} 100%{background-position: -200% 0} }
    .bet-skel {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      min-height: 220px;
      padding: 12px;
      display: grid;
      gap: 12px;
    }
    .actions-top {
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .tag {
      padding: 6px 10px; border: 1px dashed var(--border);
      border-radius: 999px; color: var(--muted); font-weight: 700; font-size: 12px;
    }
  </style>
</head>
<body>
  <header class="appbar" role="banner">
    <div class="container appbar-inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true">F</div>
        <div>
          <div style="font-size:16px;">Facil</div>
          <div class="hint" style="margin-top:-2px;">Loterias — Lotofácil da Independência</div>
        </div>
      </div>
      <nav aria-label="Navegação principal">
        <div class="nav-links">
          <a href="/" data-route="invite">Convite</a>
          <a href="/create" data-route="create">Criar Aposta</a>
          <a href="/summary" data-route="summary">Resumo</a>
          <a href="/receipt" data-route="receipt">Recibo</a>
          <a href="/my-bets" class="active" aria-current="page" data-route="mybets">Minhas Apostas</a>
        </div>
      </nav>
      <div class="user-chip" id="userChip" title="Convite">
        <span id="userName">Convidado</span>
        <span class="tag" id="inviteTag">invite=—</span>
      </div>
    </div>
  </header>

  <main role="main">
    <div class="container hero">
      <section class="card" aria-labelledby="title">
        <div class="hd">
          <div>
            <div id="title" class="title-xl">Minhas Apostas</div>
            <div class="hint">Veja, filtre e exporte suas apostas. Utilize as ações para copiar protocolo, ir ao recibo, exportar CSV e criar novas apostas.</div>
          </div>
          <div class="actions-top">
            <button id="btnNew" class="btn icon primary" type="button">➕ Nova aposta</button>
            <button id="btnRefresh" class="btn icon" type="button" title="Atualizar">⟳ Atualizar</button>
            <button id="btnExportCsv" class="btn icon" type="button" title="Exportar CSV">⬇️ Exportar</button>
          </div>
        </div>
        <div class="bd">
          <div id="inviteAlert" class="alert" style="display:none;">
            <div class="title">Convite inválido ou ausente</div>
            <div>Abra o link de convite enviado pelo administrador ou inclua ?invite=SEU_TOKEN na URL.</div>
          </div>

          <div class="toolbar" style="margin-bottom: 12px;">
            <div class="field" role="search">
              <span class="muted" aria-hidden="true">🔎</span>
              <input id="q" type="search" placeholder="Buscar por protocolo (ticket)..." inputmode="search" autocomplete="off" />
            </div>
            <div class="field">
              <label for="status" class="sr-only">Status</label>
              <select id="status">
                <option value="">Todos os status</option>
                <option value="pending">Pendente</option>
                <option value="sent">Enviado</option>
                <option value="confirmed">Confirmado</option>
                <option value="cancelled">Cancelado</option>
              </select>
            </div>
            <div class="field">
              <label for="sort" class="sr-only">Ordenação</label>
              <select id="sort">
                <option value="createdAt_desc">Mais recentes</option>
                <option value="createdAt_asc">Mais antigas</option>
                <option value="value_desc">Maior valor</option>
                <option value="value_asc">Menor valor</option>
              </select>
            </div>
            <div class="field">
              <label for="pageSize" class="sr-only">Itens por página</label>
              <select id="pageSize">
                <option value="9">9 por página</option>
                <option value="12" selected>12 por página</option>
                <option value="18">18 por página</option>
                <option value="24">24 por página</option>
              </select>
            </div>
          </div>

          <div id="list" class="bets-grid" aria-live="polite" aria-busy="true"></div>

          <div id="empty" class="empty" style="display:none;">
            <div class="big">Você ainda não possui apostas</div>
            <div>Crie sua primeira aposta clicando no botão abaixo.</div>
            <div style="margin-top: 12px;">
              <button id="btnNewEmpty" class="btn primary" type="button">Criar aposta</button>
            </div>
          </div>

          <div class="pager">
            <button id="btnPrev" class="btn" type="button" disabled>Anterior</button>
            <span class="hint" id="pageInfo">Página 1</span>
            <button id="btnNext" class="btn" type="button" disabled>Próxima</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    (function () {
      "use strict";

      const CONFIG = {
        pricePerQuota: 5.00,
        routes: {
          root: "/",
          create: "/create",
          summary: "/summary",
          receipt: "/receipt",
          mybets: "/my-bets"
        },
        api: {
          inviteValidate: "/api/invite/validate",
          betsList: "/api/bets",
          betReceipt: "/api/bets/receipt"
        }
      };

      // Utils
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const fmtBRL = (n) => new Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(n);
      const fmtDate = (iso) => {
        try {
          const d = new Date(iso);
          return new Intl.DateTimeFormat("pt-BR", {
            dateStyle: "medium",
            timeStyle: "short"
          }).format(d);
        } catch {
          return iso;
        }
      };

      const STATUS_META = {
        pending: { label: "Pendente", cls: "warn", sort: 2 },
        sent: { label: "Enviado", cls: "", sort: 1 },
        confirmed: { label: "Confirmado", cls: "ok", sort: 0 },
        cancelled: { label: "Cancelado", cls: "err", sort: 3 }
      };

      let state = {
        invite: null,
        profile: null,
        items: [],
        page: 1,
        pageSize: 12,
        total: 0,
        q: "",
        status: "",
        sort: "createdAt_desc",
        loading: false
      };

      function setBusy(flag) {
        const list = $("#list");
        if (!list) return;
        list.setAttribute("aria-busy", flag ? "true" : "false");
      }

      function readParams() {
        const url = new URL(window.location.href);
        state.invite = url.searchParams.get("invite") || null;
        state.page = parseInt(url.searchParams.get("page") || "1", 10);
        state.pageSize = parseInt(url.searchParams.get("pageSize") || $("#pageSize")?.value || "12", 10);
        state.q = url.searchParams.get("q") || "";
        state.status = url.searchParams.get("status") || "";
        state.sort = url.searchParams.get("sort") || "createdAt_desc";
      }

      function writeParams(push = false) {
        const url = new URL(window.location.href);
        if (state.invite) url.searchParams.set("invite", state.invite);
        url.searchParams.set("page", String(state.page));
        url.searchParams.set("pageSize", String(state.pageSize));
        if (state.q) url.searchParams.set("q", state.q); else url.searchParams.delete("q");
        if (state.status) url.searchParams.set("status", state.status); else url.searchParams.delete("status");
        if (state.sort) url.searchParams.set("sort", state.sort);
        if (push) history.pushState({}, "", url.toString()); else history.replaceState({}, "", url.toString());
      }

      function setUserChip(invite, profile) {
        $("#inviteTag").textContent = invite ? "invite=" + invite.slice(0, 6) + "…" : "invite=—";
        $("#userName").textContent = profile?.name || "Convidado";
      }

      function setNavLinks() {
        $$(".nav-links a").forEach(a => {
          const r = a.getAttribute("data-route");
          let href = "#";
          if (r === "invite") href = CONFIG.routes.root;
          if (r === "create") href = CONFIG.routes.create;
          if (r === "summary") href = CONFIG.routes.summary;
          if (r === "receipt") href = CONFIG.routes.receipt;
          if (r === "mybets") href = CONFIG.routes.mybets;
          if (state.invite) {
            const u = new URL(window.location.origin + href);
            u.searchParams.set("invite", state.invite);
            a.href = u.toString();
          } else {
            a.href = href;
          }
        });
      }

      function statusPill(status) {
        const m = STATUS_META[status] || { label: status, cls: "" };
        return `<span class="status ${m.cls}">${m.label}</span>`;
      }

      function makeNumbers(nums) {
        if (!Array.isArray(nums)) return "";
        return nums.slice().sort((a,b) => a-b).map(n => `<span class="num">${String(n).padStart(2, "0")}</span>`).join("");
      }

      function cardTemplate(item) {
        const total = (item.quotes || item.quotas || 1) * (item.pricePerQuota || CONFIG.pricePerQuota);
        const value = item.totalValue != null ? item.totalValue : total;
        const status = item.status || "pending";
        const m = STATUS_META[status] || {};
        const label = m.label || status;
        const ticket = item.ticket || item.id || "(sem ticket)";
        const created = item.createdAt ? fmtDate(item.createdAt) : "—";
        return `
          <article class="bet-card" data-ticket="${ticket}">
            <div class="top">
              <div class="ticket">#${ticket}</div>
              ${statusPill(status)}
            </div>
            <div class="mid">
              <div class="numbers" aria-label="Números">${makeNumbers(item.numbers || item.dezenas || [])}</div>
              <div class="meta">
                <div><strong>${(item.quotas ?? item.quotes ?? 1)}</strong> cotas · <strong>${fmtBRL(value)}</strong></div>
                <div class="muted">Criado em ${created}</div>
              </div>
            </div>
            <div class="bot">
              <button class="btn icon" data-action="copy" aria-label="Copiar protocolo">📋 Copiar</button>
              <button class="btn icon" data-action="receipt" aria-label="Ver recibo">🧾 Recibo</button>
              <span class="badge" title="Campanha">🎯 Independência</span>
              <span class="badge" title="Status">${label}</span>
            </div>
          </article>
        `;
      }

      function skeletonTemplate() {
        let html = "";
        for (let i = 0; i < 6; i++) {
          html += `
            <div class="bet-skel">
              <div class="skeleton" style="height:18px; width: 40%; border-radius:8px;"></div>
              <div class="skeleton" style="height:120px; border-radius:12px;"></div>
              <div class="skeleton" style="height:16px; width: 60%; border-radius:8px;"></div>
            </div>
          `;
        }
        return html;
      }

      function render() {
        $("#q").value = state.q;
        $("#status").value = state.status;
        $("#sort").value = state.sort;
        $("#pageSize").value = String(state.pageSize);

        const list = $("#list");
        const empty = $("#empty");
        const pageInfo = $("#pageInfo");
        const btnPrev = $("#btnPrev");
        const btnNext = $("#btnNext");

        list.innerHTML = "";
        if (state.loading) {
          list.innerHTML = skeletonTemplate();
          setBusy(true);
          empty.style.display = "none";
          pageInfo.textContent = `Carregando…`;
          btnPrev.disabled = true;
          btnNext.disabled = true;
          return;
        }

        setBusy(false);

        const offset = (state.page - 1) * state.pageSize;
        const pageItems = state.items.slice(offset, offset + state.pageSize);
        if (pageItems.length === 0) {
          empty.style.display = "block";
          pageInfo.textContent = `Página ${state.page}`;
          btnPrev.disabled = state.page <= 1;
          btnNext.disabled = true;
          return;
        }

        empty.style.display = "none";
        list.innerHTML = pageItems.map(cardTemplate).join("");

        const totalPages = Math.max(1, Math.ceil(state.items.length / state.pageSize));
        pageInfo.textContent = `Página ${state.page} de ${totalPages}`;
        btnPrev.disabled = state.page <= 1;
        btnNext.disabled = state.page >= totalPages;

        bindCardActions();
      }

      function applyFiltersAndSort(items) {
        let arr = items.slice();

        if (state.q) {
          const q = state.q.trim().toLowerCase();
          arr = arr.filter(i => String(i.ticket || i.id || "").toLowerCase().includes(q));
        }
        if (state.status) {
          arr = arr.filter(i => (i.status || "pending") === state.status);
        }

        const byCreated = (a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0);
        const byValue = (a, b) => {
          const va = a.totalValue != null ? a.totalValue : (a.quotas || a.quotes || 1) * (a.pricePerQuota || CONFIG.pricePerQuota);
          const vb = b.totalValue != null ? b.totalValue : (b.quotas || b.quotes || 1) * (b.pricePerQuota || CONFIG.pricePerQuota);
          return va - vb;
        };

        switch (state.sort) {
          case "createdAt_desc": arr.sort((a,b) => byCreated(a,b) * -1); break;
          case "createdAt_asc": arr.sort(byCreated); break;
          case "value_desc": arr.sort((a,b) => byValue(a,b) * -1); break;
          case "value_asc": arr.sort(byValue); break;
        }

        return arr;
      }

      function cacheKey() {
        return `facil_bets_${state.invite || "anon"}`;
      }

      async function validateInviteOrShow() {
        if (!state.invite) {
          $("#inviteAlert").style.display = "block";
          return false;
        }
        try {
          const res = await fetch(`${CONFIG.api.inviteValidate}?invite=${encodeURIComponent(state.invite)}`, { cache: "no-store" });
          if (!res.ok) throw new Error("invite invalid");
          const data = await res.json();
          state.profile = data?.profile || null;
          setUserChip(state.invite, state.profile);
          $("#inviteAlert").style.display = "none";
          return true;
        } catch {
          $("#inviteAlert").classList.add("err");
          $("#inviteAlert").style.display = "block";
          return false;
        }
      }

      async function fetchBets() {
        state.loading = true;
        render();

        // Try cache first
        let cached = [];
        try {
          const raw = localStorage.getItem(cacheKey());
          if (raw) cached = JSON.parse(raw);
        } catch {}
        if (Array.isArray(cached) && cached.length > 0) {
          state.items = applyFiltersAndSort(cached);
          state.total = cached.length;
          state.loading = false;
          render();
        }

        try {
          const url = new URL(window.location.origin + CONFIG.api.betsList);
          if (state.invite) url.searchParams.set("invite", state.invite);
          url.searchParams.set("limit", "200"); // client-side paginação
          const res = await fetch(url.toString(), { cache: "no-store" });
          if (!res.ok) throw new Error("Falha ao carregar apostas");
          const data = await res.json();
          const items = Array.isArray(data?.items) ? data.items : Array.isArray(data) ? data : [];
          try { localStorage.setItem(cacheKey(), JSON.stringify(items)); } catch {}
          state.items = applyFiltersAndSort(items);
          state.total = items.length;
        } catch (e) {
          console.error(e);
        } finally {
          state.loading = false;
          render();
        }
      }

      function bindToolbar() {
        $("#q").addEventListener("input", (e) => {
          state.q = e.target.value;
          state.page = 1;
          writeParams();
          // filtro imediato no que já existe
          let items = [];
          try {
            const raw = localStorage.getItem(cacheKey());
            if (raw) items = JSON.parse(raw);
          } catch {}
          state.items = applyFiltersAndSort(items);
          render();
        });

        $("#status").addEventListener("change", (e) => {
          state.status = e.target.value;
          state.page = 1;
          writeParams();
          let items = [];
          try {
            const raw = localStorage.getItem(cacheKey());
            if (raw) items = JSON.parse(raw);
          } catch {}
          state.items = applyFiltersAndSort(items);
          render();
        });

        $("#sort").addEventListener("change", (e) => {
          state.sort = e.target.value;
          writeParams();
          let items = [];
          try {
            const raw = localStorage.getItem(cacheKey());
            if (raw) items = JSON.parse(raw);
          } catch {}
          state.items = applyFiltersAndSort(items);
          render();
        });

        $("#pageSize").addEventListener("change", (e) => {
          state.pageSize = parseInt(e.target.value, 10);
          state.page = 1;
          writeParams();
          render();
        });

        $("#btnPrev").addEventListener("click", () => {
          if (state.page > 1) {
            state.page -= 1;
            writeParams(true);
            render();
          }
        });
        $("#btnNext").addEventListener("click", () => {
          const totalPages = Math.max(1, Math.ceil(state.items.length / state.pageSize));
          if (state.page < totalPages) {
            state.page += 1;
            writeParams(true);
            render();
          }
        });

        const goCreate = () => {
          const u = new URL(window.location.origin + (CONFIG.routes.create || "/create"));
          if (state.invite) u.searchParams.set("invite", state.invite);
          window.location.href = u.toString();
        };
        $("#btnNew").addEventListener("click", goCreate);
        $("#btnNewEmpty").addEventListener("click", goCreate);

        $("#btnRefresh").addEventListener("click", () => fetchBets());

        $("#btnExportCsv").addEventListener("click", exportCSV);
      }

      function bindCardActions() {
        $$("#list .bet-card .bot .btn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const action = e.currentTarget.getAttribute("data-action");
            const card = e.currentTarget.closest(".bet-card");
            const ticket = card?.getAttribute("data-ticket");
            if (!ticket) return;

            if (action === "copy") {
              try {
                await navigator.clipboard.writeText(ticket);
                e.currentTarget.textContent = "✅ Copiado";
                setTimeout(() => e.currentTarget.textContent = "📋 Copiar", 1200);
              } catch {
                alert("Não foi possível copiar o protocolo.");
              }
            }
            if (action === "receipt") {
              const u = new URL(window.location.origin + (CONFIG.routes.receipt || "/receipt"));
              u.searchParams.set("ticket", ticket);
              if (state.invite) u.searchParams.set("invite", state.invite);
              window.location.href = u.toString();
            }
          });
        });
      }

      function exportCSV() {
        const headers = ["ticket", "createdAt", "status", "cotas", "valorTotal", "numeros"];
        const rows = state.items.map(i => {
          const cotas = i.quotas ?? i.quotes ?? 1;
          const valor = i.totalValue != null ? i.totalValue : cotas * (i.pricePerQuota || CONFIG.pricePerQuota);
          const numeros = (i.numbers || i.dezenas || []).slice().sort((a,b)=>a-b).join("-");
          return [
            (i.ticket || i.id || ""),
            (i.createdAt || ""),
            (i.status || "pending"),
            String(cotas),
            String(valor),
            `"${numeros}"`
          ].join(",");
        });
        const csv = [headers.join(","), ...rows].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const dt = new Date();
        const stamp = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}--${String(dt.getHours()).padStart(2,"0")}${String(dt.getMinutes()).padStart(2,"0")}`;
        a.download = `facil-minhas-apostas-${stamp}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      async function init() {
        readParams();
        setNavLinks();
        $("#pageSize").value = String(state.pageSize);
        $("#q").value = state.q;
        $("#status").value = state.status;
        $("#sort").value = state.sort;

        if (!state.invite) {
          $("#inviteAlert").style.display = "block";
          setUserChip(null, null);
          $("#list").innerHTML = "";
          setBusy(false);
          bindToolbar();
          return;
        }

        setUserChip(state.invite, null);
        bindToolbar();

        const okInvite = await validateInviteOrShow();
        if (!okInvite) return;

        await fetchBets();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>