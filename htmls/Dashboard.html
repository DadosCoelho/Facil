<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facil — Dashboard (Painel)</title>
  <meta name="description" content="Painel administrativo da Facil: visão geral de apostas, volume, participantes e conversões. Exportações, filtros e gerenciamento." />
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0c10;
      --bg-elev:#111217;
      --card:#14161d;
      --card-2:#191c24;
      --text:#e6e8ef;
      --muted:#a9afc3;
      --primary:#6ee7b7;
      --primary-600:#34d399;
      --primary-700:#10b981;
      --accent:#7c8ae6;
      --accent-700:#5b6bd6;
      --border:#262a37;
      --ok:#22c55e;
      --warn:#f59e0b;
      --error:#ef4444;
      --ring: 0 0 0 3px rgba(110,231,183,.25);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --radius: 12px;
      --radius-sm: 10px;
      --radius-xs: 8px;
      --container: 1200px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:400 16px/1.5 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"}
    img{max-width:100%;display:block}
    a{color:inherit;text-decoration:none}
    button{font:inherit}
    .sr-only{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .container{max-width:var(--container);margin:0 auto;padding:24px}
    header .bar{
      display:flex;align-items:center;justify-content:space-between;
      padding:16px 24px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--bg-elev),transparent);
      position:sticky;top:0;backdrop-filter:saturate(140%) blur(10px);z-index:30;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{
      width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#1f2937 0%, #0ea5e9 60%, #22d3ee 100%);
      display:grid;place-items:center;box-shadow:0 6px 18px rgba(34,211,238,.25);
    }
    .brand .logo svg{transform:translateY(1px)}
    .brand h1{font-size:18px;margin:0;letter-spacing:.3px}
    .brand .tag{font-size:12px;color:var(--muted);padding:2px 8px;border:1px solid var(--border);border-radius:999px}
    .actions{display:flex;gap:10px;align-items:center}
    .search{
      display:none;
      align-items:center;gap:8px;
      background:var(--card);border:1px solid var(--border);border-radius:999px;padding:8px 12px;min-width:260px;
    }
    .search input{background:transparent;border:0;outline:0;color:var(--text);width:100%}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{background:linear-gradient(180deg,var(--primary-700),var(--primary-600));border-color:transparent;color:#052014}
    .btn-ghost{background:transparent}
    .btn-danger{background:linear-gradient(180deg,#b91c1c,#ef4444);border-color:transparent;color:#fff}
    .user{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
    .user .avatar{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#111827,#374151)}
    .user small{display:block;color:var(--muted);line-height:1.2}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:18px 0 10px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card);border-radius:999px;padding:8px 12px}
    .pill select,.pill input{background:transparent;border:0;color:var(--text);outline:0}
    .grid{display:grid;gap:16px}
    .kpis{grid-template-columns:repeat(4,1fr)}
    .cards-2{grid-template-columns:2fr 1.5fr}
    .cards-3{grid-template-columns:2fr 1.25fr 1.25fr}
    .card{background:linear-gradient(180deg,var(--card),var(--card-2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .head{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border)}
    .card .body{padding:16px}
    .kpi{display:flex;align-items:center;gap:14px;padding:16px}
    .kpi .icon{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;background:#0f172a;border:1px solid var(--border)}
    .kpi .v{font-weight:700;font-size:20px}
    .kpi .d{color:var(--muted);font-size:13px}
    .kpi .delta{font-size:12px;color:var(--ok)}
    .kpi .delta.down{color:var(--error)}
    canvas{width:100%;height:220px;background:radial-gradient(1200px 220px at 0% 0%, rgba(86,207,225,.05), transparent)}
    .table{width:100%;border-collapse:separate;border-spacing:0 10px}
    .table th{color:var(--muted);text-align:left;font-weight:600;font-size:13px;padding:0 12px 6px}
    .table tr{background:var(--card);border:1px solid var(--border)}
    .table td{padding:12px}
    .badge{font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#0c1222}
    .badge.ok{background:rgba(34,197,94,.1);color:#34d399;border-color:rgba(34,197,94,.2)}
    .badge.warn{background:rgba(245,158,11,.08);color:#fbbf24;border-color:rgba(245,158,11,.2)}
    .badge.err{background:rgba(239,68,68,.08);color:#fca5a5;border-color:rgba(239,68,68,.2)}
    .list{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
    .muted{color:var(--muted)}
    .foot{display:flex;justify-content:space-between;gap:12px;align-items:center;margin-top:12px}
    .toast{position:fixed;right:16px;bottom:16px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;box-shadow:var(--shadow);display:none}
    .toast.show{display:block;animation:fade .2s ease}
    @keyframes fade{from{opacity:.6;transform:translateY(6px)}to{opacity:1;transform:none}}
    .skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg, #14161d 25%, #191c24 37%, #14161d 63%);background-size:400% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:-100% 0}}
    .hidden{display:none !important}
    .divider{height:1px;background:var(--border);margin:10px 0}
    .link{color:var(--accent)}
    .status-dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}
    .dot-ok{background:#22c55e}.dot-pend{background:#f59e0b}.dot-canc{background:#ef4444}
    .empty{border:1px dashed var(--border);border-radius:12px;padding:16px;color:var(--muted);text-align:center}
    /* Responsive */
    @media (max-width: 1080px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      .cards-2,.cards-3{grid-template-columns:1fr}
      .search{display:none}
    }
    @media (min-width: 1081px){
      .search{display:flex}
    }
    @media (max-width: 640px){
      header .bar{padding:12px}
      .container{padding:16px}
      .btn{padding:8px 12px}
      .kpi{padding:12px}
      canvas{height:180px}
    }
  </style>
</head>
<body>
  <a href="#conteudo" class="sr-only">Pular para o conteúdo</a>

  <header>
    <div class="bar" role="navigation" aria-label="Barra superior">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.9L18.18 22 12 18.77 5.82 22 7 14.17l-5-4.9 6.91-1.01L12 2z" fill="white" opacity=".9"/>
          </svg>
        </div>
        <div>
          <h1>Facil <span class="tag">Admin</span></h1>
          <small class="muted">Dashboard (Painel)</small>
        </div>
      </div>

      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M11 19a8 8 0 1 1 0-16 8 8 0 0 1 0 16Z" stroke="currentColor" stroke-width="1.6"/></svg>
        <input id="q" type="search" placeholder="Buscar aposta, e-mail, protocolo..." autocomplete="off" />
        <button class="btn btn-ghost" id="btnClear" title="Limpar busca" aria-label="Limpar busca">Limpar</button>
      </div>

      <div class="actions">
        <button class="btn" id="btnExport" title="Exportar CSV" aria-label="Exportar CSV">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v12m0 0 4-4m-4 4-4-4M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Exportar
        </button>
        <button class="btn" id="btnRefresh" title="Atualizar dados" aria-label="Atualizar dados">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 12a9 9 0 0 1-15.54 6M3 12A9 9 0 0 1 18.54 6M21 3v6h-6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Atualizar
        </button>
        <div class="user" id="userMenu" role="button" aria-haspopup="menu" aria-expanded="false" title="Conta">
          <div class="avatar" aria-hidden="true"></div>
          <div>
            <div id="userName">Administrador</div>
            <small id="userMail" class="muted">admin@facil.app</small>
          </div>
        </div>
        <button class="btn btn-ghost" id="btnLogout" title="Sair" aria-label="Sair">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Sair
        </button>
      </div>
    </div>
  </header>

  <main id="conteudo" class="container">
    <!-- Toolbar / Filtros -->
    <div class="toolbar" role="region" aria-label="Filtros do painel">
      <div class="pill">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M8 7V3m8 4V3M3 11h18M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <select id="period">
          <option value="7">Últimos 7 dias</option>
          <option value="30" selected>Últimos 30 dias</option>
          <option value="90">Últimos 90 dias</option>
          <option value="custom">Personalizado</option>
        </select>
        <input type="date" id="dtStart" class="hidden" aria-label="Data inicial" />
        <span id="toLabel" class="hidden muted">até</span>
        <input type="date" id="dtEnd" class="hidden" aria-label="Data final" />
      </div>

      <div class="pill">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <select id="status">
          <option value="">Todos os status</option>
          <option value="confirmed">Confirmadas</option>
          <option value="pending">Pendentes</option>
          <option value="canceled">Canceladas</option>
        </select>
      </div>

      <div class="pill">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v18M3 12h18" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        <select id="grouping" title="Agrupar séries">
          <option value="day" selected>Diário</option>
          <option value="week">Semanal</option>
          <option value="month">Mensal</option>
        </select>
      </div>

      <div class="pill">
        <label for="minValue" class="muted">Min R$</label>
        <input type="number" id="minValue" inputmode="decimal" placeholder="0,00" style="width:100px" />
      </div>

      <button class="btn" id="btnApply">Aplicar</button>
      <button class="btn btn-ghost" id="btnReset">Redefinir</button>
    </div>

    <!-- KPIs -->
    <section class="grid kpis" aria-label="Indicadores">
      <div class="card">
        <div class="kpi">
          <div class="icon" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 21V10m8 11V3m8 18v-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          </div>
          <div>
            <div class="d">Apostas</div>
            <div class="v" id="kpiBets" aria-live="polite">—</div>
            <div class="delta" id="kpiBetsDelta">—</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div class="icon" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10l9-6 9 6-9 6-9-6Zm9 6v6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          </div>
          <div>
            <div class="d">Volume (R$)</div>
            <div class="v" id="kpiVolume">—</div>
            <div class="delta" id="kpiVolumeDelta">—</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div class="icon" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M16 11a4 4 0 1 0-8 0m12 8a7 7 0 1 0-14 0" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          </div>
          <div>
            <div class="d">Participantes</div>
            <div class="v" id="kpiUsers">—</div>
            <div class="delta" id="kpiUsersDelta">—</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div class="icon" aria-hidden="true">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h6l3-9 3 18 3-9h3" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          </div>
          <div>
            <div class="d">Conversão</div>
            <div class="v" id="kpiConv">—</div>
            <div class="delta" id="kpiConvDelta">—</div>
          </div>
        </div>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Charts + Side Cards -->
    <section class="grid cards-3" aria-label="Séries e destaques">
      <div class="card">
        <div class="head">
          <div>
            <strong>Apostas por período</strong>
            <div class="muted" style="font-size:12px">Quantidade agrupada por <span id="labelGrouping">dia</span></div>
          </div>
          <button class="btn btn-ghost" id="btnBetsCSV">CSV</button>
        </div>
        <div class="body">
          <canvas id="chartBets" width="800" height="260" aria-label="Linha do tempo de apostas"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <strong>Volume por período (R$)</strong>
            <div class="muted" style="font-size:12px">Total financeiro</div>
          </div>
          <button class="btn btn-ghost" id="btnVolCSV">CSV</button>
        </div>
        <div class="body">
          <canvas id="chartVol" width="800" height="260" aria-label="Linha do tempo de volume"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="head">
          <div>
            <strong>Próximo Sorteio</strong>
            <div class="muted" style="font-size:12px">Contagem regressiva</div>
          </div>
          <a class="btn btn-ghost" id="btnRules" href="#"  rel="noopener">Regras</a>
        </div>
        <div class="body">
          <div id="countdown" class="list">
            <div class="row">
              <div><span class="muted">Data</span></div>
              <div id="drawDate">—</div>
            </div>
            <div class="row">
              <div><span class="muted">Tempo restante</span></div>
              <div id="drawTimer">—</div>
            </div>
            <div class="row">
              <div><span class="muted">Apostas ativas</span></div>
              <div id="drawActive">—</div>
            </div>
            <div class="foot">
              <button class="btn btn-primary" id="btnCloseDraw">Encerrar recebimento</button>
              <button class="btn" id="btnBroadcast">Avisar participantes</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Tabela de apostas recentes -->
    <section class="card" aria-label="Apostas recentes">
      <div class="head">
        <div>
          <strong>Apostas recentes</strong>
          <div class="muted" style="font-size:12px">Últimas movimentações</div>
        </div>
        <div>
          <button class="btn" id="btnMore">Ver todas</button>
        </div>
      </div>
      <div class="body">
        <div id="emptyRecent" class="empty hidden">Nenhuma aposta encontrada para os filtros atuais.</div>
        <table class="table" aria-describedby="tblHelp">
          <thead>
            <tr>
              <th>Data/Hora</th>
              <th>Protocolo</th>
              <th>Participante</th>
              <th>Cotas</th>
              <th>Valor</th>
              <th>Status</th>
              <th style="text-align:right">Ações</th>
            </tr>
          </thead>
          <tbody id="recentBody"></tbody>
        </table>
        <div id="tblHelp" class="sr-only">Tabela de apostas recentes com ações de visualizar, abrir recibo e cancelar.</div>
      </div>
    </section>

    <div class="divider"></div>

    <!-- Top participantes e convites -->
    <section class="grid cards-2" aria-label="Participantes e Convites">
      <div class="card">
        <div class="head">
          <strong>Top participantes</strong>
          <button class="btn btn-ghost" id="btnTopCSV">CSV</button>
        </div>
        <div class="body">
          <div id="topList" class="list"></div>
        </div>
      </div>
      <div class="card">
        <div class="head">
          <strong>Convites</strong>
          <button class="btn" id="btnNewInvite">Criar convite</button>
        </div>
        <div class="body">
          <div id="invitesList" class="list"></div>
          <div class="foot">
            <button class="btn btn-ghost" id="btnInvCSV">Exportar</button>
            <span class="muted">Gerencie chaves e expirados</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Modal Cancelamento -->
  <template id="modalCancelTpl">
    <div id="modalCancel" style="position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);z-index:50">
      <div class="card" style="width:min(520px, 96vw)">
        <div class="head"><strong>Cancelar aposta</strong></div>
        <div class="body">
          <p>Tem certeza que deseja cancelar a aposta <code style="font-family:var(--mono)"><span id="mProto"></span></code>? Essa ação não pode ser desfeita.</p>
          <div class="foot">
            <button class="btn btn-danger" id="mConfirm">Cancelar aposta</button>
            <button class="btn" id="mClose">Fechar</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    (function(){
      "use strict";

      // Configurações e rotas
      const CONFIG = {
        demoMode: true,
        currency: "BRL",
        locale: "pt-BR",
        rulesUrl: "https://loterias.caixa.gov.br/Paginas/Lotofacil.aspx",
        routes: {
          login: "/admin/login",
          dashboard: "/admin",
          invite: "/",
          create: "/create",
          summary: "/summary",
          receipt: "/receipt",
          mybets: "/my-bets"
        },
        api: {
          stats: "/api/admin/stats",
          series: "/api/admin/series",
          bets: "/api/admin/bets",
          top: "/api/admin/top-participants",
          invites: "/api/admin/invites",
          cancel: "/api/admin/bets/cancel",
          broadcast: "/api/admin/broadcast",
          draw: "/api/admin/draw"
        }
      };

      // Utilitários
      const $ = sel => document.querySelector(sel);
      const $$ = sel => document.querySelectorAll(sel);
      const fmtMoney = (v) => (v ?? 0).toLocaleString(CONFIG.locale, {style:"currency", currency:CONFIG.currency});
      const pad2 = (n) => String(n).padStart(2, "0");
      const fmtDateTime = (iso) => {
        try {
          const d = new Date(iso);
          return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        } catch { return "—"; }
      };
      const toast = (msg, type="info") => {
        const el = $("#toast");
        el.textContent = msg;
        el.style.borderColor = type==="error" ? "rgba(239,68,68,.35)" : (type==="ok" ? "rgba(34,197,94,.35)" : "var(--border)");
        el.classList.add("show");
        setTimeout(()=>el.classList.remove("show"), 2800);
      };
      const copy = async (text) => {
        try { await navigator.clipboard.writeText(text); toast("Copiado para a área de transferência", "ok"); }
        catch { toast("Não foi possível copiar", "error"); }
      };
      const downloadCSV = (filename, rows) => {
        const csv = rows.map(r => r.map(v => {
          if (v == null) return "";
          const s = String(v).replace(/"/g,'""');
          return /[",;\n]/.test(s) ? `"${s}"` : s;
        }).join(";")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      };

      // Estado
      const state = {
        admin: null,
        filters: {
          period: 30,
          customStart: null,
          customEnd: null,
          status: "",
          grouping: "day",
          q: "",
          minValue: null
        },
        stats: null,
        series: null,
        recent: [],
        top: [],
        invites: [],
        draw: null
      };

      // Autenticação simples (guarda)
      function loadAdmin(){
        try {
          const raw = localStorage.getItem("facil_admin");
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj?.token) return null;
          return obj;
        } catch { return null; }
      }

      function requireAuth(){
        state.admin = loadAdmin();
        if (!state.admin) {
          toast("Sessão expirada, faça login novamente.", "error");
          setTimeout(()=> window.location.href = CONFIG.routes.login, 600);
          return false;
        }
        // Preenche cabeçalho
        $("#userName").textContent = state.admin?.name || "Administrador";
        $("#userMail").textContent = state.admin?.email || "admin@facil.app";
        return true;
      }

      // Fetch com fallback demo
      async function apiGet(url, params={}){
        if (CONFIG.demoMode) return demoGet(url, params);
        const u = new URL(url, window.location.origin);
        Object.entries(params).forEach(([k,v])=> (v!==null && v!==undefined && v!=="") && u.searchParams.set(k, v));
        const res = await fetch(u.toString(), {headers: {Authorization: `Bearer ${state.admin?.token}`}});
        if (!res.ok) throw new Error(`Erro ${res.status}`);
        return res.json();
      }

      async function apiPost(url, body){
        if (CONFIG.demoMode) return demoPost(url, body);
        const res = await fetch(url, {
          method:"POST",
          headers: {"Content-Type":"application/json", Authorization: `Bearer ${state.admin?.token}`},
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error(`Erro ${res.status}`);
        return res.json();
      }

      // DEMO DATA
      function makeRange(days=30){
        const arr=[]; const now=new Date();
        for(let i=days-1;i>=0;i--){
          const d=new Date(now); d.setDate(d.getDate()-i);
          arr.push(`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`);
        }
        return arr;
      }
      function rand(min,max){return Math.floor(Math.random()*(max-min+1))+min}
      function demoSeries(days=30){
        const dates=makeRange(days);
        let bets=[],vol=[];
        dates.forEach(()=>{ const b=rand(2,28); bets.push(b); vol.push(b*rand(4,12)*5); });
        return { labels: dates, bets, volume: vol };
      }
      function demoRecent(n=10){
        const sts=["confirmed","pending","canceled"];
        const names=["Ana","Bruno","Carla","Diego","Elaine","Fábio","Giovana","Henrique","Isis","João","Katia","Luiz"];
        const items=[];
        for(let i=0;i<n;i++){
          const dt=new Date(); dt.setHours(dt.getHours()-i*3);
          const st=sts[rand(0,2)];
          items.push({
            at: dt.toISOString(),
            protocol: "FAC-"+rand(100000,999999),
            name: `${names[rand(0,names.length-1)]} ${["Silva","Souza","Lima","Costa","Alves"][rand(0,4)]}`,
            email: `user${rand(1,99)}@mail.com`,
            shares: rand(1,5),
            value: rand(30,150),
            status: st
          });
        }
        return items;
      }
      function demoTop(){
        return Array.from({length:6}).map((_,i)=>({
          name: ["Ana","Bruno","Carla","Diego","Elaine","Fábio","Gi"][i] + " " + ["Silva","Moraes","Lima","Costa","Maia","Prado","Souza"][rand(0,6)],
          email:`top${i+1}@mail.com`,
          bets: rand(4,18),
          value: rand(300,2400)
        }));
      }
      function demoInvites(){
        return Array.from({length:5}).map(()=>({
          code: Math.random().toString(36).slice(2,8).toUpperCase(),
          createdAt: new Date(Date.now()-rand(1,240)*3600000).toISOString(),
          uses: rand(0,15),
          active: Math.random()>0.15
        }));
      }
      function demoDraw(){
        const d = new Date();
        d.setDate(d.getDate()+rand(2,12));
        d.setHours(20,0,0,0);
        return { date: d.toISOString(), activeBets: rand(40,180) };
      }
      async function demoGet(url, params){
        if (url.endsWith("/stats")){
          const series = demoSeries(Number(state.filters.period||30));
          const sumBets = series.bets.reduce((a,b)=>a+b,0);
          const sumVol = series.volume.reduce((a,b)=>a+b,0);
          const users = Math.round(sumBets * 0.6);
          return {
            bets: sumBets,
            volume: sumVol,
            users,
            conv: Math.max(5, Math.min(100, Math.round((sumBets/(users||1))*10))),
            deltas: { bets: +8, volume: +12, users: +5, conv: -2 }
          };
        }
        if (url.endsWith("/series")){
          return demoSeries(Number(state.filters.period||30));
        }
        if (url.endsWith("/bets")){
          let arr = demoRecent(12);
          // filtro simples
          if (state.filters.status) arr = arr.filter(r=>r.status===state.filters.status);
          if (state.filters.q) {
            const q = state.filters.q.toLowerCase();
            arr = arr.filter(r =>
              r.protocol.toLowerCase().includes(q) ||
              r.name.toLowerCase().includes(q) ||
              r.email.toLowerCase().includes(q)
            );
          }
          if (state.filters.minValue) arr = arr.filter(r=> r.value >= Number(state.filters.minValue));
          return arr;
        }
        if (url.endsWith("/top-participants")) return demoTop();
        if (url.endsWith("/invites")) return demoInvites();
        if (url.endsWith("/draw")) return demoDraw();
        return {};
      }
      async function demoPost(url, body){
        if (url.endsWith("/bets/cancel")) return { ok:true };
        if (url.endsWith("/broadcast")) return { ok:true, sent: rand(5,50) };
        if (url.endsWith("/draw")) return { ok:true, status:"closed" };
        return { ok:true };
      }

      // Render helpers
      function renderKPIs(){
        const s = state.stats;
        if (!s) return;
        $("#kpiBets").textContent = s.bets?.toLocaleString("pt-BR") ?? "—";
        $("#kpiVolume").textContent = fmtMoney(s.volume);
        $("#kpiUsers").textContent = s.users?.toLocaleString("pt-BR") ?? "—";
        $("#kpiConv").textContent = (s.conv ?? 0) + "%";
        const setDelta = (el, v) => {
          const sign = v > 0 ? "▲" : (v < 0 ? "▼" : "•");
          el.textContent = `${sign} ${Math.abs(v)}% vs período anterior`;
          el.classList.toggle("down", v < 0);
        };
        setDelta($("#kpiBetsDelta"), s.deltas?.bets ?? 0);
        setDelta($("#kpiVolumeDelta"), s.deltas?.volume ?? 0);
        setDelta($("#kpiUsersDelta"), s.deltas?.users ?? 0);
        setDelta($("#kpiConvDelta"), s.deltas?.conv ?? 0);
      }

      function drawLine(canvas, labels, data, color="#6ee7b7"){
        const ctx = canvas.getContext("2d");
        const w = canvas.width, h = canvas.height;
        ctx.clearRect(0,0,w,h);

        const pad = {l:36, r:10, t:14, b:22};
        const min = Math.min(...data);
        const max = Math.max(...data, 1);
        const scaleX = (i) => pad.l + (i * (w - pad.l - pad.r) / Math.max(1, data.length-1));
        const scaleY = (v) => pad.t + (h - pad.t - pad.b) * (1 - (v - min)/(max - min || 1));

        // grid
        const steps = 4;
        ctx.strokeStyle = "rgba(255,255,255,.06)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let i=0;i<=steps;i++){
          const y = pad.t + (h - pad.t - pad.b) * (i/steps);
          ctx.moveTo(pad.l, y);
          ctx.lineTo(w - pad.r, y);
        }
        ctx.stroke();

        // axis labels (Y)
        ctx.fillStyle = "rgba(255,255,255,.55)";
        ctx.font = "12px system-ui";
        for(let i=0;i<=steps;i++){
          const v = min + (max - min) * (1 - i/steps);
          const y = pad.t + (h - pad.t - pad.b) * (i/steps);
          ctx.fillText(Math.round(v).toLocaleString("pt-BR"), 4, y+4);
        }

        // line
        ctx.lineWidth = 2;
        const grad = ctx.createLinearGradient(0,0,0,h);
        grad.addColorStop(0, color);
        grad.addColorStop(1, "rgba(110,231,183,0.15)");
        ctx.strokeStyle = color;
        ctx.beginPath();
        data.forEach((v,i)=>{
          const x = scaleX(i), y = scaleY(v);
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        });
        ctx.stroke();

        // fill
        ctx.lineTo(scaleX(data.length-1), h - pad.b);
        ctx.lineTo(scaleX(0), h - pad.b);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.globalAlpha = .2;
        ctx.fill();
        ctx.globalAlpha = 1;

        // points
        ctx.fillStyle = color;
        data.forEach((v,i)=>{
          const x = scaleX(i), y = scaleY(v);
          ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill();
        });

        // X labels (sparsified)
        const stepX = Math.ceil(data.length / 6);
        labels.forEach((lab,i)=>{
          if(i % stepX !== 0 && i!==data.length-1) return;
          ctx.fillStyle = "rgba(255,255,255,.55)";
          ctx.fillText(lab.slice(5).split("-").reverse().join("/"), scaleX(i)-10, h-4);
        });
      }

      function renderCharts(){
        const s = state.series;
        if (!s) return;
        $("#labelGrouping").textContent = state.filters.grouping === "day" ? "dia" : (state.filters.grouping === "week" ? "semana" : "mês");
        const c1 = $("#chartBets");
        const c2 = $("#chartVol");
        // ensure backing store size matches CSS
        c1.width = c1.clientWidth * (window.devicePixelRatio||1);
        c1.height = 260 * (window.devicePixelRatio||1);
        c2.width = c2.clientWidth * (window.devicePixelRatio||1);
        c2.height = 260 * (window.devicePixelRatio||1);
        drawLine(c1, s.labels, s.bets, "#7dd3fc");
        drawLine(c2, s.labels, s.volume, "#6ee7b7");
      }

      function statusBadge(st){
        if (st==="confirmed") return '<span class="badge ok"><span class="status-dot dot-ok"></span>Confirmada</span>';
        if (st==="pending") return '<span class="badge warn"><span class="status-dot dot-pend"></span>Pendente</span>';
        if (st==="canceled") return '<span class="badge err"><span class="status-dot dot-canc"></span>Cancelada</span>';
        return '<span class="badge">—</span>';
      }

      function renderRecent(){
        const body = $("#recentBody");
        body.innerHTML = "";
        const arr = state.recent || [];
        $("#emptyRecent").classList.toggle("hidden", arr.length>0);
        arr.forEach(item=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${fmtDateTime(item.at)}</td>
            <td><code style="font-family:var(--mono)">${item.protocol}</code></td>
            <td>
              <div>${item.name}</div>
              <small class="muted">${item.email}</small>
            </td>
            <td>${item.shares}</td>
            <td>${fmtMoney(item.value)}</td>
            <td>${statusBadge(item.status)}</td>
            <td style="text-align:right">
              <button class="btn btn-ghost btn-view" data-p="${item.protocol}">Ver</button>
              <button class="btn btn-ghost btn-rec" data-p="${item.protocol}">Recibo</button>
              ${item.status!=="canceled" ? `<button class="btn btn-ghost btn-cancel" data-p="${item.protocol}">Cancelar</button>` : ""}
            </td>
          `;
          body.appendChild(tr);
        });

        // bind actions
        body.querySelectorAll(".btn-view").forEach(btn=>{
          btn.addEventListener("click", (e)=>{
            const proto = e.currentTarget.getAttribute("data-p");
            // rota para visualizar aposta (pode ser mesma do recibo com flag admin)
            window.open(`${CONFIG.routes.receipt}?ticket=${encodeURIComponent(proto)}&admin=1`, "_blank", "noopener");
          });
        });
        body.querySelectorAll(".btn-rec").forEach(btn=>{
          btn.addEventListener("click", (e)=>{
            const proto = e.currentTarget.getAttribute("data-p");
            window.open(`${CONFIG.routes.receipt}?ticket=${encodeURIComponent(proto)}`, "_blank", "noopener");
          });
        });
        body.querySelectorAll(".btn-cancel").forEach(btn=>{
          btn.addEventListener("click", (e)=>{
            const proto = e.currentTarget.getAttribute("data-p");
            openCancelModal(proto);
          });
        });
      }

      function renderTop(){
        const box = $("#topList");
        box.innerHTML = "";
        (state.top||[]).forEach((u,i)=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div style="display:flex;align-items:center;gap:10px">
              <div class="avatar" style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#0ea5e9,#22d3ee)"></div>
              <div>
                <div><strong>${i+1}º</strong> ${u.name}</div>
                <small class="muted">${u.email}</small>
              </div>
            </div>
            <div style="text-align:right">
              <div><strong>${u.bets}</strong> apostas</div>
              <small class="muted">${fmtMoney(u.value)}</small>
            </div>
          `;
          box.appendChild(row);
        });
        if (!box.children.length){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "Nenhum participante no período.";
          box.appendChild(empty);
        }
      }

      function renderInvites(){
        const box = $("#invitesList");
        box.innerHTML = "";
        (state.invites||[]).forEach(inv=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div>
              <div><strong>Convite</strong> <code style="font-family:var(--mono)">${inv.code}</code> ${inv.active?'<span class="badge ok">Ativo</span>':'<span class="badge err">Inativo</span>'}</div>
              <small class="muted">Criado em ${fmtDateTime(inv.createdAt)} • ${inv.uses} uso(s)</small>
            </div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-ghost btn-copy" data-code="${inv.code}">Copiar link</button>
              <button class="btn btn-ghost">${inv.active?'Desativar':'Ativar'}</button>
            </div>
          `;
          box.appendChild(row);
        });
        box.querySelectorAll(".btn-copy").forEach(b=>{
          b.addEventListener("click",()=>{
            const code = b.getAttribute("data-code");
            const link = new URL(CONFIG.routes.invite, window.location.origin);
            link.searchParams.set("invite", code);
            copy(link.toString());
          });
        });
        if (!box.children.length){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "Nenhum convite encontrado.";
          box.appendChild(empty);
        }
      }

      // Modal cancelar
      function openCancelModal(protocol){
        const tpl = $("#modalCancelTpl").content.cloneNode(true);
        const modal = tpl.querySelector("#modalCancel");
        tpl.querySelector("#mProto").textContent = protocol;
        tpl.querySelector("#mClose").addEventListener("click", ()=> modal.remove());
        tpl.querySelector("#mConfirm").addEventListener("click", async ()=>{
          try{
            await apiPost(CONFIG.api.cancel, { protocol });
            toast("Aposta cancelada.", "ok");
            modal.remove();
            await refreshRecent();
          }catch(e){
            toast("Erro ao cancelar aposta.", "error");
          }
        });
        document.body.appendChild(tpl);
      }

      // Próximo sorteio
      let countdownTimer = null;
      function renderDraw(){
        const d = state.draw;
        if (!d) return;
        $("#drawDate").textContent = fmtDateTime(d.date);
        $("#drawActive").textContent = (d.activeBets ?? 0).toLocaleString("pt-BR");
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = setInterval(()=>{
          const now = Date.now();
          const target = new Date(d.date).getTime();
          let diff = Math.max(0, target - now);
          const days = Math.floor(diff / 86400000); diff%=86400000;
          const hours = Math.floor(diff / 3600000); diff%=3600000;
          const mins = Math.floor(diff / 60000); diff%=60000;
          const secs = Math.floor(diff / 1000);
          $("#drawTimer").textContent = `${pad2(days)}d ${pad2(hours)}h ${pad2(mins)}m ${pad2(secs)}s`;
        }, 1000);
        $("#btnRules").href = CONFIG.rulesUrl;
      }

      // Ações
      async function refreshAll(){
        await Promise.all([refreshStats(), refreshSeries(), refreshRecent(), refreshTop(), refreshInvites(), refreshDraw()]);
      }
      async function refreshStats(){
        const p = toQuery();
        state.stats = await apiGet(CONFIG.api.stats, p);
        renderKPIs();
      }
      async function refreshSeries(){
        const p = toQuery();
        state.series = await apiGet(CONFIG.api.series, p);
        renderCharts();
      }
      async function refreshRecent(){
        const p = toQuery();
        state.recent = await apiGet(CONFIG.api.bets, p);
        renderRecent();
      }
      async function refreshTop(){
        const p = toQuery();
        state.top = await apiGet(CONFIG.api.top, p);
        renderTop();
      }
      async function refreshInvites(){
        state.invites = await apiGet(CONFIG.api.invites);
        renderInvites();
      }
      async function refreshDraw(){
        state.draw = await apiGet(CONFIG.api.draw);
        renderDraw();
      }

      function toQuery(){
        const f = state.filters;
        const q = {
          period: f.period,
          status: f.status,
          grouping: f.grouping,
          q: f.q,
          minValue: f.minValue
        };
        if (f.period === "custom"){
          q.start = f.customStart;
          q.end = f.customEnd;
        }
        return q;
      }

      function bindUI(){
        // Busca
        const $q = $("#q");
        const $btnClear = $("#btnClear");
        $q.addEventListener("input", (e)=>{
          state.filters.q = e.target.value;
          debounceRefreshRecent();
        });
        $btnClear.addEventListener("click", ()=>{
          $q.value = "";
          state.filters.q = "";
          debounceRefreshRecent();
        });

        // Filtros
        const $period = $("#period");
        const $dtStart = $("#dtStart");
        const $dtEnd = $("#dtEnd");
        const $toLabel = $("#toLabel");
        $period.addEventListener("change", ()=> {
          state.filters.period = $period.value;
          const custom = $period.value === "custom";
          $dtStart.classList.toggle("hidden", !custom);
          $dtEnd.classList.toggle("hidden", !custom);
          $toLabel.classList.toggle("hidden", !custom);
        });
        $("#status").addEventListener("change", (e)=> state.filters.status = e.target.value);
        $("#grouping").addEventListener("change", (e)=> state.filters.grouping = e.target.value);
        $("#minValue").addEventListener("input", (e)=> state.filters.minValue = e.target.value);

        $("#btnApply").addEventListener("click", async ()=>{
          if (state.filters.period === "custom"){
            state.filters.customStart = $dtStart.value || null;
            state.filters.customEnd = $dtEnd.value || null;
          }
          await refreshAll();
        });

        $("#btnReset").addEventListener("click", async ()=>{
          state.filters = { period: 30, customStart: null, customEnd: null, status:"", grouping:"day", q:"", minValue:null };
          $period.value = "30";
          $("#status").value = "";
          $("#grouping").value = "day";
          $("#minValue").value = "";
          $("#q").value = "";
          $dtStart.classList.add("hidden"); $dtEnd.classList.add("hidden"); $toLabel.classList.add("hidden");
          await refreshAll();
        });

        // Topbar
        $("#btnRefresh").addEventListener("click", refreshAll);
        $("#btnExport").addEventListener("click", ()=> {
          const rows = [["Data/Hora","Protocolo","Nome","Email","Cotas","Valor","Status"]];
          (state.recent||[]).forEach(r=>{
            rows.push([fmtDateTime(r.at), r.protocol, r.name, r.email, r.shares, r.value, r.status]);
          });
          downloadCSV("apostas-recentes.csv", rows);
        });
        $("#btnBetsCSV").addEventListener("click", ()=>{
          const s=state.series; if(!s) return;
          const rows=[["Data","Apostas"]]; s.labels.forEach((l,i)=> rows.push([l, s.bets[i]]));
          downloadCSV("series-apostas.csv", rows);
        });
        $("#btnVolCSV").addEventListener("click", ()=>{
          const s=state.series; if(!s) return;
          const rows=[["Data","Volume"]]; s.labels.forEach((l,i)=> rows.push([l, s.volume[i]]));
          downloadCSV("series-volume.csv", rows);
        });
        $("#btnTopCSV").addEventListener("click", ()=>{
          const rows=[["Nome","Email","Apostas","Valor"]];
          (state.top||[]).forEach(u=> rows.push([u.name,u.email,u.bets,u.value]));
          downloadCSV("top-participantes.csv", rows);
        });
        $("#btnInvCSV").addEventListener("click", ()=>{
          const rows=[["Código","Criado em","Usos","Ativo"]];
          (state.invites||[]).forEach(i=> rows.push([i.code, fmtDateTime(i.createdAt), i.uses, i.active?"Sim":"Não"]));
          downloadCSV("convites.csv", rows);
        });
        $("#btnNewInvite").addEventListener("click", ()=>{
          // Mock criação
          toast("Convite criado", "ok");
          refreshInvites();
        });
        $("#btnBroadcast").addEventListener("click", async ()=>{
          try{
            const res = await apiPost(CONFIG.api.broadcast, { subject:"Lembrete Facil", body:"O sorteio se aproxima. Garanta sua participação!" });
            toast(`Aviso enviado para ${res.sent ?? "vários"} participante(s)`, "ok");
          }catch(e){ toast("Falha no envio de avisos", "error"); }
        });
        $("#btnCloseDraw").addEventListener("click", async ()=>{
          try{ await apiPost(CONFIG.api.draw, { action:"close" }); toast("Recebimento encerrado.", "ok"); }
          catch(e){ toast("Erro ao encerrar recebimento", "error"); }
        });
        $("#btnMore").addEventListener("click", ()=>{
          // Poderia navegar para listagem completa
          toast("Use filtros para detalhar mais resultados.");
        });
        $("#btnLogout").addEventListener("click", ()=>{
          localStorage.removeItem("facil_admin");
          window.location.href = CONFIG.routes.login;
        });

        // Reflow charts no resize
        let resizeTO;
        window.addEventListener("resize", ()=>{
          clearTimeout(resizeTO);
          resizeTO = setTimeout(renderCharts, 120);
        });
      }

      let debounceTO;
      function debounceRefreshRecent(){
        clearTimeout(debounceTO);
        debounceTO = setTimeout(refreshRecent, 300);
      }

      // Init
      async function init(){
        if (!requireAuth()) return;

        bindUI();
        await refreshAll();
      }

      document.addEventListener("DOMContentLoaded", init);
    })();
  </script>
</body>
</html>